const spawn={pickList:["starter","starter"],fullPickList:["slasher","slasher","slasher2","slasher3","hopper","hopper","hopMother","hopMother","hopperBaby","stabber","stabber","stabber","springer","springer","springer","stinger","stinger","stinger","flutter","flutter","striker","striker","shooter","shooter","grenadier","grenadier","pulsar","pulsar","laser","laser","laserLayer","laserLayer","sneaker","launcher","launcherOne","exploder","sucker","sniper","spinner","grower","beamer","spawner","ghoster","focuser","slasher4","hopsploder","stingWinger","sneakyStriker","bigSucker","quadLaser","launchPusher","slasher5","mortar"],tier:[["starter"],["slasher","hopper","flutter","shooter","grower","grenadier","laser","beamer","launcher","exploder"],["slasher2","hopperBaby","stabber","springer","striker","spinner","sucker","pulsar","focuser","spawner"],["slasher3","hopMother","stinger","sniper","sneaker","ghoster","laserLayer","launcherOne","freezer"],["slasher4","hopsploder","stingWinger","sneakyStriker","bigSucker","quadLaser","launchPusher","slasher5","mortar"]],bossTier:[[],["snakeBoss","dragonFlyBoss","slashBoss","revolutionBoss","streamBoss","launcherBoss","grenadierBoss","shooterBoss","orbitalBoss","spiderBoss","shieldingBoss"],["powerUpBossBaby","sneakBoss","blockBoss","laserTargetingBoss","blinkBoss","pulsarBoss","spawnerBossCulture","growBossCulture"],["powerUpBoss","laserLayerBoss","historyBoss","beetleBoss","snakeSpitBoss","mantisBoss","laserBombingBoss","cellBossCulture","bomberBoss","timeSkipBoss","conductorBoss"],["stagBeetleBoss","kingSnakeBoss","iceBlockBoss","fabricatorBoss","pentaLaserBoss","defendingBoss","quasarBoss"]],bossTierIndex:[0,0,0,0,0],randomBossList:["orbitalBoss","historyBoss","shooterBoss","cellBossCulture","bomberBoss","spiderBoss","launcherBoss","laserTargetingBoss","powerUpBoss","powerUpBossBaby","streamBoss","pulsarBoss","spawnerBossCulture","grenadierBoss","growBossCulture","blinkBoss","snakeSpitBoss","laserBombingBoss","blockBoss","revolutionBoss","slashBoss","shieldingBoss","timeSkipBoss","dragonFlyBoss","beetleBoss","sneakBoss","mantisBoss","laserLayerBoss","snakeBoss","conductorBoss"],mobDmgDoneByTier:[.35,.7,2.1,3.5,4.9,6.3],dmgToPlayerByLevelsCleared:()=>.5*level.levelsCleared,mobDmgTakenByTier:[.5,1,.5,.1,.02,.004],mobDmgTakenByLevelsCleared:()=>.5*Math.pow(.2,.25*level.levelsCleared),mobTypeSpawnOrder:[],mobTierSpawnOrder:[],mobTypeSpawnIndex:0,setMobTypeSpawnOrder(){if(spawn.mobTypeSpawnIndex=0,spawn.mobTypeSpawnOrder=[],spawn.mobTierSpawnOrder=[],spawn.pickList=["starter","starter"],simulation.difficultyMode>3){let t=1;seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<3;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<3;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<4;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<4;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t)}else{spawn.mobTypeSpawnOrder.push("starter"),spawn.mobTierSpawnOrder.push(0);let t=1;seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<3;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<4;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]),seededShuffle(spawn.bossTier[t]);for(let e=0;e<4;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t);t++,seededShuffle(spawn.tier[t]);for(let e=0;e<2;e++)spawn.mobTypeSpawnOrder.push(spawn.tier[t][e]),spawn.mobTierSpawnOrder.push(t)}spawn.setSpawnList()},setSpawnList(){if(spawn.pickList.splice(0,1),level.levelsCleared>13){const t=spawn.fullPickList[Math.floor(Math.random()*spawn.fullPickList.length)];spawn.pickList.push(t)}else{const t=spawn.mobTypeSpawnOrder[spawn.mobTypeSpawnIndex++%spawn.mobTypeSpawnOrder.length];spawn.pickList.push(t)}},randomizeSpawnList(t){if(spawn.pickList.splice(0,1),level.levelsCleared>13){const t=spawn.fullPickList[Math.floor(Math.random()*spawn.fullPickList.length)];spawn.pickList.push(t)}else{const e=spawn.tier[t],i=e[Math.floor(Math.random()*e.length)];spawn.pickList.push(i)}},randomMobByLevelsCleared(t,e){if(level.levelsCleared>13){const i=spawn.fullPickList[Math.floor(Math.random()*spawn.fullPickList.length)];spawn[i](t,e)}else{const i=spawn.mobTierSpawnOrder[level.levelsCleared],s=spawn.tier[i],o=s[Math.floor(Math.random()*s.length)];spawn[o](t,e)}},spawnChance(t){const e=1===simulation.difficultyMode?1:simulation.difficulty;return Math.random()<t+.07*e&&mob.length<16*Math.log10(simulation.difficulty+1)-1},randomMob(t,e,i=1){if(spawn.spawnChance(i)||i===1/0){const i=spawn.pickList[Math.floor(Math.random()*spawn.pickList.length)];spawn[i](t,e)}if(tech.isDuplicateMobs&&Math.random()<tech.duplicationChance()){const i=spawn.pickList[Math.floor(Math.random()*spawn.pickList.length)];spawn[i](t,e)}},randomSmallMob(t,e,i=Math.max(Math.min(Math.round(Math.random()*simulation.difficulty*.2),4),0),s=16+Math.ceil(15*Math.random()),o=1){if(spawn.spawnChance(o))for(let o=0;o<i;++o){const i=spawn.pickList[Math.floor(Math.random()*spawn.pickList.length)];spawn[i](t+Math.round(20*(Math.random()-.5))+o*s*2.5,e+Math.round(20*(Math.random()-.5)),s)}if(tech.isDuplicateMobs&&Math.random()<tech.duplicationChance())for(let o=0;o<i;++o){const i=spawn.pickList[Math.floor(Math.random()*spawn.pickList.length)];spawn[i](t+Math.round(20*(Math.random()-.5))+o*s*2.5,e+Math.round(20*(Math.random()-.5)),s)}},allowedGroupList:[["starter"],["laser","beamer","shooter","launcher","grenadier"],["focuser","pulsar"],["launcherOne","sniper","laserLayer","freezer"],["quadLaser","launchPusher","mortar"]],randomGroup(t,e,i=1){if(spawn.spawnChance(i)&&simulation.difficulty>2||i===1/0)if(level.levelsCleared>13){let i=function(t){const e=t[Math.floor(Math.random()*t.length)];return e[Math.floor(Math.random()*e.length)]}(spawn.allowedGroupList);Math.random()<.55?spawn.nodeGroup(t,e,i):spawn.lineGroup(t,e,i)}else{const i=spawn.mobTierSpawnOrder[level.levelsCleared];let s=spawn.allowedGroupList[i][Math.floor(Math.random()*spawn.allowedGroupList[i].length)];Math.random()<.55?spawn.nodeGroup(t,e,s):spawn.lineGroup(t,e,s)}},randomLevelBoss(t,e,i=[]){if(level.levelsCleared>13){const i=spawn.randomBossList[Math.floor(Math.random()*spawn.randomBossList.length)];spawn[i](t,e)}else if(simulation.difficultyMode>1||level.levelsCleared>1)if(0===i.length){const i=spawn.mobTierSpawnOrder[level.levelsCleared],s=spawn.bossTier[i][spawn.bossTierIndex[i]];if(s)spawn[s](t,e),spawn.bossTierIndex[i]++,spawn.bossTierIndex[i]===spawn.bossTier[i].length&&(spawn.bossTierIndex[i]=0);else{const i=spawn.randomBossList[Math.floor(Math.random()*spawn.randomBossList.length)];spawn[i](t,e)}}else spawn[i[Math.floor(Math.random()*i.length)]](t,e);else powerUps.spawnBossPowerUp(t,e)},secondaryBossChance(t,e,i=[]){if(!(simulation.difficultyMode>2))return!1;spawn.randomLevelBoss(t,e,i),powerUps.spawn(t-30,e,"ammo"),powerUps.spawn(t+30,e,"ammo")},randomHigherTierMob(t,e){if(simulation.difficultyMode>3){const i=spawn.mobTierSpawnOrder[level.levelsCleared],s=spawn.tier[i],o=s[Math.floor(Math.random()*s.length)];spawn[o](t,e)}},darkMatter(t=m.pos.x,e=m.pos.y){mobs.spawn(t,e,3,.1,"transparent");let i=mob[mob.length-1];i.stroke="transparent",i.isShielded=!0,i.leaveBody=!1,i.isBadTarget=!0,i.isUnblockable=!0,i.isDropPowerUp=!1,i.collisionFilter.category=0,i.collisionFilter.mask=0,i.chaseSpeed=3.3,i.isDarkMatter=!0,i.frictionAir=.006,i.onDeath=function(){tech.isHarmDarkMatter=!1},i.do=function(){if(!simulation.isTimeSkipping){const t=(tech.isMoveDarkMatter||tech.isNotDarkMatter?1.6:1)*level.isReducedRegen,e=Math.sin(.015*simulation.cycle);this.radius=111*tech.isDarkStar+370*(1+.1*e);const i=Vector.sub(player.position,this.position),s=Vector.magnitude(i);tech.isMoveDarkMatter&&m.crouch&&input.down&&(Matter.Body.setVelocity(this,Vector.add(Vector.mult(this.velocity,.97),Vector.mult(player.velocity,.03))),Matter.Body.setPosition(this,Vector.add(Vector.mult(this.position,.95),Vector.mult(player.position,.05))));const o=Vector.mult(Vector.normalise(i),3e-9*(this.distanceToPlayer()>4e3?3:1));if(this.force.x+=o.x,this.force.y+=o.y,tech.isNotDarkMatter?s<this.radius?tech.isHarmDarkMatter=!1:(tech.isHarmDarkMatter=!0,ctx.strokeStyle="rgba(80,120,200,0.2)",ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,36,0,2*Math.PI),ctx.lineWidth=10,ctx.stroke(),tech.isDarkEnergy&&(m.energy+=.0017*t)):s<this.radius?(tech.isHarmDarkMatter=!0,ctx.strokeStyle="rgba(80,120,200,0.2)",ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,36,0,2*Math.PI),ctx.lineWidth=10,ctx.stroke(),tech.isDarkEnergy&&(m.energy+=.0017*t)):tech.isHarmDarkMatter=!1,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius+15,0,2*Math.PI),ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.stroke(),tech.isDarkStar&&!m.isCloak){ctx.fillStyle="rgba(10,0,40,0.4)",ctx.fill();for(let e=0,i=mob.length;e<i;++e)if(mob[e].alive&&!mob[e].isShielded&&Vector.magnitude(Vector.sub(this.position,mob[e].position))-mob[e].radius<this.radius){const i=.03*t;mob[e].damage(i),simulation.drawList.push({x:mob[e].position.x,y:mob[e].position.y,radius:mob[e].radius+8,color:"rgba(10,0,40,0.1)",time:4})}}ctx.beginPath();const a=150,n=simulation.cycle%a;ctx.arc(this.position.x,this.position.y,15+this.radius+.3*n,0,2*Math.PI),ctx.strokeStyle=`rgba(0,0,0,${.5*Math.max(0,1-1.4*n/a)})`,ctx.stroke()}}},WIMP(t=level.exit.x+200*tech.wimpCount*(Math.random()-.5),e=level.exit.y+200*tech.wimpCount*(Math.random()-.5)){mobs.spawn(t,e,3,.1,"transparent");let i=mob[mob.length-1];i.stroke="transparent",i.isShielded=!0,i.leaveBody=!1,i.isBadTarget=!0,i.isUnblockable=!0,i.isDropPowerUp=!1,i.collisionFilter.category=0,i.collisionFilter.mask=0,i.chaseSpeed=1.2+2.3*Math.random(),i.awake=function(){const t=Vector.sub(player.position,this.position),e=Vector.add(this.position,Vector.mult(Vector.normalise(t),this.chaseSpeed));if(Matter.Body.setPosition(this,{x:e.x,y:e.y}),Matter.Body.setVelocity(this,{x:0,y:0}),m.immuneCycle<m.cycle&&Vector.magnitude(Vector.sub(player.position,this.position))<this.radius){const t=tech.isRadioactiveResistance?.05*.2:.05;m.energy>t?m.immuneCycle<m.cycle&&(m.energy-=t):(m.energy=0,m.takeDamage((tech.isRadioactiveResistance?.001:.005)*this.damageScale()),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:this.radius,color:simulation.mobDmgColor,time:simulation.drawTime}))}ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),ctx.fillStyle=`rgba(25,139,170,${.2+.12*Math.random()})`,ctx.fill(),this.radius=100*(1+.25*Math.sin(.03*simulation.cycle))},i.do=function(){if(player.speed>1&&!m.isCloak){if(this.distanceToPlayer()<500){const t=Vector.rotate({x:1,y:0},6.28*Math.random());Matter.Body.setPosition(this,Vector.add(player.position,Vector.mult(t,2e3)))}setTimeout(()=>{this.do=this.awake},1e3*Math.random())}this.checkStatus()}},finalBoss(t,e,i=300){mobs.spawn(t,e,6,i,"rgb(150,150,255)");let s=mob[mob.length-1];setTimeout(()=>{s.constraint=Constraint.create({pointA:{x:s.position.x,y:s.position.y},bodyB:s,stiffness:1,damping:1}),Composite.add(engine.world,s.constraint)},1e3),s.tier=5,s.isBoss=!0,s.isFinalBoss=!0,s.frictionAir=.01,s.memory=1/0,s.locatePlayer(),s.hasRunDeathScript=!1,s.cycle=1,Matter.Body.setDensity(s,.2),s.damageReduction=.14,s.startingDamageReduction=s.damageReduction,s.nextHealthThreshold=.999,s.invulnerableCount=0,s.isInvulnerable=!1,s.totalModes=0,s.lastDamageCycle=0,s.onDamage=function(){this.lastDamageCycle=this.cycle,this.health<this.nextHealthThreshold&&(1===this.health&&(s.cycle=1),this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=220+10*simulation.difficultyMode,this.isInvulnerable=!0,this.damageReduction=0)},s.invulnerable=function(){if(this.isInvulnerable){if(this.invulnerableCount--,this.invulnerableCount<0){this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.pushAway(),this.mode[this.totalModes].enter(),this.totalModes++;let t=3;simulation.difficultyMode>4&&this.health<.4&&(t=4),s.mobType=spawn.tier[t][Math.floor(Math.random()*spawn.tier[t].length)];for(let t=0;t<6;t++)s.spawnMobs(t);level.newLevelOrPhase()}ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=15+6*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke(),ctx.fillStyle=`rgba(255,255,255,${Math.min(1,120/(this.invulnerableCount+60))})`,ctx.fill()}},s.damageReductionDecay=function(){!(s.cycle%60)&&this.lastDamageCycle+240>this.cycle&&(this.damageReduction*=1.04)},s.mobType=spawn.tier[4][Math.floor(Math.random()*spawn.tier[4].length)],s.spawnMobs=function(t=0){const e=s.vertices[t],i=Vector.normalise(Vector.sub(s.position,e)),o=Vector.add(e,Vector.mult(i,-30));spawn[s.mobType](o.x+50*(Math.random()-.5),o.y+50*(Math.random()-.5));const a=Vector.mult(Vector.perp(i),-10);Matter.Body.setVelocity(mob[mob.length-1],{x:s.velocity.x+a.x,y:s.velocity.y+a.y})},s.maxMobs=400,s.mode=[{name:"boulders",spawnRate:Math.max(30,170-5*simulation.difficultyMode),do(){!(s.cycle%this.spawnRate)&&mob.length<s.maxMobs&&s.boulder(s.position.x,s.position.y+250)},enter(){},exit(){}},{name:"mobs",spawnRate:Math.max(60,240-20*simulation.difficultyMode),do(){if(!(s.cycle%this.spawnRate)&&mob.length<s.maxMobs){s.torque+=15e-6*s.inertia;const t=Math.floor(s.cycle%(6*this.spawnRate)/this.spawnRate);if(0===t){const t=4;s.mobType=spawn.tier[t][Math.floor(Math.random()*spawn.tier[t].length)]}s.spawnMobs(t)}},enter(){},exit(){}},{name:"hoppers",spawnRate:Math.max(90,480-16*simulation.difficultyMode),do(){if(!(s.cycle%this.spawnRate)&&mob.length<s.maxMobs){s.torque+=2e-5*s.inertia;for(let t=0;t<6;t++){const e=s.vertices[t];spawn.hopBullet(e.x+50*(Math.random()-.5),e.y+50*(Math.random()-.5),4,13+Math.ceil(8*Math.random())),Matter.Body.setDensity(mob[mob.length-1],.002);const i=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(s.position,e))),-18);Matter.Body.setVelocity(mob[mob.length-1],{x:s.velocity.x+i.x,y:s.velocity.y+i.y})}let t={x:600-100*Math.random(),y:-225};simulation.isHorizontalFlipped&&(t.x=100*Math.random()-600),spawn.hopBullet(t.x,t.y,4,13+Math.ceil(8*Math.random())),Matter.Body.setDensity(mob[mob.length-1],.002)}},enter(){},exit(){}},{name:"seekers",spawnRate:Math.max(10,80-6*simulation.difficultyMode),do(){if(!(s.cycle%this.spawnRate)&&mob.length<s.maxMobs){const t=Math.floor(s.cycle%360/60);spawn.seeker(s.vertices[t].x,s.vertices[t].y,4,18*(.5+Math.random()));const e=mob[mob.length-1];Matter.Body.setDensity(e,3e-5),e.timeLeft=720+30*simulation.difficulty,e.accelMag=4e-4*simulation.accelScale,e.frictionAir=.01}},enter(){},exit(){}},{name:"mines",bombCycle:0,bombInterval:Math.max(2,10-simulation.difficultyMode),do(){const t=120;if(this.bombCycle++,!(this.bombCycle%this.bombInterval)&&this.bombCycle%660>330)if(simulation.isHorizontalFlipped){const e=m.pos.x+200*(Math.random()-.5);e>-750?(spawn.mine(Math.min(Math.max(-730,e),100),-450-t*Math.random()),mob[mob.length-1].fallHeight=-209):(spawn.mine(Math.min(Math.max(-5375,e),-765),-1500-t*Math.random()),mob[mob.length-1].fallHeight=-9),Math.random()<.5&&(spawn.mine(4550*Math.random()-5350,-1500-t*Math.random()),mob[mob.length-1].fallHeight=-9)}else{const e=m.pos.x+200*(Math.random()-.5);e<750?(spawn.mine(Math.min(Math.max(-100,e),735),-450-t*Math.random()),mob[mob.length-1].fallHeight=-209):(spawn.mine(Math.min(Math.max(760,e),5375),-1500-t*Math.random()),mob[mob.length-1].fallHeight=-9),Math.random()<.5&&(spawn.mine(800+4550*Math.random(),-1500-t*Math.random()),mob[mob.length-1].fallHeight=-9)}for(let t=0;t<mob.length;t++)mob[t].isMine&&(mob[t].position.y<mob[t].fallHeight?mob[t].force.y+=.03*mob[t].mass:mob[t].isOnGround||(mob[t].isOnGround=!0,Matter.Body.setPosition(mob[t],{x:mob[t].position.x,y:mob[t].fallHeight})))},enter(){this.bombCycle=0},exit(){for(let t=0;t<mob.length;t++)mob[t].isMine&&(mob[t].isExploding=!0)}},{name:"orbiters",spawnRate:Math.ceil(Math.max(2,5-.2*simulation.difficultyMode)),orbitersCycle:0,do(){if(this.orbitersCycle++,!(this.orbitersCycle%this.spawnRate)&&this.orbitersCycle%660>600&&mob.length<s.maxMobs){const t=(.01+5e-4*simulation.difficultyMode)*(Math.random()<.5?.85:-1.15),e=0,i=s.distanceToPlayer();s.orbitalNoVelocity(s,i+900*(Math.random()-.5),.1*Math.random()+e,t)}},enter(){},exit(){}},{name:"laser",spinForce:8e-8,fadeCycle:0,do(){if(this.fadeCycle++,this.fadeCycle>0){if(s.torque+=this.spinForce*s.inertia,this.fadeCycle>360&&(this.fadeCycle=simulation.difficultyMode*simulation.difficultyMode-200),ctx.strokeStyle="#50f",ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.lineWidth=1.5,ctx.beginPath(),this.fadeCycle<120){const t=this.fadeCycle/120,e=this.fadeCycle<60?0:.1*s.damageScale()*t;s.lasers(s.vertices[0],s.angle+Math.PI/6,e),s.lasers(s.vertices[1],s.angle+3*Math.PI/6,e),s.lasers(s.vertices[2],s.angle+5*Math.PI/6,e),s.lasers(s.vertices[3],s.angle+7*Math.PI/6,e),s.lasers(s.vertices[4],s.angle+9*Math.PI/6,e),s.lasers(s.vertices[5],s.angle+11*Math.PI/6,e),ctx.strokeStyle=`rgba(85, 0, 255,${t})`,ctx.stroke(),ctx.strokeStyle=`rgba(80, 0, 255,${.07*t})`}else this.fadeCycle>0&&(s.lasers(s.vertices[0],s.angle+Math.PI/6),s.lasers(s.vertices[1],s.angle+3*Math.PI/6),s.lasers(s.vertices[2],s.angle+5*Math.PI/6),s.lasers(s.vertices[3],s.angle+7*Math.PI/6),s.lasers(s.vertices[4],s.angle+9*Math.PI/6),s.lasers(s.vertices[5],s.angle+11*Math.PI/6),ctx.strokeStyle="#50f",ctx.stroke(),ctx.strokeStyle="rgba(80,0,255,0.07)");ctx.setLineDash([]),ctx.lineWidth=20,ctx.stroke()}},enter(){this.fadeCycle=0},exit(){}},{name:"black hole",eventHorizon:0,eventHorizonRadius:1700,eventHorizonCycle:0,do(){if(this.eventHorizonCycle++,this.eventHorizon=Math.max(0,this.eventHorizonRadius*Math.sin(.007*this.eventHorizonCycle)),ctx.beginPath(),ctx.arc(s.position.x,s.position.y,.2*this.eventHorizon,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.3)",ctx.fill(),ctx.beginPath(),ctx.arc(s.position.x,s.position.y,.4*this.eventHorizon,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.25)",ctx.fill(),ctx.beginPath(),ctx.arc(s.position.x,s.position.y,.6*this.eventHorizon,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.2)",ctx.fill(),ctx.beginPath(),ctx.arc(s.position.x,s.position.y,.8*this.eventHorizon,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.15)",ctx.fill(),ctx.beginPath(),ctx.arc(s.position.x,s.position.y,this.eventHorizon,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.1)",ctx.fill(),Vector.magnitude(Vector.sub(s.position,player.position))<this.eventHorizon){m.immuneCycle<m.cycle&&(m.energy>0&&(m.energy-=.018),m.energy<.05&&m.immuneCycle<m.cycle&&m.takeDamage(3e-4*s.damageScale()));const t=Math.atan2(player.position.y-s.position.y,player.position.x-s.position.x);player.force.x-=.0017*Math.cos(t)*player.mass*(m.onGround?1.7:1),player.force.y-=.0017*Math.sin(t)*player.mass,ctx.beginPath(),ctx.moveTo(s.position.x,s.position.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineWidth=Math.min(60,2*s.radius),ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke(),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.3)",ctx.fill()}s.curl(this.eventHorizon)},enter(){this.eventHorizonCycle=0},exit(){}},{name:"oscillation",waveCycle:0,whereX:simulation.isHorizontalFlipped?-3e3:3e3,do(){this.waveCycle+=!s.isStunned+!s.isSlowed,s.constraint.pointA={x:this.whereX+600*Math.sin(.005*this.waveCycle),y:s.constraint.pointA.y}},enter(){spawn.shield(s,s.position.x,s.position.y,1)},exit(){this.waveCycle=0}},{name:"slow zone",waveCycle:0,whereX:simulation.isHorizontalFlipped?-3e3:3e3,width:1200,cycle:0,cycleDuration:150,zone:0,isMovingRight:!0,playerSlowTime:0,do(){if(this.cycle++,this.cycle%this.cycleDuration===0&&(this.zone+=this.isMovingRight?1:-1,this.zone>0&&(this.isMovingRight=!1),this.zone<-1&&(this.isMovingRight=!0),this.whereX=(simulation.isHorizontalFlipped?-3e3:3e3)+this.width*this.zone),this.cycle%this.cycleDuration>.45*this.cycleDuration){if(ctx.fillStyle=`rgba(0, 100, 255, ${.19+.015*Math.sin(.36*simulation.cycle)})`,ctx.fillRect(this.whereX,-1500,this.width,1500),player.position.x>this.whereX&&player.position.x<this.whereX+this.width){this.playerSlowTime=180;const t=1e-4*s.damageScale();m.takeDamage(t)}}else ctx.fillStyle=`rgba(0, 100, 255, ${.2+.25*Math.random()})`,ctx.fillRect(this.whereX,-1500,this.width,12),ctx.fillRect(this.whereX,-12,this.width,12);this.playerSlowTime>0&&(this.playerSlowTime--,Matter.Body.setVelocity(player,{x:Math.max(.05,1-.01*Math.max(10,this.playerSlowTime))*player.velocity.x,y:Math.max(.2,1-.0025*this.playerSlowTime)*player.velocity.y}),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,45,0,2*Math.PI),ctx.fillStyle=`rgba(0,100,255,${.003*Math.max(10,this.playerSlowTime)})`,ctx.fill())},enter(){},exit(){}},{name:"antigravity",cycle:0,startCycle:420,totalCycles:600,rectX:simulation.isHorizontalFlipped?-5400:-150,do(){if(this.cycle++,this.cycle>this.totalCycles&&(this.cycle=0),this.cycle===this.startCycle){for(let t=0,e=body.length;t<e;++t)body[t].force.y-=.05*body[t].mass;for(let t=0,e=powerUp.length;t<e;++t)powerUp[t].force.y-=.07*powerUp[t].mass;for(let t=0,e=bullet.length;t<e;++t)bullet[t].force.y-=.05*bullet[t].mass;for(let t=0,e=mob.length;t<e;++t)mob[t].force.y-=.15*mob[t].mass;player.force.y-=.04*player.mass}else if(this.cycle>this.startCycle){for(let t=0,e=body.length;t<e;++t)body[t].force.y-=simulation.g*body[t].mass,Matter.Body.setVelocity(body[t],Vector.mult(body[t].velocity,.98));for(let t=0,e=powerUp.length;t<e;++t)powerUp[t].force.y-=simulation.g*powerUp[t].mass;player.force.y-=simulation.g*player.mass,Matter.Body.setVelocity(player,Vector.mult(player.velocity,.985)),ctx.fillStyle=`rgba(0, 0, 0, ${.03+.03*Math.random()})`,ctx.fillRect(this.rectX,-1500,5650,1500)}else this.cycle>this.startCycle-60&&(ctx.fillStyle=`rgba(0, 0, 0, ${.2+.25*Math.random()})`,ctx.fillRect(this.rectX,-25,5650,25))},enter(){spawn.shield(s,s.position.x,s.position.y,1)},exit(){this.cycle=0}}],s.mode.sort(()=>Math.random()-.5),s.healthBarFinal=function(){const t=.2*this.radius,e=this.position.x,i=this.position.y-.6*this.radius;ctx.fillStyle=`hsla(${360*Math.sin(.011*this.cycle+30)},${80+20*Math.sin(.004*this.cycle+30)}%,${60+20*Math.sin(.009*this.cycle+30)}%,0.3)`;for(let s=0;s<4;s++)if(this.health>.25*s){ctx.beginPath();for(let o=0;o<6;o++){const a=Math.PI/3*o-Math.PI/2,n=e+t*Math.cos(a),r=i+t*Math.sin(a)+.4*s*this.radius;0===o?ctx.moveTo(n,r):ctx.lineTo(n,r)}ctx.closePath(),ctx.fill()}},s.do=function(){if(this.fill=`hsl(${360*Math.sin(.011*this.cycle)},${80+20*Math.sin(.004*this.cycle)}%,${60+20*Math.sin(.009*this.cycle)}%)`,this.health<1){this.seePlayer.recall&&this.healthBarFinal(),this.cycle++,this.checkStatus(),this.invulnerable(),this.spawnBoss(),this.damageReductionDecay();for(let t=0;t<this.totalModes;t++)this.mode[t].do()}},s.spawnRate=5800-30*simulation.difficultyMode*simulation.difficultyMode,s.spawnBoss=function(){!(s.cycle%this.spawnRate)&&this.health<1&&(this.spawnRate=Math.max(300,this.spawnRate-10*simulation.difficultyMode*simulation.difficultyMode),spawn.randomLevelBoss(3e3*(simulation.isHorizontalFlipped?-1:1)+2e3*(Math.random()-.5),200*(Math.random()-.5)-1100))},s.pushAway=function(t=.13,e=.05){for(let i=0,s=body.length;i<s;++i)body[i].force.x+=t*body[i].mass*(body[i].position.x>this.position.x?1:-1),body[i].force.y-=e*body[i].mass;for(let i=0,s=bullet.length;i<s;++i)bullet[i].force.x+=t*bullet[i].mass*(bullet[i].position.x>this.position.x?1:-1),bullet[i].force.y-=e*bullet[i].mass;for(let i=0,s=powerUp.length;i<s;++i)powerUp[i].force.x+=t*powerUp[i].mass*(powerUp[i].position.x>this.position.x?1:-1),powerUp[i].force.y-=e*powerUp[i].mass;player.force.x+=t*player.mass*(player.position.x>this.position.x?1:-1),player.force.y-=e*player.mass},s.boulder=function(t,e){mobs.spawn(t,e,6,Math.floor(50+50*Math.random()),this.fill);let i=this,s=mob[mob.length-1];s.stroke="transparent",s.onHit=function(){this.timeLeft=0},s.explodeRange=500,s.onDeath=function(){let t,e;simulation.drawList.push({x:this.position.x,y:this.position.y,radius:this.explodeRange,color:this.fill,time:8}),t=Vector.sub(player.position,this.position),Vector.magnitude(t)<this.explodeRange&&(m.takeDamage(.05),e=Vector.mult(Vector.normalise(t),.1*player.mass),player.force.x+=e.x,player.force.y+=e.y);for(let i=0,s=powerUp.length;i<s;++i)t=Vector.sub(powerUp[i].position,this.position),Vector.magnitude(t)<this.explodeRange&&(e=Vector.mult(Vector.normalise(t),.1*powerUp[i].mass),powerUp[i].force.x+=e.x,powerUp[i].force.y+=e.y);for(let i=0,s=body.length;i<s;++i)t=Vector.sub(body[i].position,this.position),Vector.magnitude(t)<this.explodeRange&&(e=Vector.mult(Vector.normalise(t),.1*body[i].mass),body[i].force.x+=e.x,body[i].force.y+=e.y)},Matter.Body.setDensity(s,.003),s.timeLeft=300,s.g=5e-4,s.frictionAir=.005,s.friction=1,s.frictionStatic=1,s.restitution=0,s.leaveBody=!1,s.isDropPowerUp=!1,s.isBadTarget=!0,s.isMobBullet=!0,s.collisionFilter.category=cat.mobBullet,s.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,s.spin=5e-6*s.inertia*(1+Math.random())*(m.pos.x>s.position.x?1:-1),Matter.Body.setAngularVelocity(s,.1*(1+.3*Math.random())*(m.pos.x>s.position.x?1:-1)),Matter.Body.setVelocity(s,{x:0,y:10}),s.do=function(){this.fill=i.fill,this.torque+=this.spin,this.gravity(),this.timeLimit(),this.timeLeft<60&&(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.explodeRange,0,2*Math.PI),ctx.fillStyle="rgba(255,255,255,0.15)",ctx.fill())}},s.orbitalNoVelocity=function(t,e,i,s){let o=this;mobs.spawn(t.position.x,t.position.y,6,20,"rgb(255,0,150)");let a=mob[mob.length-1];a.stroke="transparent",Matter.Body.setDensity(a,.001),a.leaveBody=!1,a.isDropPowerUp=!1,a.isBadTarget=!0,a.isUnstable=!0,a.isOrbital=!0,a.collisionFilter.category=cat.mobBullet,a.collisionFilter.mask=cat.bullet,a.do=function(){this.fill=o.fill;const n=simulation.cycle*s+i,r={x:Math.cos(n),y:Math.sin(n)};if(Matter.Body.setPosition(this,Vector.add(t.position,Vector.mult(r,e))),Matter.Query.collides(this,[player]).length>0&&(!m.isCloak||!tech.isIntangible)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles;const t=.13*a.damageScale();m.takeDamage(t),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:200*Math.sqrt(t),color:simulation.mobDmgColor,time:simulation.drawTime}),this.death()}}},s.lasers=function(t,e,i=.1*s.damageScale()){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const o={x:t.x+7e3*Math.cos(e),y:t.y+7e3*Math.sin(e)};best=vertexCollision(t,o,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle&&(m.immuneCycle<m.cycle+60+m.collisionImmuneCycles&&(m.immuneCycle=m.cycle+60+m.collisionImmuneCycles),m.takeDamage(i),simulation.drawList.push({x:best.x,y:best.y,radius:1500*i,color:"rgba(80,0,255,0.5)",time:20})),best.dist2===1/0&&(best=o),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y)},s.onDeath=function(){if(m.health<0)m.death();else if(!this.hasRunDeathScript){this.hasRunDeathScript=!0,simulation.isCheating||(localSettings.difficultyCompleted[simulation.difficultyMode]=!0,localStorage.setItem("localSettings",JSON.stringify(localSettings)));const e=body.length,i=Matter.Vertices.hull(Matter.Vertices.clockwiseSort(this.vertices));body[e]=Matter.Bodies.fromVertices(this.position.x,this.position.y,i),Matter.Body.setVelocity(body[e],{x:0,y:-3}),Matter.Body.setAngularVelocity(body[e],this.angularVelocity),body[e].collisionFilter.category=cat.body,body[e].collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,body[e].classType="body",Composite.add(engine.world,body[e]);const s=function(t,e){Matter.Body.scale(t,1.05,1.05),t.mass<e&&setTimeout(s,20,t,e)};function t(){simulation.isHorizontalFlipped?level.exit.x=-5600:level.exit.x=5500,level.exit.y=-330,Matter.Composite.remove(engine.world,map[map.length-1]),map.splice(map.length-1,1),simulation.draw.setPaths()}if(s(body[e],200),lore.techCount>lore.techGoal-1&&!simulation.isCheating)simulation.inGameConsole(`<span class="lore-text">undefined</span> <span class='color-symbol'>=</span> ${lore.techCount}/${lore.techGoal}`,360),setTimeout(function(){simulation.inGameConsole("level.levels.push(\"<span class='lore-text'>null</span>\")",720),t(),level.levels.push("null")},4e3);else{let o=0;requestAnimationFrame(function e(){if(!simulation.paused&&!simulation.onTitlePage)if(o++,o<660)1===o&&simulation.difficultyMode<6&&simulation.inGameConsole("<em>//enter testing mode to set level.levels.length to <strong>Infinite</strong></em>"),o%60||simulation.inGameConsole(`simulation.analysis <span class='color-symbol'>=</span> ${(.1*(o/60-Math.random())).toFixed(3)}`);else if(660===o)simulation.inGameConsole("simulation.analysis <span class='color-symbol'>=</span> 1 <em>//analysis complete</em>");else if(780===o)simulation.inGameConsole(`<span class="lore-text">undefined</span> <span class='color-symbol'>=</span> ${lore.techCount}/${lore.techGoal}`);else if(1020===o)simulation.inGameConsole("Engine.clear(engine) <em>//simulation successful</em>");else if(1260===o)return document.getElementById("health").style.display="none",document.getElementById("health-bg").style.display="none",document.getElementById("defense-bar").style.display="none",document.getElementById("damage-bar").style.display="none",document.getElementById("text-log").style.display="none",document.getElementById("fade-out").style.opacity=1,void setTimeout(function(){simulation.onTitlePage||(m.alive=!1,simulation.paused=!0,engine.world.bodies.forEach(t=>{Matter.Composite.remove(engine.world,t)}),Engine.clear(engine),simulation.splashReturn())},6e3);simulation.testing||simulation.difficultyMode>6?(t(),setTimeout(function(){simulation.inGameConsole("level.levels.length <span class='color-symbol'>=</span> <strong>Infinite</strong>")},1500)):simulation.onTitlePage||requestAnimationFrame(e)})}!function(t){for(let e=0;e<t.length;++e)Matter.Composite.remove(engine.world,t[e])}(powerUp),powerUp=[];for(let a=0,n=body.length;a<n;++a){const r=Vector.mult(Vector.normalise(Vector.sub(this.position,body[a].position)),65),l=Vector.add(r,{x:0,y:-.5});Matter.Body.setVelocity(body[a],Vector.add(body[a].velocity,l))}for(let h=0;h<8;h++)for(let c=0,y=mob.length;c<y;++c)mob[c]!==this&&(mob[c].isInvulnerable&&(mob[c].isInvulnerable=!1,mob[c].damageReduction=1),mob[c].damage(1/0,!0));for(let d=0,p=22;d<p;d++)simulation.drawList.push({x:this.position.x,y:this.position.y,radius:150*(d+1),color:"rgba(255,255,255,0.17)",time:5*(p-d+1)})}}},zombie(t,e,i,s,o){mobs.spawn(t,e,s,i,o);let a=mob[mob.length-1];a.damageReduction=0,Matter.Body.setDensity(a,1e-4),a.isZombie=!0,a.isBadTarget=!0,a.isDropPowerUp=!1,a.stroke="#83a",a.accelMag=.003,a.frictionAir=.005,a.collisionFilter.mask=cat.player|cat.map|cat.body|cat.mob,a.seeAtDistance2=1e6,a.do=function(){this.seePlayer.recall&&this.healthBar1(),this.checkStatus(),this.zombieHealthBar(),this.lookForMobTargets(),this.attack()},a.mobSearchIndex=0,a.target=null,a.lookForMobTargets=function(){if(null===this.target&&mob.length>1&&!(simulation.cycle%this.seePlayerFreq)){let t=1/0;for(let e=0,i=mob.length;e<i;++e)if(!mob[e].isZombie&&!mob[e].isUnblockable&&!mob[e].isMobBullet&&0===Matter.Query.ray(map,this.position,mob[e].position).length&&0===Matter.Query.ray(body,this.position,mob[e].position).length){const i=Vector.magnitude(Vector.sub(this.position,mob[e].position));i<t&&(t=i,this.target=mob[e])}}else simulation.cycle%this.memory||!this.target||this.target.alive&&0===Matter.Query.ray(map,this.position,this.target.position).length||(this.target=null)},a.zombieHealthBar=function(){this.health-=3e-4,(this.health<.01||isNaN(this.health))&&this.alive&&this.death();const t=.3*this.radius,e=2*this.radius,i=this.position.x-e/2,s=this.position.y-.7*e;ctx.fillStyle="rgba(100, 100, 100, 0.3)",ctx.fillRect(i,s,e,t),ctx.fillStyle="rgba(136, 51, 170,0.7)",ctx.fillRect(i,s,e*this.health,t)},a.hitCD=0,a.attack=function(){if(this.hitCD<simulation.cycle&&!this.isStunned&&!this.isSlowed){if(this.target)this.force=Vector.mult(Vector.normalise(Vector.sub(this.target.position,this.position)),this.accelMag*this.mass);else{this.torque+=3e-7*this.inertia;const t=3e-4*this.mass;this.force.x+=t*Math.cos(this.angle),this.force.y+=t*Math.sin(this.angle)}this.speed>15?Matter.Body.setVelocity(this,{x:.96*this.velocity.x,y:.96*this.velocity.y}):this.speed<10?Matter.Body.setVelocity(this,{x:.98*this.velocity.x,y:.98*this.velocity.y}):this.speed<8&&Matter.Body.setVelocity(this,{x:.99*this.velocity.x,y:.99*this.velocity.y});const t=t=>{if(!t.isZombie&&t.damageReduction){this.hitCD=simulation.cycle+15;const e=Vector.mult(Vector.normalise(Vector.sub(t.position,this.position)),.03*this.mass);this.force.x-=e.x,this.force.y-=e.y,this.target=null;const i=1.5*t.damageReduction/Math.sqrt(t.mass);t.health-=i,t.onDamage(i),t.locatePlayer(),(t.health<.01||isNaN(t.health))&&t.alive&&t.death(),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:40*Math.log(i+1.1)*t.damageReduction+3,color:simulation.playerDmgColor,time:simulation.drawTime})}},e=Matter.Query.collides(this,mob);if(e.length>1)for(let i=0,s=e.length;i<s;i++)t(e[i].bodyA),t(e[i].bodyB)}}},starter(t,e,i=Math.floor(15+20*Math.random())){mobs.spawn(t,e,8,i,"#9ccdc6");let s=mob[mob.length-1];s.tier=0,s.accelMag=2e-4,s.repulsionRange=4e5+i*i,s.seeAtDistance2=2e6,Matter.Body.setDensity(s,5e-4),s.do=function(){this.seePlayerByLookingAt(),this.attraction(),this.repulsion(),this.checkStatus(),this.seePlayer.recall&&this.healthBar1()}},blockGroup(t,e,i=3+8*Math.random()){for(let s=0;s<i;s++){const i=25+Math.floor(20*Math.random());spawn.blockGroupMob(t+Math.random()*i,e+Math.random()*i,i)}},blockGroupMob(t,e,i=25+Math.floor(20*Math.random())){mobs.spawn(t,e,4,i,"#999");let s=mob[mob.length-1];s.g=15e-5,s.accelMag=8e-4*simulation.accelScale,s.groupingRangeMax=25e4+1e5*Math.random(),s.groupingRangeMin=8*i*(8*i),s.groupingStrength=5e-4,s.memory=200,s.isGrouper=!0,s.seeAtDistance2=36e4,s.seePlayerFreq=Math.floor(50+50*Math.random()),s.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.gravity(),this.checkStatus(),this.seePlayerCheck(),this.seePlayer.recall){this.attraction(),ctx.beginPath();for(let t=0,e=mob.length;t<e;t++)if(mob[t].isGrouper&&mob[t]!=this&&mob[t].isDropPowerUp){const e=Vector.magnitudeSquared(Vector.sub(this.position,mob[t].position));if(e<this.groupingRangeMax){if(mob[t].seePlayer.recall||mob[t].seePlayerCheck(),e>this.groupingRangeMin){const e=Math.atan2(mob[t].position.y-this.position.y,mob[t].position.x-this.position.x),i=this.groupingStrength*mob[t].mass;mob[t].force.x-=i*Math.cos(e),mob[t].force.y-=i*Math.sin(e)}ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[t].position.x,mob[t].position.y)}}ctx.strokeStyle="#0ff",ctx.lineWidth=1,ctx.stroke()}}},blockBoss(t,e,i=60){const s=[];mobs.spawn(t,e,4,i,"#999");const o=mob[mob.length-1];o.tier=2,o.isBoss=!0,Matter.Body.setDensity(o,.002),o.damageReduction=.04,o.frictionAir=.01,o.accelMag=2e-4,o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(const t of mob)t.isNecroMob&&(t.leaveBody=!0,t.damage(1/0))},o.target=player,o.do=function(){if(this.checkStatus(),this.seePlayerCheck(),this.target){const t=Vector.mult(Vector.normalise(Vector.sub(this.target.position,this.position)),this.accelMag*this.mass);this.force.x+=t.x,this.force.y+=t.y}if(!(simulation.cycle%30)){for(let t=0;t<body.length;t++)Vector.magnitude(Vector.sub(this.position,body[t].position))<700&&!body[t].isNotHoldable&&(Matter.Composite.remove(engine.world,body[t]),this.target=null,spawn.blockMob(body[t].position.x,body[t].position.y,body[t],0),body.splice(t,1),s.push([60,mob[mob.length-1]]));if(this.distanceToPlayer()>1500&&null===this.target)this.target=player;else if(body.length){let t=1/0,e=null;for(const i of body){const s=Vector.magnitudeSquared(Vector.sub(this.position,i.position));s<t&&0===Matter.Query.ray(map,this.position,i.position).length&&(t=s,e=i)}this.target=e}if(!(simulation.cycle%90)){let t=0;for(let e=0,i=mob.length;e<i;e++)mob[e].isNecroMob&&t++;if(t<20*Math.random()*Math.random()){const t=Vector.normalise(Vector.sub(player.position,this.position));for(let e=0,o=3*Math.random();e<o;e++){this.damageReduction+=.001;const e=.99;Matter.Body.scale(this,e,e),this.radius*=e;const o=Vector.add(Vector.mult(t,i+200*Math.random()),this.position);spawn.blockMob(o.x+100*(Math.random()-.5),o.y+100*(Math.random()-.5),null),this.torque+=35e-6*this.inertia,s.push([60,mob[mob.length-1]])}}}}for(let t=0;t<s.length;t++){const[e,i]=s[t];if(0!==e){if(i.alive){const t=Math.floor((i.vertices.length-1)*e/60);ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(i.vertices[t].x,i.vertices[t].y),ctx.moveTo(i.vertices[0].x,i.vertices[0].y);for(let t=1;t<i.vertices.length;t++)ctx.lineTo(i.vertices[t].x,i.vertices[t].y);ctx.lineTo(i.vertices[0].x,i.vertices[0].y),ctx.strokeStyle="#0ff",ctx.lineWidth=3,ctx.stroke()}s[t][0]--}else s.splice(t,1)}}},iceBlockBoss(t,e,i=60){const s=[];mobs.spawn(t,e,4,i,"#999");const o=mob[mob.length-1];o.tier=4,o.isBoss=!0,Matter.Body.setDensity(o,.003),o.damageReduction=.02,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.8,o.invulnerableCount=0,o.frictionAir=.01,o.accelMag=25e-5,o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(const t of mob)t.isNecroMob&&(t.leaveBody=!0,t.damage(1/0))},o.onDamage=function(){this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=60,this.isInvulnerable=!0,this.damageReduction=0)},o.target=player,o.do=function(){if(this.checkStatus(),this.seePlayerCheck(),this.target){const t=Vector.mult(Vector.normalise(Vector.sub(this.target.position,this.position)),this.accelMag*this.mass);this.force.x+=t.x,this.force.y+=t.y}if(this.isInvulnerable){if(this.invulnerableCount--,this.invulnerableCount<0){this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction;const t=Vector.normalise(Vector.sub(player.position,this.position));for(let e=0,i=15;e<i;e++){this.damageReduction+=.001,this.startingDamageReduction+=.001;const e=Vector.add(Vector.mult(t,60+300*Math.random()),this.position);spawn.blockMob(e.x+150*(Math.random()-.5),e.y+150*(Math.random()-.5),null,60,!0),this.torque+=35e-6*this.inertia,s.push([60,mob[mob.length-1]])}}ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else if(!(simulation.cycle%30)){simulation.cycle%210||simulation.ephemera.push({count:210,position:{x:this.position.x,y:this.position.y},level:level.levelsCleared,radius:120,do(){this.count--,(this.count<0||this.level!==level.levelsCleared)&&simulation.removeEphemera(this),this.radius*=.99,Vector.magnitude(Vector.sub(player.position,this.position))<this.radius+40&&(Matter.Body.setVelocity(player,{x:.7*player.velocity.x,y:.94*player.velocity.y}),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,34,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,255,0.2)",ctx.lineWidth=8,ctx.stroke(),m.immuneCycle<m.cycle&&m.takeDamage(23e-5*spawn.dmgToPlayerByLevelsCleared()));for(let t=0;t<bullet.length;t++)Vector.magnitude(Vector.sub(bullet[t].position,this.position))<this.radius+40&&Matter.Body.setVelocity(bullet[t],{x:.95*bullet[t].velocity.x,y:.97*bullet[t].velocity.y});ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),ctx.fillStyle=`rgba(0,0,255,${.2+.1*Math.random()})`,ctx.fill()}});for(let t=0;t<body.length;t++)Vector.magnitude(Vector.sub(this.position,body[t].position))<700&&!body[t].isNotHoldable&&(Matter.Composite.remove(engine.world,body[t]),this.target=null,spawn.blockMob(body[t].position.x,body[t].position.y,body[t],0,!0),body.splice(t,1),s.push([60,mob[mob.length-1]]));if(this.distanceToPlayer()>1500&&null===this.target)this.target=player;else if(body.length){let t=1/0,e=null;for(const i of body){const s=Vector.magnitudeSquared(Vector.sub(this.position,i.position));s<t&&0===Matter.Query.ray(map,this.position,i.position).length&&(t=s,e=i)}this.target=e}if(!(simulation.cycle%90)){let t=0;for(let e=0,i=mob.length;e<i;e++)mob[e].isNecroMob&&t++;if(t<20*Math.random()*Math.random()){const t=Vector.normalise(Vector.sub(player.position,this.position));for(let e=0,o=3*Math.random();e<o;e++){this.damageReduction+=.001;const e=.99;Matter.Body.scale(this,e,e),this.radius*=e;const o=Vector.add(Vector.mult(t,i+200*Math.random()),this.position);spawn.blockMob(o.x+100*(Math.random()-.5),o.y+100*(Math.random()-.5),null,60,!0),this.torque+=35e-6*this.inertia,s.push([60,mob[mob.length-1]])}}}}for(let t=0;t<s.length;t++){const[e,i]=s[t];if(0!==e){if(i.alive){const t=Math.floor((i.vertices.length-1)*e/60);ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(i.vertices[t].x,i.vertices[t].y),ctx.moveTo(i.vertices[0].x,i.vertices[0].y);for(let t=1;t<i.vertices.length;t++)ctx.lineTo(i.vertices[t].x,i.vertices[t].y);ctx.lineTo(i.vertices[0].x,i.vertices[0].y),ctx.strokeStyle="rgba(0,0,255,0.3)",ctx.lineWidth=20,ctx.stroke()}s[t][0]--}else s.splice(t,1)}}},blockMob(t,e,i,s=60,o=!1){if(null===i)mobs.spawn(t,e,4,1.25+3.5*Math.random(),"#999");else{const s=Vector.magnitude(Vector.sub(i.vertices[0],i.vertices[1]))+Vector.magnitude(Vector.sub(i.vertices[1],i.vertices[2]))/2;mobs.spawn(t,e,4,Math.min(70,s),"#999"),i.bounds.max.x-i.bounds.min.x<150&&i.bounds.max.y-i.bounds.min.y<150&&Matter.Body.setVertices(mob[mob.length-1],i.vertices)}const a=mob[mob.length-1];a.damageReduction=.5,a.isNecroMob=!0,a.g=12e-5,a.accelMag=3e-4*Math.sqrt(simulation.accelScale),a.memory=120,a.leaveBody=!1,a.isDropPowerUp=!1,a.cycle=0,a.onDeath=function(){o&&simulation.ephemera.push({count:200,position:{x:this.position.x,y:this.position.y},level:level.levelsCleared,radius:130,do(){this.count--,(this.count<0||this.level!==level.levelsCleared)&&simulation.removeEphemera(this),this.radius*=.99,Vector.magnitude(Vector.sub(player.position,this.position))<this.radius+40&&(Matter.Body.setVelocity(player,{x:.7*player.velocity.x,y:.94*player.velocity.y}),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,34,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,255,0.2)",ctx.lineWidth=8,ctx.stroke(),m.immuneCycle<m.cycle&&m.takeDamage(23e-5*spawn.dmgToPlayerByLevelsCleared()));for(let t=0;t<bullet.length;t++)Vector.magnitude(Vector.sub(bullet[t].position,this.position))<this.radius+40&&Matter.Body.setVelocity(bullet[t],{x:.95*bullet[t].velocity.x,y:.97*bullet[t].velocity.y});ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),ctx.fillStyle=`rgba(0,0,255,${.2+.1*Math.random()})`,ctx.fill()}})},a.do=function(){if(this.checkStatus(),this.seePlayerCheck(),this.cycle++,this.cycle>s)this.damageReduction=1.8,this.do=this.normalDo;else{const t=1.04;Matter.Body.scale(this,t,t),this.radius*=t}},a.normalDo=function(){this.gravity(),this.checkStatus(),this.seePlayerCheck(),this.attraction()}},cellBossCulture(t,e,i=20,s=5){const o=Math.random();for(let a=0;a<s;a++)spawn.cellBoss(t,e,i,o)},cellBoss(t,e,i=20,s){mobs.spawn(t+Math.random(),e+Math.random(),20,i*(1+1.2*Math.random()),"rgba(0,80,125,0.3)");let o=mob[mob.length-1];o.tier=3,o.stroke="transparent",o.isBoss=!0,o.isCell=!0,o.cellID=s,o.accelMag=165e-6*simulation.accelScale,o.memory=1/0,o.leaveBody=!1,o.isVerticesChange=!0,o.frictionAir=.012,o.seePlayerFreq=Math.floor(11+7*Math.random()),o.seeAtDistance2=14e5,o.cellMassMax=70,o.collisionFilter.mask=cat.player|cat.bullet|cat.body,Matter.Body.setDensity(o,12e-5+8e-6*simulation.difficulty),o.damageReduction=.17;o.split=function(){const t=.45;Matter.Body.scale(this,t,t),this.radius*=t,spawn.cellBoss(this.position.x,this.position.y,this.radius,this.cellID),mob[mob.length-1].health=this.health},o.onHit=function(){this.health=1,this.split()},o.onDamage=function(t){Math.random()<.34*t*Math.sqrt(this.mass)&&this.health>t&&this.split()},o.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerByDistOrLOS(),this.checkStatus(),this.attraction(),this.seePlayer.recall&&this.mass<this.cellMassMax){const t=1+2e-4*this.cellMassMax/this.mass;Matter.Body.scale(this,t,t),this.radius*=t}if(!(simulation.cycle%this.seePlayerFreq)){const t=150,e=700;for(let i=0,s=mob.length;i<s;i++)if(mob[i].isCell&&mob[i].id!==this.id){const s=Vector.sub(this.position,mob[i].position),o=Vector.magnitude(s);o<t?this.force=Vector.mult(Vector.normalise(s),.002*this.mass):o>e&&(this.force=Vector.mult(Vector.normalise(s),.003*-this.mass))}}},o.onDeath=function(){this.isCell=!1;let t=0;for(let e=0,i=mob.length;e<i;e++)mob[e].isCell&&mob[e].cellID===this.cellID&&t++;t<1?powerUps.spawnBossPowerUp(this.position.x,this.position.y):this.isDropPowerUp=!1}},spawnerBossCulture(t,e,i=50,s=8+Math.min(20,.4*simulation.difficulty)){tech.deathSpawnsFromBoss+=.4;const o=Math.random();for(let a=0;a<s;a++)spawn.spawnerBoss(t,e,i,o)},spawnerBoss(t,e,i,s){mobs.spawn(t+Math.random(),e+Math.random(),4,i,"rgba(255,0,70,1)");let o=mob[mob.length-1];o.tier=2,o.isBoss=!0,o.isSpawnBoss=!0,o.spawnID=s,o.accelMag=22e-5*simulation.accelScale,o.memory=1/0,o.isVerticesChange=!0,o.frictionAir=.011,o.seePlayerFreq=Math.floor(14+7*Math.random()),o.seeAtDistance2=2e5,o.stroke="transparent",o.collisionFilter.mask=cat.player|cat.bullet|cat.body|cat.map,Matter.Body.setAngularVelocity(o,.12*(Math.random()-.5)),o.onHit=function(){this.explode(2*this.mass)},o.damageReduction=.14,o.doAwake=function(){ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);if(ctx.lineTo(t[0].x,t[0].y),ctx.strokeStyle=`rgba(255,0,70,${.2+.4*Math.random()})`,ctx.lineWidth=Math.floor(5+30*this.health),ctx.stroke(),this.alwaysSeePlayer(),this.checkStatus(),this.attraction(),!(simulation.cycle%this.seePlayerFreq)){const t=40,e=240;for(let i=0,s=mob.length;i<s;i++)if(mob[i].isSpawnBoss&&mob[i].id!==this.id){const s=Vector.sub(this.position,mob[i].position),o=Vector.magnitude(s);o<t?this.force=Vector.mult(Vector.normalise(s),.002*this.mass):o>e&&(this.force=Vector.mult(Vector.normalise(s),.002*-this.mass))}}},o.do=function(){if(this.checkStatus(),this.seePlayer.recall){this.do=this.doAwake,this.fill="transparent";for(let t=0,e=mob.length;t<e;t++)mob[t].isSpawnBoss&&mob[t].spawnID===this.spawnID&&(mob[t].seePlayer.recall=1)}},o.onDeath=function(){this.isSpawnBoss=!1;let t=0;for(let e=0,i=mob.length;e<i;e++)mob[e].isSpawnBoss&&mob[e].spawnID===this.spawnID&&t++;t<1?(powerUps.spawnBossPowerUp(this.position.x,this.position.y),tech.deathSpawnsFromBoss-=.4):(this.leaveBody=!1,this.isDropPowerUp=!1);const e=tech.deathSpawns+tech.deathSpawnsFromBoss,s=Math.min(12,e*Math.ceil(Math.random()*simulation.difficulty*e));for(let t=0;t<s;t++)spawn.spawns(this.position.x+(Math.random()-.5)*i*2.5,this.position.y+(Math.random()-.5)*i*2.5,this.tier),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+10*(Math.random()-.5),y:this.velocity.x+10*(Math.random()-.5)})}},growBossCulture(t,e,i=17,s=12+Math.min(10,.25*simulation.difficulty)){const o=Math.random(),a=200+50*Math.sqrt(s);for(let n=0;n<s;++n){const s=2*Math.PI*Math.random(),n=Math.max(i,a*(1-Math.pow(Math.random(),1.5)));spawn.growBoss(t+n*Math.cos(s),e+n*Math.sin(s),i,o)}spawn.constrain2AdjacentMobs(s,1e-4,!1)},growBoss(t,e,i,s){mobs.spawn(t+Math.random(),e+Math.random(),6,i,"hsl(144, 15%, 50%)");let o=mob[mob.length-1];o.tier=2,o.isBoss=!0,o.isBuffBoss=!0,o.buffID=s,o.memory=1/0,o.isVerticesChange=!0,o.frictionAir=.012,o.seePlayerFreq=Math.floor(11+7*Math.random()),o.seeAtDistance2=2e5,o.stroke="transparent",o.collisionFilter.mask=cat.player|cat.bullet|cat.body,o.buffCount=0,o.accelMag=5e-5,o.setBuffed=function(){this.buffCount++,this.accelMag+=24e-6,this.fill=`hsl(144, ${5+10*this.buffCount}%, 50%)`;const t=1.135;Matter.Body.scale(this,t,t),this.radius*=t},o.onDeath=function(){this.isBuffBoss=!1;let t=0;for(let e=0,i=mob.length;e<i;e++)mob[e].isBuffBoss&&mob[e].buffID===this.buffID&&(t++,mob[e].setBuffed());t<1?powerUps.spawnBossPowerUp(this.position.x,this.position.y):(this.leaveBody=!1,this.isDropPowerUp=!1,powerUps.spawnRandomPowerUp(this.position.x,this.position.y))},o.damageReduction=.2,o.invulnerabilityCountDown=0,o.do=function(){this.seePlayer.recall&&this.healthBar2(),this.alwaysSeePlayer(),this.checkStatus(),this.attraction()}},powerUpBossBaby(t,e,i=9,s=60){mobs.spawn(t,e,i,s,"rgba(225,240,245,0.4)");let o=mob[mob.length-1];o.tier=2,o.isBoss=!0,o.frictionAir=.006,o.seeAtDistance2=1e6,o.accelMag=4e-4+3e-4*simulation.accelScale,o.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map,o.memory=1/0,o.seePlayerFreq=17,o.lockedOn=null,9===i?(powerUps.spawnBossPowerUp(o.position.x,o.position.y),powerUps.spawn(o.position.x,o.position.y,"heal"),powerUps.spawn(o.position.x,o.position.y,"ammo"),powerUps.spawn(o.position.x,o.position.y,"ammo")):m.isCloak||o.foundPlayer(),o.damageReduction=.21,o.isInvulnerable=!0,o.startingDamageReduction=o.damageReduction,o.damageReduction=0,o.invulnerabilityCountDown=30+simulation.difficulty,o.onHit=function(){powerUps.ejectTech()&&(powerUps.ejectGraphic("150, 138, 255"),this.accelMag*=1.4,Matter.Body.setDensity(this,1.4*this.density))},o.onDeath=function(){this.leaveBody=!1,i>3&&(this.isDropPowerUp=!1,spawn.powerUpBossBaby(this.position.x,this.position.y,i-1),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x,y:this.velocity.y}));for(let t=0;t<powerUp.length;t++)powerUp[t].collisionFilter.mask=cat.map|cat.powerUp},o.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.isInvulnerable)if(this.invulnerabilityCountDown>0){this.invulnerabilityCountDown--,ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction;if(this.alive)for(let t=0;t<Math.min(powerUp.length,this.vertices.length);t++)powerUp[t].collisionFilter.mask=0,Matter.Body.setPosition(powerUp[t],this.vertices[t]),Matter.Body.setVelocity(powerUp[t],{x:0,y:0});this.seePlayerByHistory(50),this.attraction(),this.checkStatus()}},powerUpBoss(t,e,i=9,s=130){mobs.spawn(t,e,i,s,"transparent");let o=mob[mob.length-1];o.tier=3,o.isBoss=!0,o.frictionAir=.01,o.seeAtDistance2=1e6,o.accelMag=2e-4+4e-4*simulation.accelScale,Matter.Body.setDensity(o,3e-4),o.collisionFilter.mask=cat.bullet|cat.player|cat.body,o.memory=1/0,o.seePlayerFreq=30,o.lockedOn=null,9===i?(powerUps.spawnBossPowerUp(o.position.x,o.position.y),powerUps.spawn(o.position.x,o.position.y,"heal"),powerUps.spawn(o.position.x,o.position.y,"ammo"),powerUps.spawn(o.position.x,o.position.y,"ammo"),powerUps.spawn(o.position.x,o.position.y,"ammo")):m.isCloak||o.foundPlayer(),o.damageReduction=.23,o.isInvulnerable=!0,o.startingDamageReduction=o.damageReduction,o.damageReduction=0,o.invulnerabilityCountDown=30+simulation.difficulty,o.onHit=function(){powerUps.ejectTech()&&(powerUps.ejectGraphic("150, 138, 255"),this.accelMag*=1.4,Matter.Body.setDensity(this,1.4*this.density))},o.onDeath=function(){this.leaveBody=!1,i>3&&(this.isDropPowerUp=!1,spawn.powerUpBoss(this.position.x,this.position.y,i-1),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x,y:this.velocity.y}));for(let t=0;t<powerUp.length;t++)powerUp[t].collisionFilter.mask=cat.map|cat.powerUp;for(let t=0;t<40;t++)this.colors()},o.colors=function(){const t=Vector.rotate({x:1,y:0},6.28*Math.random()),e=Vector.add(this.position,Vector.mult(t,700-500*Math.random()*Math.random())),i=["#0ae","#f55","#f7b","#0eb","#467","hsl(246,100%,77%)","#0cf","#26a"];simulation.drawList.push({x:e.x,y:e.y,radius:5+10*Math.random(),color:i[Math.floor(Math.random()*i.length)],time:17})},o.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.stroke=`hsl(0,0%,${80+25*Math.sin(.01*simulation.cycle)}%)`,this.isInvulnerable)if(this.invulnerabilityCountDown>0){this.invulnerabilityCountDown--,ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction;if(this.alive)for(let t=0;t<Math.min(powerUp.length,this.vertices.length);t++)powerUp[t].collisionFilter.mask=0,Matter.Body.setPosition(powerUp[t],this.vertices[t]),Matter.Body.setVelocity(powerUp[t],{x:0,y:0});this.seePlayerCheckByDistance(),this.attraction(),this.checkStatus(),simulation.cycle%5||this.colors()}},grower(t,e,i=15){mobs.spawn(t,e,7,i,"hsl(144, 15%, 50%)");let s=mob[mob.length-1];s.tier=1,s.isVerticesChange=!0,s.big=!1,s.accelMag=45e-5*simulation.accelScale,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.player,s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.grow()}},springer(t,e,i=20+Math.ceil(35*Math.random())){mobs.spawn(t,e,10,i,"#b386e8");let s=mob[mob.length-1];s.tier=2,s.friction=0,s.frictionAir=.006,s.lookTorque=8e-7,s.g=2e-4,s.seePlayerFreq=Math.floor(40+25*Math.random());const o=14e-5,a=5e-4;s.springTarget={x:s.position.x,y:s.position.y};const n=cons.length;cons[n]=Constraint.create({pointA:s.springTarget,bodyB:s,stiffness:o,damping:a}),Composite.add(engine.world,cons[cons.length-1]),cons[n].length=100+1.5*i,s.cons=cons[n],s.springTarget2={x:s.position.x,y:s.position.y};const r=cons.length;cons[r]=Constraint.create({pointA:s.springTarget2,bodyB:s,stiffness:o,damping:a}),Composite.add(engine.world,cons[cons.length-1]),cons[r].length=100+1.5*i,s.cons2=cons[r],s.do=function(){this.seePlayer.recall&&this.healthBar2(),this.gravity(),this.searchSpring(),this.checkStatus(),this.springAttack()},s.onDeath=function(){this.removeCons()},spawn.shield(s,t,e)},hopsploder(t,e,i=35){mobs.spawn(t,e,5,i,"rgb(33, 174, 160)");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.004),s.accelMag=.05,s.g=.0032,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.delay=100,s.randomHopFrequency=150+Math.floor(100*Math.random()),s.randomHopCD=simulation.cycle+s.randomHopFrequency,Matter.Body.rotate(s,Math.random()*Math.PI),spawn.shield(s,t,e),s.onDeath=function(){},s.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.seePlayer.recall){if(this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay;const t=(this.accelMag+this.accelMag*Math.random())*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-(.06*Math.random()+.1)*this.mass,spawn.grenade(this.position.x,this.position.y+i,this.tier,85,350,6)}}else if(this.randomHopCD<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.randomHopCD=simulation.cycle+this.randomHopFrequency,this.randomHopFrequency=Math.max(100,this.randomHopFrequency+200*(.5-Math.random()));const t=(this.accelMag+this.accelMag*Math.random())*this.mass*(.1+.3*Math.random()),e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.07*this.mass}}},hopper(t,e,i=35+Math.ceil(30*Math.random())){mobs.spawn(t,e,5,i,"rgb(0,200,180)");let s=mob[mob.length-1];s.tier=1,Matter.Body.setDensity(s,.0015),s.accelMag=.05,s.g=.0032,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.delay=120*simulation.CDScale,s.randomHopFrequency=200+Math.floor(150*Math.random()),s.randomHopCD=simulation.cycle+s.randomHopFrequency,Matter.Body.rotate(s,Math.random()*Math.PI),spawn.shield(s,t,e),s.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.seePlayer.recall){if(this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay;const t=(this.accelMag+this.accelMag*Math.random())*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-(.06*Math.random()+.1)*this.mass}}else if(this.randomHopCD<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.randomHopCD=simulation.cycle+this.randomHopFrequency,this.randomHopFrequency=Math.max(100,this.randomHopFrequency+200*(.5-Math.random()));const t=(this.accelMag+this.accelMag*Math.random())*this.mass*(.1+.3*Math.random()),e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.07*this.mass}}},hopperBaby(t,e,i=20+Math.ceil(15*Math.random())){mobs.spawn(t,e,5,i,"rgba(0, 220, 198, 1)");let s=mob[mob.length-1];s.tier=2,Matter.Body.setDensity(s,.0015),s.g=.01,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.randomHopFrequency=40+Math.floor(260*Math.random()),s.randomHopCD=simulation.cycle+s.randomHopFrequency,s.hopCount=0,s.delay=32+Math.floor(4*Math.random()),Matter.Body.rotate(s,Math.random()*Math.PI),spawn.shield(s,t,e),s.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.seePlayer.recall){if(this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length))if(this.hopCount++,this.hopCount>6){this.hopCount=0,this.cd=simulation.cycle+120;const t=.07*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.2*this.mass}else{this.cd=simulation.cycle+this.delay;const t=.04*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.08*this.mass}}else if(this.randomHopCD<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length))if(this.randomHopCD=simulation.cycle+this.randomHopFrequency,this.randomHopFrequency=Math.max(80,this.randomHopFrequency+150*(.5-Math.random())),this.hopCount++,this.hopCount>6){this.hopCount=0,this.cd=simulation.cycle+120;const t=.07*this.mass,e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.2*this.mass}else{this.cd=simulation.cycle+this.delay;const t=.04*this.mass,e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.1*this.mass}}},hopMother(t,e,i=20+Math.ceil(20*Math.random())){mobs.spawn(t,e,5,i,"rgb(50,170,200)");let s=mob[mob.length-1];s.tier=3,Matter.Body.setDensity(s,96e-5),s.accelMag=.05,s.g=.0032,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.delay=120+110*simulation.CDScale,s.randomHopFrequency=300+Math.floor(150*Math.random()),s.randomHopCD=simulation.cycle+s.randomHopFrequency,Matter.Body.rotate(s,Math.random()),spawn.shield(s,t,e),s.dropEgg=function(){if(mob.length<360){let t={x:this.position.x,y:this.position.y+.3*i};for(let e=0;e<30&&!(Matter.Query.point(map,t).length>0||Matter.Query.point(body,t).length>0);e++)t.y+=1;spawn.hopEgg(t.x,t.y-10,this.tier)}},s.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.seePlayer.recall){if(this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay;const t=(this.accelMag+this.accelMag*Math.random())*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-(.06*Math.random()+.1)*this.mass,this.dropEgg()}}else if(this.randomHopCD<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.randomHopCD=simulation.cycle+this.randomHopFrequency,this.randomHopFrequency=Math.max(100,this.randomHopFrequency+200*(.5-Math.random()));const t=(this.accelMag+this.accelMag*Math.random())*this.mass*(.1+.3*Math.random()),e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.07*this.mass,Math.random()<.2&&this.dropEgg()}}},hopEgg(t,e,i){mobs.spawn(t,e,10,9+Math.floor(3*Math.random()),"rgba(50, 150, 150,0.3)");let s=mob[mob.length-1];s.tier=i,s.stroke="transparent",Matter.Body.setDensity(s,1e-4),s.frictionAir=1,s.damageReduction=2,s.collisionFilter.mask=cat.bullet|cat.body,s.isMine=!0,s.leaveBody=!1,s.isDropPowerUp=!1,s.isBadTarget=!0,s.isMobBullet=!0,s.isUnstable=!0,s.explodeRange=210+140*Math.random(),s.isExploding=!1,s.countDown=Math.ceil(4*Math.random()),s.hatchTimer=440+Math.floor(120*Math.random()),s.isInvulnerable=!0,s.do=function(){if(this.checkStatus(),this.hatchTimer--,this.hatchTimer<1&&(spawn.hopBullet(this.position.x,this.position.y,this.tier),this.death()),Matter.Query.collides(this,[player]).length>0&&(!m.isCloak||!tech.isIntangible)&&m.immuneCycle<m.cycle&&(this.isExploding=!0),this.isExploding&&this.countDown--<0){this.death(),Vector.magnitude(Vector.sub(this.position,player.position))<this.explodeRange&&m.immuneCycle<m.cycle&&(m.takeDamage(.01*this.damageScale()*(tech.isRadioactiveResistance?.2:1)),m.energy-=.1*(tech.isRadioactiveResistance?.2:1),m.energy<0&&(m.energy=0));const t=this.explodeRange+50;for(let e=0,i=mob.length;e<i;++e)mob[e].alive&&Vector.magnitude(Vector.sub(this.position,mob[e].position))<t&&mob[e].isMine&&(mob[e].isExploding=!0);simulation.drawList.push({x:this.position.x,y:this.position.y,radius:this.explodeRange,color:"rgba(50,180,180,0.45)",time:16})}}},hopBullet(t,e,i,s=10+Math.ceil(8*Math.random())){mobs.spawn(t,e,5,s,"rgb(0,200,180)");let o=mob[mob.length-1];o.tier=i,o.stroke="transparent",o.leaveBody=!1,o.isDropPowerUp=!1,o.isMobBullet=!0,o.timeLeft=1020+Math.floor(480*Math.random()),o.isRandomMove=Math.random()<.3,o.accelMag=.01,o.g=.0015,o.frictionAir=.01,o.friction=1,o.frictionStatic=1,o.restitution=0,o.delay=100+50*simulation.CDScale,o.collisionFilter.category=cat.mobBullet,o.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,o.onHit=function(){this.explode(.5*this.mass)},o.do=function(){this.gravity(),this.checkStatus(),this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)&&(this.cd=simulation.cycle+this.delay,this.isRandomMove||Math.random()<.2?this.force.x+=(.01+.03*Math.random())*this.mass*(Math.random()<.5?1:-1):this.force.x+=(.01+.03*Math.random())*this.mass*(player.position.x>this.position.x?1:-1),this.force.y-=(.04+.04*Math.random())*this.mass),this.timeLimit()}},hopMotherBoss(t,e,i=120){mobs.spawn(t,e,5,i,"rgb(0,200,180)");let s=mob[mob.length-1];s.isBoss=!0,s.damageReduction=.15,s.accelMag=.05,s.g=.003,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.delay=130+40*simulation.CDScale,Matter.Body.rotate(s,Math.random()*Math.PI),spawn.shield(s,t,e,1),s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.do=function(){if(this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay;for(let t=0,e=1+.05*simulation.difficulty;t<e;++t)spawn.hopBullet(this.position.x+100*(Math.random()-.5),this.position.y+100*(Math.random()-.5),this.tier);this.force.x+=(.02+.06*Math.random())*this.mass*(player.position.x>this.position.x?1:-1),this.force.y-=(.08+.08*Math.random())*this.mass}}},spinner(t,e,i=30+Math.ceil(35*Math.random())){mobs.spawn(t,e,5,i,"#000000");let s=mob[mob.length-1];s.tier=2,s.fill="#28b",s.rememberFill=s.fill,s.cd=0,s.burstDir={x:0,y:0},s.frictionAir=.022,s.lookTorque=14e-7,s.restitution=0,spawn.shield(s,t,e),s.look=function(){this.seePlayer.recall&&this.healthBar2(),this.seePlayerByLookingAt(),this.checkStatus(),this.seePlayer.recall&&this.cd<simulation.cycle&&(this.burstDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),this.cd=simulation.cycle+40,this.do=this.spin)},s.do=s.look,s.spin=function(){this.seePlayer.recall&&this.healthBar2(),this.checkStatus(),this.torque+=35e-6*this.inertia;const t=2.5*this.radius+50;ctx.strokeStyle="rgba(0,0,0,0.2)",ctx.lineWidth=3,ctx.setLineDash([10,20]);const e=Vector.add(this.position,Vector.mult(this.burstDir,t));ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(e.x,e.y),ctx.stroke(),ctx.setLineDash([]),this.cd<simulation.cycle&&(this.fill=this.rememberFill,this.cd=simulation.cycle+180*simulation.CDScale,this.do=this.look,this.force=Vector.mult(this.burstDir,.25*this.mass))}},bigSucker(t,e,i=10){mobs.spawn(t,e,9,i,"#fff");let s=mob[mob.length-1];Matter.Body.setDensity(s,.009),s.tier=4,s.isVerticesChange=!0,s.big=!1,s.accelMag=5e-5*simulation.accelScale,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.player,s.eventHorizon=8*i,s.memory=300,s.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall){if(this.radius<75){const t=1.008;Matter.Body.scale(this,t,t),this.radius*=t,this.eventHorizon*=t,this.isShielded&&(this.isShielded=!1,this.removeConsBB())}}else if(this.radius>5){const t=.986;Matter.Body.scale(this,t,t),this.radius*=t,this.eventHorizon*=t}const t=this.eventHorizon;if(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.25*t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.55*t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.4)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.08)",ctx.fill(),Vector.magnitude(Vector.sub(this.position,player.position))<t){m.immuneCycle<m.cycle&&(m.energy>0&&(m.energy-=.005),m.energy<.1&&m.takeDamage(1e-4*this.damageScale()));const t=Math.atan2(player.position.y-this.position.y,player.position.x-this.position.x);player.force.x-=.00125*player.mass*Math.cos(t)*(m.onGround?1.8:1),player.force.y-=1e-4*player.mass*Math.sin(t),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineWidth=Math.min(60,2*this.radius),ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke(),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.3)",ctx.fill()}}},sucker(t,e,i=30+Math.ceil(25*Math.random())){i=9+i/8,mobs.spawn(t,e,6,i,"transparent");let s=mob[mob.length-1];s.tier=2,s.stroke="transparent",s.eventHorizon=30*i,s.seeAtDistance2=(s.eventHorizon+400)*(s.eventHorizon+400),s.accelMag=12e-5*simulation.accelScale,s.frictionAir=.025,s.collisionFilter.mask=cat.player|cat.bullet|cat.body,s.memory=1/0,Matter.Body.setDensity(s,.015),s.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.speed>5&&Matter.Body.setVelocity(this,{x:.99*this.velocity.x,y:.99*this.velocity.y}),this.seePlayerCheckByDistance(),this.checkStatus(),this.seePlayer.recall){const t=this.accelMag*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)}const t=this.eventHorizon*(.93+.17*Math.sin(.011*simulation.cycle));if(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.25*t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.9)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.55*t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,t,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.1)",ctx.fill(),Vector.magnitude(Vector.sub(this.position,player.position))<t){m.immuneCycle<m.cycle&&(m.energy>0&&(m.energy-=.005),m.energy<.1&&m.takeDamage(1e-4*this.damageScale()));const t=Math.atan2(player.position.y-this.position.y,player.position.x-this.position.x);player.force.x-=.00125*player.mass*Math.cos(t)*(m.onGround?1.8:1),player.force.y-=1e-4*player.mass*Math.sin(t),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineWidth=Math.min(60,2*this.radius),ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke(),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.3)",ctx.fill()}},level.isMobShields&&spawn.shield(s,t,e)},suckerBoss(t,e,i=25){mobs.spawn(t,e,12,i,"#000");let s=mob[mob.length-1];s.isBoss=!0,s.stroke="transparent",s.eventHorizon=1100,s.seeAtDistance2=(s.eventHorizon+3e3)*(s.eventHorizon+3e3),s.accelMag=4e-5*simulation.accelScale,s.collisionFilter.mask=cat.player|cat.bullet,s.memory=1600,Matter.Body.setDensity(s,.06),s.onDeath=function(){if(powerUps.spawnBossPowerUp(this.position.x,this.position.y),simulation.difficulty>5){function t(t,e,i){for(let s=0,o=t.length;s<o;s++)if(!t[s].isNotHoldable){const o=Vector.sub(t[s].position,e);Vector.magnitude(o)<i&&Matter.Body.setPosition(t[s],e)}}t(body,this.position,this.eventHorizon),t(mob,this.position,this.eventHorizon)}},s.damageReduction=.27,s.do=function(){if(this.speed>1&&Matter.Body.setVelocity(this,{x:.95*this.velocity.x,y:.95*this.velocity.y}),simulation.cycle%this.seePlayerFreq||(this.distanceToPlayer2()<this.seeAtDistance2?(this.locatePlayer(),this.seePlayer.yes||(this.seePlayer.yes=!0)):this.seePlayer.recall&&this.lostPlayer()),this.checkStatus(),this.seePlayer.recall){if(!(simulation.cycle%90)){spawn.seeker(this.position.x,this.position.y,this.tier,15*(.7+.5*Math.random()),7);const t=mob[mob.length-1];Matter.Body.setDensity(t,1e-5),t.timeLeft=600,t.accelMag=2e-4*simulation.accelScale,t.frictionAir=.01;const e=Vector.mult(Vector.normalise(Vector.sub(m.pos,this.position)),-20);Matter.Body.setVelocity(t,{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}const t=this.accelMag*this.mass,e=this.seePlayer.position.x-this.position.x,i=this.seePlayer.position.y-this.position.y,s=Math.sqrt(e*e+i*i);this.force.x+=t*e/s,this.force.y+=t*i/s;const o=this.eventHorizon*(1+.2*Math.sin(.008*simulation.cycle));if(ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.2*o,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.6)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.4*o,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.4)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.6*o,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.3)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,.8*o,0,2*Math.PI),ctx.fillStyle="rgba(0,20,40,0.2)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.05)",ctx.fill(),Vector.magnitude(Vector.sub(this.position,player.position))<o){m.immuneCycle<m.cycle&&(m.energy>0&&(m.energy-=.008),m.energy<.1&&m.takeDamage(15e-5*this.damageScale()));const t=Math.atan2(player.position.y-this.position.y,player.position.x-this.position.x);player.force.x-=.0013*Math.cos(t)*player.mass*(m.onGround?1.7:1),player.force.y-=.0013*Math.sin(t)*player.mass,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineWidth=Math.min(60,2*this.radius),ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke(),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.3)",ctx.fill()}this.curl(o);for(let t=0;t<powerUp.length;t++){const e=Vector.sub(this.position,powerUp[t].position),i=.0015*Math.min(1,(Vector.magnitude(e)-200)/this.eventHorizon),s=Vector.mult(Vector.normalise(e),i*powerUp[t].mass);powerUp[t].force.x+=s.x,powerUp[t].force.y+=s.y-powerUp[t].mass*simulation.g}}}},spiderBoss(t,e,i=60+Math.ceil(10*Math.random())){let s=[];mobs.spawn(t,e,6,i,"#b386e8");let o=mob[mob.length-1];o.tier=1,Matter.Body.setDensity(o,.003),o.isBoss=!0,o.damageReduction=.13,s.push(o.id),o.friction=0,o.frictionAir=.0067,o.lookTorque=8e-7,o.g=2e-4,o.seePlayerFreq=Math.floor(30+20*Math.random());const a=14e-5,n=5e-4;o.springTarget={x:o.position.x,y:o.position.y};const r=cons.length;cons[r]=Constraint.create({pointA:o.springTarget,bodyB:o,stiffness:a,damping:n}),Composite.add(engine.world,cons[cons.length-1]),cons[r].length=100+1.5*i,o.cons=cons[r],o.springTarget2={x:o.position.x,y:o.position.y};const l=cons.length;cons[l]=Constraint.create({pointA:o.springTarget2,bodyB:o,stiffness:a,damping:n,length:0}),Composite.add(engine.world,cons[cons.length-1]),cons[l].length=100+1.5*i,o.cons2=cons[l],o.do=function(){this.seePlayer.recall&&this.healthBar1(),this.gravity(),this.searchSpring(),this.checkStatus(),this.springAttack()},o.onDeath=function(){this.removeCons(),powerUps.spawnBossPowerUp(this.position.x,this.position.y)},i=22;const h=2*Math.PI/6;spawn.allowShields=!1;for(let o=0;o<6;++o)spawn.stabber(t+100*Math.sin(o*h),e+100*Math.cos(o*h),i,12),Matter.Body.setDensity(mob[mob.length-1],.003),mob[mob.length-1].damageReduction=.12,s.push(mob[mob.length-1].id);spawn.constrain2AdjacentMobs(6,.02,!0);for(let t=0;t<6;++t)consBB[consBB.length]=Constraint.create({bodyA:o,bodyB:mob[mob.length-t-1],stiffness:.02,damping:.03}),Composite.add(engine.world,consBB[consBB.length-1]);spawn.groupShield(s,t,e,100+1*i+30-25),spawn.allowShields=!0},mantisBoss(t,e,i=35,s=!0){mobs.spawn(t,e,5,i,"#6ba");let o=mob[mob.length-1];o.tier=3,o.babyList=[],Matter.Body.setDensity(o,.0015),o.damageReduction=.14,o.isBoss=!0,o.friction=0,o.frictionAir=.006,o.g=2e-4,o.seePlayerFreq=31;const a=3e-5,n=2e-4;o.springTarget={x:o.position.x,y:o.position.y};const r=cons.length;cons[r]=Constraint.create({pointA:o.springTarget,bodyB:o,stiffness:a,damping:n}),Composite.add(engine.world,cons[cons.length-1]),cons[r].length=100+1.5*i,o.cons=cons[r],o.springTarget2={x:o.position.x,y:o.position.y};const l=cons.length;cons[l]=Constraint.create({pointA:o.springTarget2,bodyB:o,stiffness:a,damping:n,length:0}),Composite.add(engine.world,cons[cons.length-1]),cons[l].length=100+1.5*i,o.cons2=cons[l],o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.invulnerabilityCountDown=0,o.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.checkStatus(),this.gravity(),ctx.beginPath(),ctx.arc(this.cons.pointA.x,this.cons.pointA.y,6,0,2*Math.PI),ctx.arc(this.cons2.pointA.x,this.cons2.pointA.y,6,0,2*Math.PI),ctx.fillStyle="#222",ctx.fill(),this.seePlayerByHistory(),this.invulnerabilityCountDown--,this.isInvulnerable){if(this.invulnerabilityCountDown>90||this.invulnerabilityCountDown%20>10){ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y);for(let t=0;t<this.babyList.length;t++)if(this.babyList[t].alive){let e=this.babyList[t].vertices;ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)ctx.lineTo(e[t].x,e[t].y);ctx.lineTo(e[0].x,e[0].y)}ctx.lineWidth=3+.2*Math.min(this.invulnerabilityCountDown,90)+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.4+.4*Math.random()})`,ctx.stroke()}if(this.invulnerabilityCountDown<0){this.invulnerabilityCountDown=110,this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction;for(let t=0;t<this.babyList.length;t++)this.babyList[t].alive&&(this.babyList[t].isInvulnerable=!1,this.babyList[t].damageReduction=this.startingDamageReduction)}}else if(this.invulnerabilityCountDown<0){this.invulnerabilityCountDown=240+5*simulation.difficulty,this.isInvulnerable=!0,this.damageReduction&&(this.startingDamageReduction=this.damageReduction),this.damageReduction=0;for(let t=0;t<this.babyList.length;t++)this.babyList[t].alive&&(this.babyList[t].isInvulnerable=!0,this.babyList[t].damageReduction=0)}if(this.seePlayer.recall&&0===Matter.Query.ray(map,this.position,this.seePlayer.position).length)if(simulation.cycle%(2*this.seePlayerFreq)){if(!(simulation.cycle%this.seePlayerFreq)){const t=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),e=Vector.add(this.position,Vector.mult(t,700));this.springTarget2.x=e.x,this.springTarget2.y=e.y,this.cons.length=100+1.5*this.radius,this.cons2.length=-200}}else{const t=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),e=Vector.add(this.position,Vector.mult(t,700));this.springTarget.x=e.x,this.springTarget.y=e.y,this.cons.length=-200,this.cons2.length=100+1.5*this.radius}else if(this.torque=this.lookTorque*this.inertia,!(simulation.cycle%this.seePlayerFreq)){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const t=3e3,e={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};best=vertexCollision(this.position,e,[map]),best.dist2!=1/0&&(this.springTarget.x=best.x,this.springTarget.y=best.y,this.cons.length=100+1.5*this.radius,this.cons2.length=100+1.5*this.radius)}},o.onDeath=function(){this.removeCons(),s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0;t<this.babyList.length;t++)this.babyList[t].alive&&(this.babyList[t].collisionFilter.mask=cat.map|cat.bullet|cat.player,this.babyList[t].isInvulnerable=!1,this.babyList[t].damageReduction=this.startingDamageReduction,this.babyList[t].collisionFilter.mask=cat.bullet|cat.player|cat.map|cat.body)};const h=2*Math.PI/3;spawn.allowShields=!1;for(let i=0;i<3;++i){spawn.striker(t+80*Math.sin(i*h),e+80*Math.cos(i*h),20,12);const s=mob[mob.length-1];o.babyList.push(s),s.fill="rgb(68, 102, 119)",s.isBoss=!0,s.damageReduction=.8*this.startingDamageReduction,s.collisionFilter.mask=cat.bullet|cat.player,s.delay=60+55*simulation.CDScale+Math.floor(20*Math.random()),s.strikeRange=400,s.onHit=function(){if(this.cd=simulation.cycle+this.delay,b.inventory.length){let t=!1;const e=3;for(let i=0;i<e;i++)for(let e=0;e<b.inventory.length;e++){const i=b.guns[b.inventory[e]];i.ammo>0&&i.ammo!==1/0&&(i.ammo-=Math.ceil((Math.random()+Math.random())*i.ammoPack),i.ammo<0&&(i.ammo=0),t=!0)}if(t){simulation.updateGunHUD();for(let t=0;t<e;t++)powerUps.directSpawn(this.position.x+10*Math.random(),this.position.y+10*Math.random(),"ammo");powerUps.ejectGraphic()}}}}const c=.01;for(let t=1;t<3;++t)consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-t],bodyB:mob[mob.length-t-1],stiffness:c,damping:.1}),Composite.add(engine.world,consBB[consBB.length-1]);consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-1],bodyB:mob[mob.length-3],stiffness:c,damping:.1}),Composite.add(engine.world,consBB[consBB.length-1]);for(let t=0;t<3;++t)consBB[consBB.length]=Constraint.create({bodyA:o,bodyB:mob[mob.length-t-1],stiffness:c,damping:.1}),Composite.add(engine.world,consBB[consBB.length-1]);spawn.allowShields=!0},beamer(t,e,i=15+Math.ceil(15*Math.random())){mobs.spawn(t,e,4,i,"rgb(255,0,190)");let s=mob[mob.length-1];s.tier=1,s.repulsionRange=73e3,s.laserRange=370,s.accelMag=5e-4*simulation.accelScale,s.frictionStatic=0,s.friction=0,spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.repulsion(),this.harmZone()}},historyBoss(t,e,i=30){mobs.spawn(t,e,0,i,"transparent");let s=mob[mob.length-1];s.tier=3,Matter.Body.setDensity(s,.21),s.laserRange=350,s.seeAtDistance2=2e6,s.isBoss=!0,s.damageReduction=.38,s.delayLimit=60+Math.floor(30*Math.random()),s.followDelay=600-Math.floor(90*Math.random()),s.stroke="transparent",s.collisionFilter.mask=cat.bullet|cat.body,s.memory=1/0,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y),requestAnimationFrame(()=>{requestAnimationFrame(()=>{ctx.setTransform(1,0,0,1,0,0),simulation.isInvertedVertical&&(ctx.translate(0,canvas.height),ctx.scale(1,-1),simulation.isInvertedVertical=!0,mouseMove.reset()),ctx.setLineDash([])})})},s.warpIntensity=0,s.awake=function(){this.seePlayer.recall&&this.healthBar3(),this.checkStatus();const t=.3*this.radius,e=2*this.radius,i=this.position.x-e/2,s=this.position.y-.7*e;ctx.fillStyle="rgba(100, 100, 100, 0.3)",ctx.fillRect(i,s,e,t),ctx.fillStyle="rgba(150,0,255,0.7)",ctx.fillRect(i,s,e*this.health,t);const o=Vector.normalise(Vector.sub(m.pos,this.position)),a=Vector.add(Vector.mult(o,15),this.position);ctx.beginPath(),ctx.arc(a.x,a.y,4,0,2*Math.PI),ctx.moveTo(this.position.x+20*o.x,this.position.y+20*o.y),ctx.lineTo(this.position.x+30*o.x,this.position.y+30*o.y),ctx.strokeStyle=this.stroke,ctx.lineWidth=2,ctx.stroke(),ctx.setLineDash([125*Math.random(),125*Math.random()]),this.distanceToPlayer()<this.laserRange?(m.immuneCycle<m.cycle&&(m.energy>.002?m.energy-=.004:m.takeDamage(4e-4*this.damageScale())),this.warpIntensity+=4e-4,requestAnimationFrame(()=>{!simulation.paused&&m.alive&&ctx.transform(1,this.warpIntensity*(Math.random()-.5),this.warpIntensity*(Math.random()-.5),1,0,0)}),ctx.beginPath(),ctx.moveTo(a.x,a.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineTo(m.pos.x+3e3*(Math.random()-.5),m.pos.y+3e3*(Math.random()-.5)),ctx.lineWidth=2,ctx.strokeStyle="rgb(150,0,255)",ctx.stroke(),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(150,0,255,0.1)",ctx.fill()):this.warpIntensity=0;const n=.015*simulation.cycle,r=.021*simulation.cycle;ctx.lineWidth=1,ctx.fillStyle="rgba(150,0,255,0.05)",ctx.strokeStyle="#70f";for(let t=0,e=6;t<e;t++)ctx.beginPath(),ctx.ellipse(this.position.x,this.position.y,this.laserRange*Math.abs(Math.sin(r+t/e*Math.PI)),this.laserRange,n,0,2*Math.PI),ctx.fill(),ctx.stroke();if(!this.isStunned&&!this.isSlowed){this.followDelay>this.delayLimit&&(this.followDelay-=.15);let t=m.history[(simulation.cycle-Math.floor(this.followDelay))%600];Matter.Body.setPosition(this,{x:t.position.x,y:t.position.y-t.yOff+24.2859})}},s.do=function(){(this.seePlayer.recall||!(simulation.cycle%this.seePlayerFreq)&&this.distanceToPlayer2()<this.seeAtDistance2&&!m.isCloak)&&setTimeout(()=>{this.do=this.awake,this.stroke="rgba(205,0,255,0.5)",this.fill="rgba(205,0,255,0.1)",this.seePlayer.yes=!0},2e3),this.checkStatus()}},focuser(t,e,i=30+Math.ceil(10*Math.random())){i=Math.ceil(.7*i),mobs.spawn(t,e,4,i,"rgb(0,0,255)");let s=mob[mob.length-1];s.tier=2,Matter.Body.setDensity(s,.003),s.restitution=0,s.laserPos=s.position,s.repulsionRange=12e5,s.accelMag=9e-5*simulation.accelScale,s.frictionStatic=0,s.friction=0,s.onDamage=function(){this.laserPos=this.position},spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar2(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction();const t=this.distanceToPlayer2();if(this.seePlayer.yes&&t<4e6){const t=2e3;this.laserPos=Vector.add(this.laserPos,Vector.mult(Vector.sub(player.position,this.laserPos),.03));let e=Vector.magnitude(Vector.sub(this.laserPos,m.pos));const i=12;if(ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),e<i+16)e=i+10,m.immuneCycle<m.cycle&&(m.takeDamage(3e-4*this.damageScale()),m.energy>.1&&(m.energy-=.003)),ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(m.pos.x,m.pos.y),ctx.lineTo(m.pos.x+3e3*(Math.random()-.5),m.pos.y+3e3*(Math.random()-.5)),ctx.lineWidth=2,ctx.strokeStyle="rgb(0,0,255)",ctx.setLineDash([125*Math.random(),125*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,40,0,2*Math.PI),ctx.fillStyle="rgba(0,0,255,0.1)",ctx.fill();else{const s=5e-4;let o=Vector.rotateAbout(this.laserPos,(e-i)*s,this.position),a=Vector.normalise(Vector.sub(o,this.position));o=Vector.add(o,Vector.mult(a,t)),ctx.lineTo(o.x,o.y);let n=Vector.rotateAbout(this.laserPos,(e-i)*-s,this.position);a=Vector.normalise(Vector.sub(n,this.position)),n=Vector.add(n,Vector.mult(a,t)),ctx.lineTo(n.x,n.y),ctx.fillStyle=`rgba(0,0,255,${Math.max(0,.6*i/e)})`,ctx.fill()}}else this.laserPos=this.position}},flutter(t,e,i=20+6*Math.random()){mobs.spawn(t,e,7,i,"#16576b");let s=mob[mob.length-1];s.tier=1,Matter.Body.setDensity(s,.002),s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),Matter.Body.rotate(s,Math.random()*Math.PI*2),s.accelMag=6e-4+7e-4*Math.sqrt(simulation.accelScale),s.frictionAir=.04,s.memory=240,s.restitution=1,s.frictionStatic=0,s.friction=0,s.fireDir={x:0,y:0},spawn.shield(s,t,e),s.flapRate=.3+Math.floor(3*Math.random())/10+100*s.accelMag,s.flapRadius=75+3*i,s.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.seePlayerByHistory(),this.checkStatus(),this.seePlayer.recall){if(this.force.x+=Math.cos(this.angle)*this.accelMag*this.mass,this.force.y+=Math.sin(this.angle)*this.accelMag*this.mass,!(simulation.cycle%this.seePlayerFreq)){this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position));const t=(t,e)=>t-Math.floor(t/e)*e,e=Vector.sub(m.pos,this.position),i=t(Math.atan2(e.y,e.x)-this.angle+Math.PI,2*Math.PI)-Math.PI;Math.abs(i)>2.8&&(this.torque+=2e-4*this.inertia*Math.random())}const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.4,i=25e-6*this.inertia;c>e?this.torque+=i:c<-e&&(this.torque-=i);const s=.7;ctx.fillStyle=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.2)`,this.wing(this.angle+Math.PI/2+s*Math.sin(simulation.cycle*this.flapRate),this.flapRadius),this.wing(this.angle-Math.PI/2-s*Math.sin(simulation.cycle*this.flapRate),this.flapRadius)}}},stinger(t,e,i=18+4*Math.random()){const s="#5bc";mobs.spawn(t,e,7,i,s);let o=mob[mob.length-1];o.tier=3,Matter.Body.setDensity(o,.0036),o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.accelMag=.0022+5e-4*Math.sqrt(simulation.accelScale),o.frictionAir=.03,o.memory=240,o.restitution=1,o.frictionStatic=0,o.friction=0,o.fireDir={x:0,y:0},spawn.shield(o,t,e),o.flapRate=.06+.03*Math.random(),o.flapRadius=40+3*i,o.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerByHistory(),this.checkStatus(),this.seePlayer.recall){if(this.force.x+=Math.cos(this.angle)*this.accelMag*this.mass,this.force.y+=Math.sin(this.angle)*this.accelMag*this.mass,!(simulation.cycle%this.seePlayerFreq)){this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position));const t=(t,e)=>t-Math.floor(t/e)*e,e=Vector.sub(m.pos,this.position),i=t(Math.atan2(e.y,e.x)-this.angle+Math.PI,2*Math.PI)-Math.PI;Math.abs(i)>2.8&&(this.torque+=2e-4*this.inertia*Math.random())}const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.4,i=2e-5*this.inertia;c>e?this.torque+=i:c<-e&&(this.torque-=i),this.frictionAir=.11+.09*Math.sin(simulation.cycle*this.flapRate-Math.PI/2);const o=.8;if(ctx.fillStyle=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.2)`,this.wing(this.angle+2.1+o*Math.sin(simulation.cycle*this.flapRate),this.flapRadius,.0015),this.wing(this.angle-2.1-o*Math.sin(simulation.cycle*this.flapRate),this.flapRadius,.0015),this.distanceToPlayer()<2e3){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const t=400-100*Math.random(),e={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(best=vertexCollision(this.position,e,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle){const t=.003*this.damageScale();m.takeDamage(t),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(best.x,best.y,5+1500*t,0,2*Math.PI),ctx.fill()}const i=3;best.dist2===1/0&&(best=e),ctx.beginPath(),ctx.moveTo(this.vertices[i].x,this.vertices[i].y),ctx.lineTo(best.x,best.y),ctx.strokeStyle=s,ctx.lineWidth=2,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([])}}}},stingWinger(t,e,i=18+4*Math.random()){mobs.spawn(t,e,14,i,"rgb(0, 76, 89)");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.005),s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.accelMag=.0025,s.frictionAir=.03,s.memory=240,s.restitution=.1,s.frictionStatic=0,s.friction=0,s.fireDir={x:0,y:0},spawn.shield(s,t,e),s.flapRate=.06+.03*Math.random(),s.flapArc=.25,s.wingLength=150,s.ellipticity=.2,s.angleOff=.4,s.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.seePlayerByHistory(),this.checkStatus(),this.seePlayer.recall){if(this.force.x+=Math.cos(this.angle)*this.accelMag*this.mass,this.force.y+=Math.sin(this.angle)*this.accelMag*this.mass,!(simulation.cycle%this.seePlayerFreq)){this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position));const t=(t,e)=>t-Math.floor(t/e)*e,e=Vector.sub(m.pos,this.position),i=t(Math.atan2(e.y,e.x)-this.angle+Math.PI,2*Math.PI)-Math.PI;Math.abs(i)>2.8&&(this.torque+=2e-4*this.inertia*Math.random())}const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.4,i=2e-5*this.inertia;c>e?this.torque+=i:c<-e&&(this.torque-=i),this.frictionAir=.08+.09*Math.sin(simulation.cycle*this.flapRate-Math.PI/2);let s=Math.atan2(this.velocity.y,this.velocity.x);const o=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.9)`;if(ctx.fillStyle=o,this.wing(s+Math.PI/2+this.angleOff+this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity,.003),this.wing(s-Math.PI/2-this.angleOff-this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity,.003),this.wing(s-Math.PI/2+this.angleOff+this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity,.003),this.wing(s+Math.PI/2-this.angleOff-this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity,.003),this.distanceToPlayer()<3e3){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const t=500-50*Math.random(),e={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(best=vertexCollision(this.position,e,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle){const t=.005*this.damageScale();m.takeDamage(t),ctx.beginPath(),ctx.arc(best.x,best.y,5+1500*t,0,2*Math.PI),ctx.fill()}const i=7;if(best.dist2===1/0&&(best=e),ctx.beginPath(),ctx.moveTo(this.vertices[i].x,this.vertices[i].y),ctx.lineTo(best.x,best.y),ctx.strokeStyle=o,ctx.lineWidth=4,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),!(simulation.cycle%30)){const t=Vector.sub(best,this.position),e=Vector.magnitude(t),i=Vector.mult(Vector.normalise(t),e*Math.random()),s=Vector.add(i,this.position);simulation.drawList.push({x:s.x,y:s.y,radius:5,color:o,time:20})}}}}},beetleBoss(t,e,i=50){mobs.spawn(t,e,7,i,"#16576b");let s=mob[mob.length-1];s.tier=3,s.isBoss=!0,Matter.Body.setDensity(s,.005),s.damageReduction=.08,s.startingDamageReduction=s.damageReduction,s.isInvulnerable=!1,s.nextHealthThreshold=.75,s.invulnerableCount=0,s.flapRate=.2,s.wingSize=0,s.wingGoal=250+simulation.difficulty,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),Matter.Body.rotate(s,Math.random()*Math.PI*2),s.accelMag=45e-5+5e-4*Math.sqrt(simulation.accelScale),s.frictionAir=.05,s.seePlayerFreq=13,s.memory=420,s.restitution=1,s.frictionStatic=0,s.friction=0,s.fireDir={x:0,y:0},spawn.shield(s,t,e),s.pushAway=function(t=.13,e=.05){for(let i=0,s=body.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(body[i].position,this.position))<4e6&&(body[i].force.x+=t*body[i].mass*(body[i].position.x>this.position.x?1:-1),body[i].force.y-=e*body[i].mass);for(let i=0,s=bullet.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(bullet[i].position,this.position))<4e6&&(bullet[i].force.x+=t*bullet[i].mass*(bullet[i].position.x>this.position.x?1:-1),bullet[i].force.y-=e*bullet[i].mass);for(let i=0,s=powerUp.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(powerUp[i].position,this.position))<4e6&&(powerUp[i].force.x+=t*powerUp[i].mass*(powerUp[i].position.x>this.position.x?1:-1),powerUp[i].force.y-=e*powerUp[i].mass);Vector.magnitudeSquared(Vector.sub(player.position,this.position))<4e6&&(player.force.x+=t*player.mass*(player.position.x>this.position.x?1:-1),player.force.y-=e*player.mass)},s.babies=function(t){const e=Math.max(3,Math.floor(15-t/2));let s=0,o=()=>{if(s<t){if(!(simulation.cycle%e)&&!simulation.paused&&!simulation.isChoosing&&m.alive){const t=Vector.normalise(Vector.sub(player.position,this.position)),e=Vector.mult(t,10+10*Math.random()),o=Vector.add(this.position,Vector.mult(t,1.2*i));spawn.allowShields=!1,spawn.flutter(o.x,o.y,Math.floor(7+8*Math.random()));const a=mob[mob.length-1];Matter.Body.setDensity(a,.01),Matter.Body.setVelocity(a,e),Matter.Body.setAngle(a,Math.atan2(e.y,e.x)),this.alertNearByMobs(),spawn.allowShields=!0,s++}requestAnimationFrame(o)}};requestAnimationFrame(o)},s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y),s.babies(.05*simulation.difficulty+1)},s.onDamage=function(){this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=90+Math.floor(30*Math.random()),this.isInvulnerable=!0,this.damageReduction=0,this.frictionAir=0,this.wingGoal=0,this.wingSize=0,this.flapRate+=.13,this.accelMag*=1.4)},s.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerByHistory(50),this.checkStatus(),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.frictionAir=.05,this.wingGoal=250,this.pushAway(.13*Math.sqrt(this.flapRate),.06*Math.sqrt(this.flapRate)),s.babies(.05*simulation.difficulty+1)),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else if(this.seePlayer.recall){if(this.force.x+=Math.cos(this.angle)*this.accelMag*this.mass,this.force.y+=Math.sin(this.angle)*this.accelMag*this.mass,!(simulation.cycle%this.seePlayerFreq)){this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position));const t=(t,e)=>t-Math.floor(t/e)*e,e=Vector.sub(m.pos,this.position),i=t(Math.atan2(e.y,e.x)-this.angle+Math.PI,2*Math.PI)-Math.PI;Math.abs(i)>2.8&&(this.torque+=2e-4*this.inertia*Math.random())}const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.4,i=3e-5*this.inertia;c>e?this.torque+=i:c<-e&&(this.torque-=i);const s=.7;this.wingSize=.97*this.wingSize+.03*this.wingGoal,ctx.fillStyle=this.fill=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.9)`,this.wing(this.angle+Math.PI/2+s*Math.sin(simulation.cycle*this.flapRate),this.wingSize,.5,.0012),this.wing(this.angle-Math.PI/2-s*Math.sin(simulation.cycle*this.flapRate),this.wingSize,.5,.0012)}else this.wingSize=.96*this.wingSize+0}},stagBeetleBoss(t,e,i=60){const s="#000";mobs.spawn(t,e,15,i,"#000");let o=mob[mob.length-1];o.tier=4,o.isBoss=!0,Matter.Body.setDensity(o,.006),o.damageReduction=.08,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.8,o.invulnerableCount=0,o.flapRate=.4,o.wingSize=0,o.wingGoal=150,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),o.accelMag=.0014,o.frictionAir=.02,o.seePlayerFreq=13,o.memory=420,o.restitution=1,o.frictionStatic=0,o.friction=0,o.fireDir={x:0,y:0},o.pushAway=function(t=.13,e=.05){for(let i=0,s=body.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(body[i].position,this.position))<4e6&&(body[i].force.x+=t*body[i].mass*(body[i].position.x>this.position.x?1:-1),body[i].force.y-=e*body[i].mass);for(let i=0,s=bullet.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(bullet[i].position,this.position))<4e6&&(bullet[i].force.x+=t*bullet[i].mass*(bullet[i].position.x>this.position.x?1:-1),bullet[i].force.y-=e*bullet[i].mass);for(let i=0,s=powerUp.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(powerUp[i].position,this.position))<4e6&&(powerUp[i].force.x+=t*powerUp[i].mass*(powerUp[i].position.x>this.position.x?1:-1),powerUp[i].force.y-=e*powerUp[i].mass);Vector.magnitudeSquared(Vector.sub(player.position,this.position))<4e6&&(player.force.x+=t*player.mass*(player.position.x>this.position.x?1:-1),player.force.y-=e*player.mass)},o.babies=function(t){const e=Math.max(3,Math.floor(15-t/2));let s=0,o=()=>{if(s<t){if(!(simulation.cycle%e)&&!simulation.paused&&!simulation.isChoosing&&m.alive){const t=Vector.normalise(Vector.sub(player.position,this.position)),e=Vector.mult(t,10+10*Math.random()),o=Vector.add(this.position,Vector.mult(t,1.2*i));spawn.allowShields=!1,spawn.stinger(o.x,o.y,Math.floor(7+8*Math.random()));const a=mob[mob.length-1];Matter.Body.setDensity(a,.01),Matter.Body.setVelocity(a,e),Matter.Body.setAngle(a,Math.atan2(e.y,e.x)),this.alertNearByMobs(),spawn.allowShields=!0,s++}requestAnimationFrame(o)}};requestAnimationFrame(o)},o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y),o.babies(.05*simulation.difficulty+1)},o.onDamage=function(){this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=40,this.isInvulnerable=!0,this.damageReduction=0,this.frictionAir=0,this.wingGoal=0,this.wingSize=0,this.flapRate+=.1,this.accelMag*=1.2)},o.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.seePlayerByHistory(50),this.checkStatus(),ctx.fillStyle=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.7)`,this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.frictionAir=.05,this.wingGoal=150,this.pushAway(.13*Math.sqrt(this.flapRate),.06*Math.sqrt(this.flapRate)),o.babies(.05*simulation.difficulty+1)),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else if(this.seePlayer.recall){if(this.force.x+=Math.cos(this.angle)*this.accelMag*this.mass,this.force.y+=Math.sin(this.angle)*this.accelMag*this.mass,!(simulation.cycle%this.seePlayerFreq)){this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position));const t=(t,e)=>t-Math.floor(t/e)*e,e=Vector.sub(m.pos,this.position),i=t(Math.atan2(e.y,e.x)-this.angle+Math.PI,2*Math.PI)-Math.PI;Math.abs(i)>2.8&&(this.torque+=2e-4*this.inertia*Math.random())}const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.1,i=5e-6*this.inertia;c>e?this.torque+=i:c<-e&&(this.torque-=i);const s=.7;this.wingSize=.97*this.wingSize+.03*this.wingGoal,this.wing(this.angle+Math.PI/2+s*Math.sin(simulation.cycle*this.flapRate),this.wingSize,.5,.0012),this.wing(this.angle-Math.PI/2-s*Math.sin(simulation.cycle*this.flapRate),this.wingSize,.5,.0012)}else this.wingSize=.96*this.wingSize+0;if(this.distanceToPlayer()<3e3){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const t=500-50*Math.random(),e={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(best=vertexCollision(this.position,e,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle){const t=.004*this.damageScale();m.takeDamage(t),ctx.beginPath(),ctx.arc(best.x,best.y,5+1500*t,0,2*Math.PI),ctx.fill()}const i=7;if(best.dist2===1/0&&(best=e),ctx.beginPath(),ctx.moveTo(this.vertices[i].x,this.vertices[i].y),ctx.lineTo(best.x,best.y),ctx.strokeStyle=s,ctx.lineWidth=4,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),!(simulation.cycle%10)){const t=Vector.sub(best,this.position),e=Vector.magnitude(t),i=Vector.mult(Vector.normalise(t),e*Math.random()),o=Vector.add(i,this.position);simulation.drawList.push({x:o.x,y:o.y,radius:5,color:s,time:20})}}ctx.beginPath();const t={x:Math.cos(this.angle),y:Math.sin(this.angle)},e=Vector.add(this.position,Vector.mult(t,30));ctx.arc(e.x,e.y,10,0,2*Math.PI),ctx.fill()}},laserTargetingBoss(t,e,i=80){const s="#07f";mobs.spawn(t,e,3,i,s);let o=mob[mob.length-1];o.tier=2,o.isBoss=!0,Matter.Body.setDensity(o,.004),o.damageReduction=.12,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.accelMag=18e-5*Math.sqrt(simulation.accelScale),o.seePlayerFreq=30,o.memory=420,o.restitution=1,o.frictionAir=.01,o.frictionStatic=0,o.friction=0,o.lookTorque=1e-6*(Math.random()>.5?-1:1),o.fireDir={x:0,y:0},spawn.shield(o,t,e,1);for(let t=0,e=2+.3*Math.sqrt(simulation.difficulty);t<e;t++)spawn.spawnOrbitals(o,i+40+10*t,1);o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.laserInterval=100,o.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.4;if(c>e?this.torque+=4e-6*this.inertia:c<-e&&(this.torque-=4e-6*this.inertia),simulation.cycle%this.laserInterval>this.laserInterval/2){const t=8e3;best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const e={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(best=vertexCollision(this.position,e,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle){const t=.006*this.damageScale();m.takeDamage(t),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(best.x,best.y,1500*t,0,2*Math.PI),ctx.fill()}best.dist2===1/0&&(best=e),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(best.x,best.y),ctx.strokeStyle=s,ctx.lineWidth=3,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+.3*(this.laserInterval-simulation.cycle%this.laserInterval),0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}else ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+simulation.cycle%this.laserInterval*.3,0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}}},laserBombingBoss(t,e,i=80){mobs.spawn(t,e,3,i,"rgb(0,235,255)");let s=mob[mob.length-1];s.tier=3,s.isBoss=!0,s.damageReduction=.27,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),Matter.Body.rotate(s,Math.random()*Math.PI*2),s.accelMag=55e-5*Math.sqrt(simulation.accelScale),s.seePlayerFreq=30,s.memory=420,s.restitution=1,s.frictionAir=.05,s.frictionStatic=0,s.friction=0,s.lookTorque=55e-7*(Math.random()>.5?-1:1)*(1+.1*Math.sqrt(simulation.difficulty)),s.fireDir={x:0,y:0},Matter.Body.setDensity(s,.01),spawn.shield(s,t,e,1),spawn.spawnOrbitals(s,i+200+300*Math.random()),s.onHit=function(){},s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.targetingCount=0,s.targetingTime=60-Math.min(58,3*simulation.difficulty),s.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const t=this.angle+Math.PI/2;c=Math.cos(t)*this.fireDir.x+Math.sin(t)*this.fireDir.y;const e=.02;c>e?this.torque+=4e-6*this.inertia:c<-e&&(this.torque-=4e-6*this.inertia);const i=8e3;best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const s={x:this.position.x+i*Math.cos(this.angle),y:this.position.y+i*Math.sin(this.angle)};if(best=vertexCollision(this.position,s,m.isCloak?[map]:[map,[playerBody,playerHead]]),best.who===playerBody||best.who===playerHead){if(this.targetingCount++,this.targetingCount>this.targetingTime){this.targetingCount-=10;const t=Vector.sub(player.position,this.position),e=Vector.magnitude(t),i=Math.min(55,5+20*simulation.accelScale),s=Vector.mult(Vector.normalise(t),i);spawn.grenade(this.vertices[1].x,this.vertices[1].y,this.tier,e/i,Math.min(550,250+3*simulation.difficulty),6),Matter.Body.setVelocity(mob[mob.length-1],s)}}else this.targetingCount>0&&this.targetingCount--;best.dist2===1/0&&(best=s),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(0,235,255,1)",ctx.lineWidth=3,ctx.stroke(),this.targetingCount/this.targetingTime>.33&&(ctx.strokeStyle="rgba(0,235,255,0.45)",ctx.lineWidth=10,ctx.stroke(),this.targetingCount/this.targetingTime>.66&&(ctx.strokeStyle="rgba(0,235,255,0.25)",ctx.lineWidth=30,ctx.stroke()))}}},blinkBoss(t,e){mobs.spawn(t,e,5,50,"rgb(0,235,255)");let i=mob[mob.length-1];i.tier=2,Matter.Body.rotate(i,.1*Math.PI),Matter.Body.setDensity(i,.002),i.isBoss=!0,i.damageReduction=.038,i.frictionStatic=0,i.friction=0,i.memory=240,i.seePlayerFreq=55,i.blinkRange=250,.5<Math.random()?(i.grenadeDelay=260,i.blinkRange*=1.5):i.grenadeDelay=100,i.pulseRadius=1.5*Math.min(550,200+2*simulation.difficulty),i.delay=55+35*simulation.CDScale,i.nextBlinkCycle=i.delay,spawn.shield(i,t,e,1),i.onDamage=function(){},i.onDeath=function(){const t=Math.PI*Math.random();for(let e=0,i=3;e<i;e++){spawn.grenade(this.position.x,this.position.y,this.tier,this.grenadeDelay);const s=mob[mob.length-1],o=5*simulation.accelScale,a=2*Math.PI*e/i+t;Matter.Body.setVelocity(s,{x:o*Math.cos(a),y:o*Math.sin(a)})}powerUps.spawnBossPowerUp(this.position.x,this.position.y)},i.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.seePlayerByHistory(40),this.nextBlinkCycle<simulation.cycle&&this.seePlayer.yes){this.nextBlinkCycle=simulation.cycle+this.delay;const t=Vector.sub(this.seePlayer.position,this.position),e=Vector.magnitude(t);ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),e<this.blinkRange?Matter.Body.setPosition(this,this.seePlayer.position):Matter.Body.translate(this,Vector.mult(Vector.normalise(t),this.blinkRange)),spawn.grenade(this.position.x,this.position.y,this.tier,this.grenadeDelay,this.pulseRadius),ctx.lineTo(this.position.x,this.position.y),ctx.lineWidth=2.1*this.radius,ctx.strokeStyle=this.fill,ctx.stroke(),Matter.Body.setVelocity(this,{x:0,y:0}),this.torque+=(4e-5+3e-5*Math.random())*this.inertia*(2*Math.round(Math.random())-1)}this.checkStatus()}},snakeBoss(t,e){mobs.spawn(t,e,0,15,"rgba(255,0,200)");let i=mob[mob.length-1];i.tier=1,i.stroke="transparent",i.isUnblockable=!0,Matter.Body.setDensity(i,.06),i.isBoss=!0,i.damageReduction=.5,i.startingDamageReduction=i.damageReduction,i.isInvulnerable=!1,i.nextHealthThreshold=.75,i.invulnerableCount=0,i.history=[];for(let t=0;t<20;t++)i.history.push({x:i.position.x+t,y:i.position.y});i.frictionStatic=0,i.friction=0,i.memory=900,i.seePlayerFreq=41,i.delay=3+2*simulation.CDScale,i.nextBlinkCycle=i.delay,i.JumpDistance=0,i.collisionFilter.mask=cat.bullet|cat.map,i.powerUpNames=[],i.redMode=function(){this.color="rgba(255,0,200,",this.fill=this.color+"1)",this.JumpDistance=13;let t=()=>{if(this.radius<25&&(m.alive&&20===this.JumpDistance&&requestAnimationFrame(t),!simulation.paused&&!simulation.isChoosing)){const t=1.01;Matter.Body.scale(this,t,t),this.radius*=t}};requestAnimationFrame(t)},i.redMode(),i.blueMode=function(){this.color="rgba(0,0,255,",this.fill=this.color+"1)",this.JumpDistance=30;let t=()=>{if(this.radius>14&&(m.alive&&37===this.JumpDistance&&requestAnimationFrame(t),!simulation.paused&&!simulation.isChoosing)){const t=.96;Matter.Body.scale(this,t,t),this.radius*=t}};requestAnimationFrame(t)},i.onDamage=function(){if(this.health<this.nextHealthThreshold){if(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=200,this.isInvulnerable=!0,this.damageReduction=0,this.history.length<200)for(let t=0;t<9;t++)this.history.unshift(this.history[0]);this.blueMode()}},i.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);let t=0,e=()=>{if(t<this.powerUpNames.length&&(m.alive&&requestAnimationFrame(e),!simulation.paused&&!simulation.isChoosing&&powerUp.length<300)){const e=Math.floor(Math.random()*this.history.length),i={x:this.history[e].x+25*(Math.random()-.5),y:this.history[e].y+25*(Math.random()-.5)};powerUps.spawn(i.x,i.y,this.powerUpNames[t]),t++}};requestAnimationFrame(e)},i.do=function(){this.seePlayer.recall&&this.healthBar1();const t=this.color+(.35+.25*Math.random())+")";if(m.immuneCycle<m.cycle)for(let e=0;e<this.history.length-1;e++)if(Matter.Query.ray([player],this.history[e],this.history[e+1],10).length>0){m.immuneCycle=m.cycle+m.collisionImmuneCycles+60;const e=.15*this.damageScale();m.takeDamage(e),simulation.drawList.push({x:m.pos.x,y:m.pos.y,radius:1500*e,color:t,time:20});for(let t=0,e=this.history.length;t<e;t++)this.history[t]={x:this.position.x,y:this.position.y};break}if(this.nextBlinkCycle<simulation.cycle){this.nextBlinkCycle=simulation.cycle+this.delay,(this.isSlowed||this.isStunned)&&(this.nextBlinkCycle+=this.delay);let t=(t=this.seePlayer.position)=>{const e=Vector.sub(t,this.position);this.force={x:0,y:0},Matter.Body.translate(this,Vector.mult(Vector.normalise(e),this.JumpDistance)),Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0),this.history.push({x:this.position.x,y:this.position.y}),this.history.shift()},e={dist:1/0,targetPos:null,index:null};for(let t=0;t<powerUp.length;t++)if(0===Matter.Query.ray(map,this.position,powerUp[t].position).length){const i=Vector.magnitude(Vector.sub(this.position,powerUp[t].position));i<e.dist&&(e={dist:i,target:powerUp[t],index:t})}if(e.dist<3e3){if(t(e.target.position),e.dist<this.JumpDistance+2*this.radius){if(this.powerUpNames.push(e.target.name),Matter.Composite.remove(engine.world,e.target),powerUp.splice(e.index,1),this.health=1,this.history.length<200)for(let t=0;t<4;t++)this.history.unshift(this.history[0]);ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(e.target.position.x,e.target.position.y),ctx.strokeStyle="#000",ctx.lineWidth=4,ctx.stroke()}}else if(0!==Matter.Query.ray(map,this.position,this.playerPosRandomY()).length||m.isCloak)if(this.seePlayer.recall)if(this.lostPlayer(),m.isCloak)t(this.seePlayer.position);else for(let e=0;e<55;e++){let i=m.history[(simulation.cycle-10*e)%600];if(0===Matter.Query.ray(map,this.position,i.position).length){t(i.position);break}}else Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0);else this.seePlayer.yes=!0,this.locatePlayer(),this.seePlayer.yes||(this.seePlayer.yes=!0),t()}if(this.checkStatus(),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.redMode()),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}ctx.beginPath();for(let t=0,e=this.history.length;t<e;t++)ctx.lineTo(this.history[t].x,this.history[t].y);ctx.lineWidth=2*this.radius,ctx.strokeStyle=t,ctx.stroke()}},kingSnakeBoss(t,e){mobs.spawn(t,e,0,35,"rgba(255,255,255)");let i=mob[mob.length-1];i.tier=4,i.stroke="transparent",i.isUnblockable=!0,Matter.Body.setDensity(i,.08),i.isBoss=!0,i.damageReduction=.4,i.startingDamageReduction=i.damageReduction,i.isInvulnerable=!1,i.nextHealthThreshold=.8,i.invulnerableCount=0,i.history=[];for(let t=0;t<20;t++)i.history.push({x:i.position.x+t,y:i.position.y});i.frictionStatic=0,i.friction=0,i.memory=900,i.seePlayerFreq=41,i.delay=3+2*simulation.CDScale,i.nextBlinkCycle=i.delay,i.JumpDistance=0,i.collisionFilter.mask=cat.bullet|cat.map,i.powerUpNames=[],i.redMode=function(){this.color="rgba(255,255,0,",this.fill=this.color+"1)",this.JumpDistance=12;let t=()=>{if(this.radius<25&&(m.alive&&20===this.JumpDistance&&requestAnimationFrame(t),!simulation.paused&&!simulation.isChoosing)){const t=1.01;Matter.Body.scale(this,t,t),this.radius*=t}};requestAnimationFrame(t)},i.redMode(),i.blueMode=function(){this.color="rgba(255,0,0,",this.fill=this.color+"1)",this.JumpDistance=33;let t=()=>{if(this.radius>14&&(m.alive&&37===this.JumpDistance&&requestAnimationFrame(t),!simulation.paused&&!simulation.isChoosing)){const t=.96;Matter.Body.scale(this,t,t),this.radius*=t}};requestAnimationFrame(t)},i.onDamage=function(){if(this.health<this.nextHealthThreshold){if(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=170,this.isInvulnerable=!0,this.damageReduction=0,this.history.length<200)for(let t=0;t<10;t++)this.history.unshift(this.history[0]);this.blueMode()}},i.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);let t=0,e=()=>{if(t<this.powerUpNames.length&&(m.alive&&requestAnimationFrame(e),!simulation.paused&&!simulation.isChoosing&&powerUp.length<300)){const e=Math.floor(Math.random()*this.history.length),i={x:this.history[e].x+25*(Math.random()-.5),y:this.history[e].y+25*(Math.random()-.5)};powerUps.spawn(i.x,i.y,this.powerUpNames[t]),t++}};requestAnimationFrame(e)},i.do=function(){this.seePlayer.recall&&this.healthBar4();const t=this.color+(.35+.25*Math.random())+")";if(m.immuneCycle<m.cycle)for(let e=0;e<this.history.length-1;e++)if(Matter.Query.ray([player],this.history[e],this.history[e+1],10).length>0){m.immuneCycle=m.cycle+m.collisionImmuneCycles+60;const e=.15*this.damageScale();m.takeDamage(e),simulation.drawList.push({x:m.pos.x,y:m.pos.y,radius:1500*e,color:t,time:20});for(let t=0,e=this.history.length;t<e;t++)this.history[t]={x:this.position.x,y:this.position.y};break}if(this.nextBlinkCycle<simulation.cycle){this.nextBlinkCycle=simulation.cycle+this.delay,(this.isSlowed||this.isStunned)&&(this.nextBlinkCycle+=this.delay);let t=(t=this.seePlayer.position)=>{const e=Vector.sub(t,this.position);this.force={x:0,y:0},Matter.Body.translate(this,Vector.mult(Vector.normalise(e),this.JumpDistance)),Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0),this.history.push({x:this.position.x,y:this.position.y}),this.history.shift()},e={dist:1/0,targetPos:null,index:null};for(let t=0;t<powerUp.length;t++)if(0===Matter.Query.ray(map,this.position,powerUp[t].position).length){const i=Vector.magnitude(Vector.sub(this.position,powerUp[t].position));i<e.dist&&(e={dist:i,target:powerUp[t],index:t})}if(e.dist<3e3){if(t(e.target.position),e.dist<this.JumpDistance+2*this.radius){if(this.powerUpNames.push(e.target.name),Matter.Composite.remove(engine.world,e.target),powerUp.splice(e.index,1),this.health=1,this.history.length<200)for(let t=0;t<4;t++)this.history.unshift(this.history[0]);ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(e.target.position.x,e.target.position.y),ctx.strokeStyle="#000",ctx.lineWidth=4,ctx.stroke()}}else if(0!==Matter.Query.ray(map,this.position,this.playerPosRandomY()).length||m.isCloak)if(this.seePlayer.recall)if(this.lostPlayer(),m.isCloak)t(this.seePlayer.position);else for(let e=0;e<55;e++){let i=m.history[(simulation.cycle-10*e)%600];if(0===Matter.Query.ray(map,this.position,i.position).length){t(i.position);break}}else Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0);else this.seePlayer.yes=!0,this.locatePlayer(),this.seePlayer.yes||(this.seePlayer.yes=!0),t()}if(this.checkStatus(),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.redMode()),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=15+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}ctx.beginPath();for(let t=0,e=this.history.length;t<e;t++)ctx.lineTo(this.history[t].x,this.history[t].y);ctx.lineWidth=2*this.radius,ctx.strokeStyle=t,ctx.stroke()}},pulsarBoss(t,e,i=90,s=!1){mobs.spawn(t,e,3,i,"#a0f");let o=mob[mob.length-1];o.tier=2,s&&(o.collisionFilter.mask=cat.bullet|cat.player),setTimeout(()=>{o.constraint=Constraint.create({pointA:{x:o.position.x,y:o.position.y},bodyB:o,stiffness:1e-4,damping:.3}),Composite.add(engine.world,o.constraint)},2e3),o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.radius*=1.5,o.vertices[1].x=o.position.x+Math.cos(o.angle)*o.radius,o.vertices[1].y=o.position.y+Math.sin(o.angle)*o.radius,o.fireCycle=0,o.fireTarget={x:0,y:0},o.pulseRadius=Math.min(500,230+3*simulation.difficulty),o.fireDelay=Math.max(60,150-2*simulation.difficulty),o.isFiring=!1,Matter.Body.setDensity(o,.01),o.isBoss=!0,spawn.shield(o,t,e,1),spawn.spawnOrbitals(o,i+200+300*Math.random(),1),o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.onHit=function(){},o.do=function(){player.speed>5&&(this.do=this.fire)},o.damageReduction=.29,o.fire=function(){if(this.seePlayer.recall&&this.healthBar2(),this.checkStatus(),this.isStunned)this.isFiring=!1;else if(this.isFiring)this.fireCycle>this.fireDelay?(this.isFiring=!1,this.fireCycle=0,this.torque+=(8e-5+7e-5*Math.random())*this.inertia*(2*Math.round(Math.random())-1),Matter.Query.ray([player],this.fireTarget,this.position).length&&(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit)),Vector.magnitude(Vector.sub(player.position,this.fireTarget))<this.pulseRadius&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles,m.takeDamage(.045*this.damageScale())),simulation.drawList.push({x:this.fireTarget.x,y:this.fireTarget.y,radius:this.pulseRadius,color:"rgba(120,0,255,0.6)",time:simulation.drawTime}),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.lineWidth=20,ctx.strokeStyle="rgba(120,0,255,0.3)",ctx.stroke(),ctx.lineWidth=5,ctx.strokeStyle="rgba(120,0,255,1)",ctx.stroke()):(this.fireCycle++,ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.fireCycle/this.fireDelay*this.pulseRadius,0,2*Math.PI),ctx.fillStyle="rgba(120,0,255,0.09)",ctx.fill(),ctx.setLineDash([40*Math.random(),200*Math.random()]),ctx.lineWidth=2,ctx.strokeStyle="rgba(120,0,255,0.4)",ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.pulseRadius,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.stroke(),ctx.setLineDash([]));else{this.fireCycle++;const t=m.isCloak?m.history[(simulation.cycle-180)%600].position:m.pos;this.fireDir=Vector.normalise(Vector.sub(t,this.position));const e=this.angle+Math.PI/2,i=Math.cos(e)*this.fireDir.x+Math.sin(e)*this.fireDir.y,s=.04;i>s?this.torque+=15e-7*this.inertia:i<-s?this.torque-=15e-7*this.inertia:this.fireCycle>45&&(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit),Vector.magnitude(Vector.sub(t,this.fireTarget))<1e3&&(Matter.Body.setAngularVelocity(this,0),this.fireLockCount=0,this.isFiring=!0,this.fireCycle=0))}}},quasarBoss(t,e,i=50,s=!1){mobs.spawn(t,e,3,i,"#a0f");let o=mob[mob.length-1];o.tier=4,s&&(o.collisionFilter.mask=cat.bullet|cat.player),setTimeout(()=>{o.constraint=Constraint.create({pointA:{x:o.position.x,y:o.position.y},bodyB:o,stiffness:1e-4,damping:.3}),Composite.add(engine.world,o.constraint)},2e3),o.isBoss=!0,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.radius*=1.5,o.vertices[1].x=o.position.x+Math.cos(o.angle)*o.radius,o.vertices[1].y=o.position.y+Math.sin(o.angle)*o.radius,o.fireCycle=0,o.fireTarget={x:0,y:0},o.pulseRadius=290,o.fireDelay=110,o.isFiring=!1,Matter.Body.setDensity(o,.03),o.damageReduction=.3,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.8,o.invulnerableCount=0,spawn.shield(o,t,e,1),spawn.spawnOrbitals(o,i+200+300*Math.random(),1),o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.onDamage=function(){this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=90,this.isInvulnerable=!0,this.damageReduction=0)},o.onHit=function(){},o.do=function(){player.speed>5&&(this.do=this.fire)},o.fire=function(){if(this.seePlayer.recall&&this.healthBar4(),this.checkStatus(),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}if(this.isStunned)this.isFiring=!1;else if(this.isFiring)this.fireCycle>this.fireDelay?(this.isFiring=!1,this.fireCycle=0,this.torque+=(8e-5+7e-5*Math.random())*this.inertia*(2*Math.round(Math.random())-1),Matter.Query.ray([player],this.fireTarget,this.position).length&&(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit)),simulation.ephemera.push({count:360,position:this.fireTarget,level:level.levelsCleared,radius:this.pulseRadius,do(){this.count--,this.count<120&&(this.radius*=.98),(this.count<0||this.level!==level.levelsCleared)&&simulation.removeEphemera(this),Vector.magnitude(Vector.sub(player.position,this.position))<this.radius&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+30,m.takeDamage(.045*spawn.dmgToPlayerByLevelsCleared()));const t=Vector.rotate({x:1,y:0},6.28*Math.random());this.position=Vector.add(this.position,Vector.mult(t,10)),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),ctx.fillStyle=`rgba(120,0,255,${.5+.2*Math.random()})`,ctx.fill()}}),Vector.magnitude(Vector.sub(player.position,this.fireTarget))<this.pulseRadius&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles,m.takeDamage(.045*this.damageScale())),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.lineWidth=20,ctx.strokeStyle="rgba(120,0,255,0.3)",ctx.stroke(),ctx.lineWidth=5,ctx.strokeStyle="rgba(120,0,255,1)",ctx.stroke()):(this.fireCycle++,ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.fireCycle/this.fireDelay*this.pulseRadius,0,2*Math.PI),ctx.fillStyle="rgba(120,0,255,0.09)",ctx.fill(),ctx.setLineDash([40*Math.random(),200*Math.random()]),ctx.lineWidth=2,ctx.strokeStyle="rgba(120,0,255,0.4)",ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.pulseRadius,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.stroke(),ctx.setLineDash([]));else{this.fireCycle++;const t=m.isCloak?m.history[(simulation.cycle-180)%600].position:m.pos;this.fireDir=Vector.normalise(Vector.sub(t,this.position));const e=this.angle+Math.PI/2,i=Math.cos(e)*this.fireDir.x+Math.sin(e)*this.fireDir.y,s=.04;i>s?this.torque+=15e-7*this.inertia:i<-s?this.torque-=15e-7*this.inertia:this.fireCycle>45&&(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit),Vector.magnitude(Vector.sub(t,this.fireTarget))<1e3&&(Matter.Body.setAngularVelocity(this,0),this.fireLockCount=0,this.isFiring=!0,this.fireCycle=0))}}},pulsar(t,e,i=40){mobs.spawn(t,e,3,i,"#f08");let s=mob[mob.length-1];s.tier=2,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),Matter.Body.rotate(s,Math.random()*Math.PI*2),s.radius*=2,s.vertices[1].x=s.position.x+Math.cos(s.angle)*s.radius,s.vertices[1].y=s.position.y+Math.sin(s.angle)*s.radius,Matter.Body.setDensity(s,.002),s.fireCycle=1/0,s.fireTarget={x:0,y:0},s.pulseRadius=Math.min(400,170+3*simulation.difficulty),s.fireDelay=Math.max(75,140-.5*simulation.difficulty),s.isFiring=!1,spawn.shield(s,t,e),s.onHit=function(){},s.canSeeTarget=function(){const t=this.angle+Math.PI/2;return!(Vector.dot({x:Math.cos(t),y:Math.sin(t)},Vector.normalise(Vector.sub(this.fireTarget,this.position)))>.03||Matter.Query.ray(map,this.fireTarget,this.position).length||Matter.Query.ray(body,this.fireTarget,this.position).length||Vector.magnitude(Vector.sub(m.pos,this.fireTarget))>1e3)||(this.isFiring=!1,!1)},s.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.speed>6&&Matter.Body.setVelocity(this,{x:.8*this.velocity.x,y:.8*this.velocity.y}),Matter.Body.setVelocity(this,{x:.97*this.velocity.x,y:.97*this.velocity.y}),this.seePlayerByLookingAt(),this.checkStatus(),this.seePlayer.recall)if(this.isFiring)if(this.fireCycle>this.fireDelay){if(!this.canSeeTarget())return;this.isFiring=!1,this.fireCycle=0,this.torque+=(2e-5+2e-4*Math.random())*this.inertia*(2*Math.round(Math.random())-1),Matter.Query.ray([player],this.fireTarget,this.position).length&&(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit)),Vector.magnitude(Vector.sub(player.position,this.fireTarget))<this.pulseRadius&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles,m.takeDamage(.03*this.damageScale())),simulation.drawList.push({x:this.fireTarget.x,y:this.fireTarget.y,radius:this.pulseRadius,color:"rgba(255,0,100,0.6)",time:simulation.drawTime}),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.lineWidth=20,ctx.strokeStyle="rgba(255,0,100,0.3)",ctx.stroke(),ctx.lineWidth=5,ctx.strokeStyle="rgba(255,0,100,1)",ctx.stroke()}else this.fireCycle++,ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.fireCycle/this.fireDelay*this.pulseRadius,0,2*Math.PI),ctx.fillStyle="rgba(255,0,100,0.09)",ctx.fill(),ctx.setLineDash([40*Math.random(),200*Math.random()]),ctx.lineWidth=2,ctx.strokeStyle="rgba(255,0,100,0.4)",ctx.beginPath(),ctx.arc(this.fireTarget.x,this.fireTarget.y,this.pulseRadius,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(this.fireTarget.x,this.fireTarget.y),ctx.stroke(),ctx.setLineDash([]);else{this.fireCycle++;const t=this.angle+Math.PI/2,e=Vector.dot({x:Math.cos(t),y:Math.sin(t)},Vector.normalise(Vector.sub(this.seePlayer.position,this.position))),i=.04;if(e>i)this.torque+=15e-7*this.inertia;else if(e<-i)this.torque-=15e-7*this.inertia;else if(this.fireCycle>60){if(unit=Vector.mult(Vector.normalise(Vector.sub(this.vertices[1],this.position)),this.distanceToPlayer()-100),this.fireTarget=Vector.add(this.vertices[1],unit),!this.canSeeTarget())return;Matter.Body.setAngularVelocity(this,0),this.fireLockCount=0,this.isFiring=!0,this.fireCycle=0}}else this.isFiring=!1}},laserLayer(t,e,i=18+Math.floor(6*Math.random())){mobs.spawn(t,e,4,i,"#f09");let s=mob[mob.length-1];s.tier=3,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position);for(let t=0;t<4;t+=2){let e=Vector.mult(Vector.normalise(Vector.sub(s.vertices[t],s.position)),2*i);s.vertices[t].x=s.position.x+e.x,s.vertices[t].y=s.position.y+e.y}Matter.Body.rotate(s,Math.random()*Math.PI*2),Matter.Body.setDensity(s,.0014),s.accelMag=2e-4*simulation.accelScale,spawn.shield(s,t,e),s.laserArray=[],s.laserLimit=simulation.difficultyMode<3?1:2,s.fireDelay=Math.max(75,140-.5*simulation.difficulty),s.cycle=0,s.laserDelay=150+Math.floor(120*Math.random()),s.addLaser=function(){if(this.cycle>this.laserDelay){this.cycle=0;const t=6e3,e=this.angle+Math.PI/4,i={x:this.position.x+t*Math.cos(e),y:this.position.y+t*Math.sin(e)},s={x:this.position.x+t*Math.cos(e+Math.PI),y:this.position.y+t*Math.sin(e+Math.PI)};let o=vertexCollision(this.position,i,[map]),a=vertexCollision(this.position,s,[map]);if(null===a.who&&(a.x=s.x,a.y=s.y),null===o.who&&(o.x=i.x,o.y=i.y),o.y>a.y){const t=o.x,e=o.y;o.x=a.x,o.y=a.y,a.x=t,a.y=e}if(this.laserArray.push({a:{x:o.x,y:o.y},b:{x:a.x,y:a.y},fade:0}),Matter.Body.setVelocity(this,Vector.mult(this.velocity,.05)),Matter.Body.setAngularVelocity(this,.05*this.angularVelocity),this.laserArray.length>this.laserLimit&&this.laserArray.shift(),!this.seePlayer.recall&&(Vector.magnitude(Vector.sub(this.position,this.driftGoal))<200||.3>Math.random())){const t=1e3*Math.random(),e=2*Math.random()*Math.PI;this.driftGoal=Vector.add(this.driftCenter,{x:t*Math.cos(e),y:t*Math.sin(e)})}}},s.fireLaser=function(){for(let t=0;t<this.laserArray.length;t++){let e=vertexCollision(this.laserArray[t].a,this.laserArray[t].b,m.isCloak?[body]:[body,[playerBody,playerHead]]);if(this.laserArray[t].fade>.99)if(e.who&&(e.who===playerBody||e.who===playerHead)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles;const i=.03*this.damageScale();if(m.takeDamage(i),simulation.drawList.push({x:e.x,y:e.y,radius:1500*i,color:"rgba(255,0,100,0.5)",time:20}),this.laserArray.splice(t,1),this.distanceToPlayer<1e3){const t=.03*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x-=2*t*Math.cos(e),this.force.y-=2*t*Math.sin(e)}}else e.who&&"body"===e.who.classType?(ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.lineTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.strokeStyle="rgb(255,0,100)",ctx.lineWidth=2,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([])):(ctx.beginPath(),ctx.moveTo(this.laserArray[t].b.x,this.laserArray[t].b.y),ctx.lineTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.strokeStyle="rgb(255,0,100)",ctx.lineWidth=2,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]));else this.laserArray[t].fade+=.01,ctx.beginPath(),ctx.moveTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.lineTo(this.laserArray[t].b.x,this.laserArray[t].b.y),ctx.lineWidth=42-40*this.laserArray[t].fade,ctx.strokeStyle=`rgba(255,0,100,${.02+.1*this.laserArray[t].fade})`,ctx.stroke()}},s.driftCenter={...s.position};const o=100*Math.random(),a=2*Math.random()*Math.PI;s.driftGoal=Vector.add(s.driftCenter,{x:o*Math.cos(a),y:o*Math.sin(a)}),s.drift=function(){if(this.seePlayer.recall){const t=Vector.mult(Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),this.accelMag*this.mass);this.force.x+=t.x,this.force.y+=t.y}else{const t=Vector.mult(Vector.normalise(Vector.sub(this.driftGoal,this.position)),2e-5*this.mass);this.force.x+=t.x,this.force.y+=t.y}},s.do=function(){this.seePlayer.recall&&this.healthBar3(),this.cycle++,this.torque=this.lookTorque*this.inertia*.6,this.seePlayerCheck(),this.checkStatus(),this.drift(),this.addLaser(),this.fireLaser()}},laserLayerBoss(t,e,i=65){mobs.spawn(t,e,4,i,"#f09");let s=mob[mob.length-1];s.tier=3,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position);for(let t=0;t<4;t+=2){let e=Vector.mult(Vector.normalise(Vector.sub(s.vertices[t],s.position)),2*i);s.vertices[t].x=s.position.x+e.x,s.vertices[t].y=s.position.y+e.y}Matter.Body.rotate(s,Math.random()*Math.PI*2),s.accelMag=1e-4*simulation.accelScale,s.isBoss=!0,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},Matter.Body.setDensity(s,.03),s.damageReduction=.36,s.startingDamageReduction=s.damageReduction,s.isInvulnerable=!1,s.nextHealthThreshold=.75,s.invulnerableCount=0,s.onDamage=function(){this.health<this.nextHealthThreshold&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=90,this.isInvulnerable=!0,this.damageReduction=0,this.laserDelay=130)},s.laserArray=[],s.laserLimit=2+(simulation.difficultyMode>2)+(simulation.difficultyMode>4),s.fireDelay=Math.max(75,140-.5*simulation.difficulty),s.cycle=0,s.laserDelay=210,s.addLaser=function(){if(this.cycle>this.laserDelay){this.cycle=0;const t=6e3;let e=(e,i)=>{const s={x:e.x+t*Math.cos(i),y:e.y+t*Math.sin(i)},o={x:e.x+t*Math.cos(i+Math.PI),y:e.y+t*Math.sin(i+Math.PI)};let a=vertexCollision(e,s,[map]),n=vertexCollision(e,o,[map]);if(null===n.who&&(n.x=o.x,n.y=o.y),null===a.who&&(a.x=s.x,a.y=s.y),a.y>n.y){const t=a.x,e=a.y;a.x=n.x,a.y=n.y,n.x=t,n.y=e}this.laserArray.push({a:{x:a.x,y:a.y},b:{x:n.x,y:n.y},fade:0})};if(e(m.pos,this.angle+Math.PI/4+Math.PI/2),e(this.position,this.angle+Math.PI/4),Matter.Body.setVelocity(this,Vector.mult(this.velocity,.05)),Matter.Body.setAngularVelocity(this,.05*this.angularVelocity),!this.seePlayer.recall&&(Vector.magnitude(Vector.sub(this.position,this.driftGoal))<200||.3>Math.random())){const t=1e3*Math.random(),e=2*Math.random()*Math.PI;this.driftGoal=Vector.add(this.driftCenter,{x:t*Math.cos(e),y:t*Math.sin(e)})}}},s.fireLaser=function(){for(let t=0;t<this.laserArray.length;t++){let e=vertexCollision(this.laserArray[t].a,this.laserArray[t].b,m.isCloak?[body]:[body,[playerBody,playerHead]]);if(this.laserArray[t].fade>.99)if(e.who&&(e.who===playerBody||e.who===playerHead)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles;const i=.03*this.damageScale();if(m.takeDamage(i),simulation.drawList.push({x:e.x,y:e.y,radius:1500*i,color:"rgba(255,0,100,0.5)",time:20}),this.laserArray.splice(t,1),this.distanceToPlayer<1e3){const t=.03*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x-=2*t*Math.cos(e),this.force.y-=2*t*Math.sin(e)}}else e.who&&"body"===e.who.classType?(ctx.beginPath(),ctx.moveTo(e.x,e.y),ctx.lineTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.strokeStyle="rgb(255,0,100)",ctx.lineWidth=2,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([])):(ctx.beginPath(),ctx.moveTo(this.laserArray[t].b.x,this.laserArray[t].b.y),ctx.lineTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.strokeStyle="rgb(255,0,100)",ctx.lineWidth=2,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]));else if(this.laserArray[t].fade+=.007,ctx.beginPath(),ctx.moveTo(this.laserArray[t].a.x,this.laserArray[t].a.y),ctx.lineTo(this.laserArray[t].b.x,this.laserArray[t].b.y),ctx.lineWidth=42-40*this.laserArray[t].fade,ctx.strokeStyle=`rgba(255,0,100,${.02+.1*this.laserArray[t].fade})`,ctx.stroke(),this.laserArray[t].fade>.99){this.laserArray[t].fade=1,this.laserArray.length>this.laserLimit&&this.laserArray.shift();break}}},s.driftCenter={...s.position};const o=100*Math.random(),a=2*Math.random()*Math.PI;s.driftGoal=Vector.add(s.driftCenter,{x:o*Math.cos(a),y:o*Math.sin(a)}),s.drift=function(){if(this.seePlayer.recall){const t=Vector.mult(Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),this.accelMag*this.mass);this.force.x+=t.x,this.force.y+=t.y}else{const t=Vector.mult(Vector.normalise(Vector.sub(this.driftGoal,this.position)),1e-5*this.mass);this.force.x+=t.x,this.force.y+=t.y}this.torque=this.lookTorque*this.inertia*.9},s.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.cycle++,this.seePlayerCheck(),this.checkStatus(),this.drift(),this.addLaser(),this.fireLaser(),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}}},laser(t,e,i=30){const s="#f00";mobs.spawn(t,e,3,i,s);let o=mob[mob.length-1];o.tier=1,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.accelMag=1e-4*simulation.accelScale,o.laserInterval=100,Matter.Body.setDensity(o,.0015),spawn.shield(o,t,e),o.onHit=function(){},o.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.torque=this.lookTorque*this.inertia*.5,this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.seePlayer.recall)if(simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position))),simulation.cycle%this.laserInterval>this.laserInterval/2){const t=8e3;let e={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(e=vertexCollision(this.position,i,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(e.who===playerBody||e.who===playerHead)&&m.immuneCycle<m.cycle){const t=.003*this.damageScale();m.takeDamage(t),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(e.x,e.y,1500*t,0,2*Math.PI),ctx.fill()}e.dist2===1/0&&(e=i),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(e.x,e.y),ctx.strokeStyle=s,ctx.lineWidth=3,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+.3*(this.laserInterval-simulation.cycle%this.laserInterval),0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}else ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+simulation.cycle%this.laserInterval*.3,0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}},quadLaser(t,e,i=60){const s="rgb(255,0,50)";mobs.spawn(t,e,4,i,"rgb(255,0,50,0.7)");let o=mob[mob.length-1];o.tier=4,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),Matter.Body.rotate(o,Math.random()*Math.PI*2),o.accelMag=1e-4*simulation.accelScale,o.memory=360,o.laserInterval=250+Math.floor(80*Math.random()),o.cycle=0,Matter.Body.setDensity(o,.0057),spawn.shield(o,t,e),o.onDamage=function(){},o.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.torque=this.lookTorque*this.inertia*.2,this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall)if(this.cycle++,this.cycle%this.laserInterval>.7*this.laserInterval)for(let t=0;t<4;t++){const e=8e3;let i={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const o=this.angle+1.57*(t+2.5),a={x:this.position.x+e*Math.cos(o),y:this.position.y+e*Math.sin(o)};if(i=vertexCollision(this.position,a,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(i.who===playerBody||i.who===playerHead)&&m.immuneCycle<m.cycle){const t=.004*this.damageScale();m.takeDamage(t),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(i.x,i.y,1500*t,0,2*Math.PI),ctx.fill()}i.dist2===1/0&&(i=a),ctx.beginPath(),ctx.moveTo(this.vertices[t].x,this.vertices[t].y),ctx.lineTo(i.x,i.y),ctx.strokeStyle=s,ctx.lineWidth=3,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(this.vertices[t].x,this.vertices[t].y,1+.1*(this.laserInterval-this.cycle%this.laserInterval),0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}else for(let t=0;t<4;t++)ctx.beginPath(),ctx.arc(this.vertices[t].x,this.vertices[t].y,1+this.cycle%this.laserInterval*.08,0,2*Math.PI),ctx.fillStyle=s,ctx.fill();else this.cycle=0}},pentaLaserBoss(t,e,i=60){const s="rgb(255,255,255)";mobs.spawn(t,e,5,i,"rgb(255,255,255,0.7)");let o=mob[mob.length-1];o.tier=4,o.isBoss=!0,o.damageReduction=.22,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.857,o.invulnerableCount=0,Matter.Body.setDensity(o,.004),o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),o.accelMag=5e-4,o.frictionAir=.01,o.laserInterval=140,o.memory=480,spawn.shield(o,t,e),o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);const t=["#FF0000","#FF7F00","#FFFF00","#00FF00","#0000FF","#8B00FF"];for(let e=0;e<t.length;++e)spawn.laserBaby(this.position.x+(Math.random()-.5)*i*2.5,this.position.y+(Math.random()-.5)*i*2.5,this.tier,t[e]),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+15*(Math.random()-.5),y:this.velocity.x+15*(Math.random()-.5)})},o.colorIndex=0,o.onDamage=function(){if(this.health<this.nextHealthThreshold){this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(7*this.health)/7,this.invulnerableCount=60,this.isInvulnerable=!0,this.damageReduction=0;const t=["#FF0000","#FF7F00","#FFFF00","#00FF00","#0000FF","#8B00FF"];spawn.laserBaby(this.position.x+(Math.random()-.5)*i*2.5,this.position.y+(Math.random()-.5)*i*2.5,this.tier,t[this.colorIndex]),this.colorIndex++,Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+15*(Math.random()-.5),y:this.velocity.x+15*(Math.random()-.5)})}},o.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.torque=this.lookTorque*this.inertia*.1,this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall)if(simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position))),simulation.cycle%this.laserInterval>this.laserInterval/2)for(let t=0;t<5;t++){const e=8e3;let i={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const o=this.angle+1.25*(t+3),a={x:this.position.x+e*Math.cos(o),y:this.position.y+e*Math.sin(o)};if(i=vertexCollision(this.position,a,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(i.who===playerBody||i.who===playerHead)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles+30;const t=.05*this.damageScale();m.takeDamage(t),simulation.drawList.push({x:i.x,y:i.y,radius:1500*t,color:"rgba(255,255,255,1)",time:20})}i.dist2===1/0&&(i=a),ctx.beginPath(),ctx.moveTo(this.vertices[t].x,this.vertices[t].y),ctx.lineTo(i.x,i.y),ctx.strokeStyle=s,ctx.lineWidth=5,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(this.vertices[t].x,this.vertices[t].y,1+.2*(this.laserInterval-simulation.cycle%this.laserInterval),0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}else for(let t=0;t<5;t++)ctx.beginPath(),ctx.arc(this.vertices[t].x,this.vertices[t].y,1+simulation.cycle%this.laserInterval*.2,0,2*Math.PI),ctx.fillStyle=s,ctx.fill();if(this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=15+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}}},laserBaby(t,e,i,s="#f00",o=23){mobs.spawn(t,e,3,o,s);let a=mob[mob.length-1];a.tier=i,a.vertices=Matter.Vertices.rotate(a.vertices,Math.PI,a.position),a.accelMag=15e-5*simulation.accelScale,a.laserInterval=120,Matter.Body.setDensity(a,.003),a.do=function(){if(this.torque=this.lookTorque*this.inertia*.3,this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall)if(simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position))),simulation.cycle%this.laserInterval>this.laserInterval/2){const t=8e3;let e={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:this.position.x+t*Math.cos(this.angle),y:this.position.y+t*Math.sin(this.angle)};if(e=vertexCollision(this.position,i,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),(e.who===playerBody||e.who===playerHead)&&m.immuneCycle<m.cycle){const t=.003*this.damageScale();m.takeDamage(t),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(e.x,e.y,1500*t,0,2*Math.PI),ctx.fill()}e.dist2===1/0&&(e=i),ctx.beginPath(),ctx.moveTo(this.vertices[1].x,this.vertices[1].y),ctx.lineTo(e.x,e.y),ctx.strokeStyle=s,ctx.lineWidth=3,ctx.setLineDash([50+120*Math.random(),50*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+.3*(this.laserInterval-simulation.cycle%this.laserInterval),0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}else ctx.beginPath(),ctx.arc(this.vertices[1].x,this.vertices[1].y,1+simulation.cycle%this.laserInterval*.3,0,2*Math.PI),ctx.fillStyle=s,ctx.fill()}},laserBoss(t,e,i=30){mobs.spawn(t,e,3,i,"#f00");let s=mob[mob.length-1];setTimeout(()=>{s.constraint=Constraint.create({pointA:{x:s.position.x,y:s.position.y},bodyB:s,stiffness:1,damping:1}),Composite.add(engine.world,s.constraint)},2e3),s.count=0,s.frictionAir=.03,spawn.spawnOrbitals(s,i+50+200*Math.random()),Matter.Body.setDensity(s,.03),s.damageReduction=.25,s.isBoss=!0,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.rotateVelocity=Math.min(.0045,.0015*simulation.accelScale*simulation.accelScale)*(level.levelsCleared>8?1:-1)*(simulation.isHorizontalFlipped?-1:1),s.do=function(){if(this.fill="#"+Math.random().toString(16).substr(-6),this.checkStatus(),!this.isStunned){let t=!1;for(let e=0;e<this.status.length;e++)if("slow"===this.status[e].type){t=!0;break}t||(this.count++,Matter.Body.setAngle(this,this.count*this.rotateVelocity),Matter.Body.setAngularVelocity(this,0)),ctx.beginPath(),this.laserArray(this.vertices[0],this.angle+Math.PI/3),this.laserArray(this.vertices[1],this.angle+Math.PI),this.laserArray(this.vertices[2],this.angle-Math.PI/3),ctx.strokeStyle="#50f",ctx.lineWidth=1.5,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([]),ctx.lineWidth=20,ctx.strokeStyle="rgba(80,0,255,0.07)",ctx.stroke()}},s.laserArray=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+7e3*Math.cos(e),y:t.y+7e3*Math.sin(e)};if(best=vertexCollision(t,i,m.isCloak?[map,body]:[map,body,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles+30;const t=.12*this.damageScale();m.takeDamage(t),simulation.drawList.push({x:best.x,y:best.y,radius:1500*t,color:"rgba(80,0,255,0.5)",time:20})}best.dist2===1/0&&(best=i),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y)}},stabber(t,e,i=25+Math.ceil(12*Math.random()),s=7){i>80&&(i=65),mobs.spawn(t,e,6,i,"rgb(220,50,205)");let o=mob[mob.length-1];o.tier=2,o.isVerticesChange=!0,o.accelMag=6e-4*simulation.accelScale,o.delay=360*simulation.CDScale,o.spikeVertex=0,o.spikeLength=0,o.isSpikeGrowing=!1,o.spikeGrowth=0,o.isSpikeReset=!0,o.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.player,Matter.Body.rotate(o,.1*Math.PI),spawn.shield(o,t,e),o.onDeath=function(){if(this.spikeLength>4){this.spikeLength=4;const t=Vector.mult(Vector.normalise(Vector.sub(this.vertices[this.spikeVertex],this.position)),this.radius*this.spikeLength);this.vertices[this.spikeVertex].x=this.position.x+t.x,this.vertices[this.spikeVertex].y=this.position.y+t.y}},o.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.seePlayerByLookingAt(),this.checkStatus(),this.attraction(),this.isSpikeReset){if(this.seePlayer.recall){const t=Vector.sub(this.seePlayer.position,this.position);if(Vector.magnitude(t)<i*s){let t=1/0;for(let e=0,i=this.vertices.length;e<i;e++){const i=Vector.sub(this.seePlayer.position,this.vertices[e]),s=Vector.magnitude(i);s<t&&(this.spikeVertex=e,t=s)}this.spikeLength=1,this.isSpikeGrowing=!0,this.isSpikeReset=!1,Matter.Body.setAngularVelocity(this,0)}}}else{this.isSpikeGrowing?(this.spikeLength+=Math.pow(this.spikeGrowth+=.02,8),this.spikeLength>s&&(this.isSpikeGrowing=!1,this.spikeGrowth=0)):(Matter.Body.setAngularVelocity(this,.8*this.angularVelocity),this.spikeLength-=.3,this.spikeLength<1&&(this.spikeLength=1,this.isSpikeReset=!0,this.radius=i));const t=Vector.mult(Vector.normalise(Vector.sub(this.vertices[this.spikeVertex],this.position)),i*this.spikeLength);this.vertices[this.spikeVertex].x=this.position.x+t.x,this.vertices[this.spikeVertex].y=this.position.y+t.y}}},striker(t,e,i=14+Math.ceil(25*Math.random())){mobs.spawn(t,e,5,i,"rgb(221,102,119)");let s=mob[mob.length-1];s.tier=2,s.accelMag=34e-5*simulation.accelScale,s.g=15e-5,s.frictionStatic=0,s.friction=0,s.delay=30+60*simulation.CDScale,s.cd=1/0,s.strikeRange=300,Matter.Body.rotate(s,.1*Math.PI),spawn.shield(s,t,e),s.onDamage=function(){this.cd=simulation.cycle+this.delay},s.do=function(){if(this.seePlayer.recall&&this.healthBar2(),this.gravity(),simulation.cycle%this.seePlayerFreq||(this.distanceToPlayer2()<this.seeAtDistance2&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&!m.isCloak?(this.foundPlayer(),this.cd===1/0&&(this.cd=simulation.cycle+.7*this.delay)):this.seePlayer.recall&&(this.lostPlayer(),this.cd=1/0)),this.checkStatus(),this.attraction(),this.cd<simulation.cycle&&this.seePlayer.recall){const t=Vector.sub(this.seePlayer.position,this.position),e=Vector.magnitude(t);this.cd=simulation.cycle+this.delay,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y),e<400?Matter.Body.translate(this,Vector.mult(Vector.normalise(t),e-20-i)):Matter.Body.translate(this,Vector.mult(Vector.normalise(t),this.strikeRange)),ctx.lineTo(this.position.x,this.position.y),ctx.lineWidth=2.1*i,ctx.strokeStyle=this.fill,ctx.stroke(),Matter.Body.setVelocity(this,{x:.5*this.velocity.x,y:.5*this.velocity.y})}}},revolutionBoss(t,e,i=70){const s=9+Math.floor(Math.min(12,.2*simulation.difficulty)),o=[-1.8,0,0,.9,1.2],a=o[Math.floor(Math.random()*o.length)];mobs.spawn(t,e,s,i,"rgb(201,202,225)");let n=mob[mob.length-1];n.tier=1,Matter.Body.rotate(n,2*Math.PI*Math.random()),n.accelMag=18e-5+18e-5*Math.sqrt(simulation.accelScale),n.frictionAir=.01,n.swordRadiusMax=400+10*simulation.difficulty,n.laserAngle=0,n.swordDamage=.025*n.damageScale(),Matter.Body.setDensity(n,.005),n.damageReduction=.13,n.isBoss=!0,n.onDamage=function(){},n.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},n.isInvulnerable=!1,n.isNextInvulnerability=.75,n.invulnerabilityCountDown=0,n.invulnerable=function(){if(this.health<this.isNextInvulnerability&&(this.isNextInvulnerability=Math.floor(4*this.health)/4,this.isInvulnerable=!0,this.startingDamageReduction=this.damageReduction,this.damageReduction=0,this.invulnerabilityCountDown=106),this.isInvulnerable)if(this.invulnerabilityCountDown>0){this.invulnerabilityCountDown--,ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction},n.do=function(){this.seePlayer.recall&&this.healthBar1(),this.invulnerable(),this.checkStatus(),this.seePlayerByHistory(60),this.attraction(),this.laserAngle+=this.isInvulnerable?.025:.006;for(let t=0,e=this.vertices.length;t<e;t++){const i=a*Math.cos(this.laserAngle+2*Math.PI*t/e),o=this.swordRadiusMax*Math.sin(this.laserAngle+2*Math.PI*t/e);o>0&&this.laserSword(this.vertices[t],i+this.angle+(t+.5)/s*2*Math.PI,Math.abs(o))}},n.laserSword=function(t,e,i){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const s={x:t.x+i*Math.cos(e),y:t.y+i*Math.sin(e)};best=vertexCollision(t,s,[map,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20})),best.dist2===1/0&&(best=s),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=10,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=2,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},sprayBoss(t,e,i=40,s=!0){mobs.spawn(t,e,16,i,"rgb(255,255,255)");let o=mob[mob.length-1];o.isBoss=!0,o.isReactorBoss=!0,o.inertia=1/0,o.burstFireFreq=22+Math.floor(13*simulation.CDScale),o.burstTotalPhases=3+Math.floor(1.4/simulation.CDScale),o.frictionStatic=0,o.friction=0,o.frictionAir=0,o.restitution=1,Matter.Body.setDensity(o,.002+5e-5*Math.sqrt(simulation.difficulty)),o.damageReduction=.16,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.75,o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.onDamage=function(){this.health<this.nextHealthThreshold&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.phaseCycle=-2,this.do=this.burstFire,this.frictionAir=1,this.isInvulnerable=!0,this.damageReduction=0)},o.radialLines=function(){ctx.beginPath();for(let t=0,e=this.vertices.length;t<e;t++){ctx.moveTo(this.vertices[t].x,this.vertices[t].y);const e=Vector.add(Vector.mult(Vector.normalise(Vector.sub(this.vertices[t],this.position)),1e3),this.vertices[t]);ctx.lineTo(e.x,e.y)}ctx.lineWidth=10,ctx.strokeStyle="rgb(200,0,200,0.03)",ctx.stroke()},o.phaseCycle=0,o.normalDoStuff=function(){this.checkStatus(),o.seePlayer.recall=1,this.speed<.01?Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(Vector.sub(player.position,this.position)),.1)):(Math.abs(this.velocity.y)<9&&Matter.Body.setVelocity(this,{x:this.velocity.x,y:1.03*this.velocity.y}),Math.abs(this.velocity.x)<7&&Matter.Body.setVelocity(this,{x:1.03*this.velocity.x,y:this.velocity.y}))},o.burstFire=function(){this.normalDoStuff(),this.radialLines(),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);if(ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke(),!(simulation.cycle%this.burstFireFreq)){if(this.phaseCycle++,this.phaseCycle>this.burstTotalPhases&&(this.do=this.normalDoStuff,this.frictionAir=0,this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,Matter.Body.setVelocity(this,Vector.rotate({x:20,y:0},2*Math.PI*Math.random())),this.isShielded))for(let t=0;t<mob.length;t++)mob[t].shield&&mob[t].death();if(this.phaseCycle>-1){Matter.Body.rotate(this,.02);for(let t=0,e=this.vertices.length;t<e;t++){spawn.sniperBullet(this.vertices[t].x,this.vertices[t].y,3,4);const e=Vector.mult(Vector.normalise(Vector.sub(this.position,this.vertices[t])),-15);Matter.Body.setVelocity(mob[mob.length-1],{x:e.x,y:e.y})}}}},o.do=o.normalDoStuff,Matter.Body.setVelocity(o,{x:10*(Math.random()-.5),y:10*(Math.random()-.5)})},bounceBoss(t,e,i=80,s=!0){mobs.spawn(t,e,0,i,"rgb(255,255,255)");let o=mob[mob.length-1];Matter.Body.rotate(o,2*Math.PI*Math.random()),o.isBoss=!0,o.isReactorBoss=!0,Matter.Body.setDensity(o,.003),o.damageReduction=.15,o.startingDamageReduction=o.damageReduction,o.inertia=1/0,o.isInvulnerable=!1,o.frictionAir=.01,o.restitution=1,o.friction=0,o.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map|cat.mob,Matter.Body.setVelocity(o,{x:10*(Math.random()-.5),y:10*(Math.random()-.5)}),o.seePlayer.recall=1,o.onDamage=function(){this.health<this.nextHealthThreshold&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.fireCount=60+1.5*simulation.difficulty,this.isInvulnerable=!0,this.damageReduction=0)},s&&(o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)}),o.cycle=0,o.nextHealthThreshold=.75,o.fireCount=0,o.do=function(){if(o.seePlayer.recall=1,this.speed<.01){const t=Vector.sub(player.position,this.position);Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(t),.1))}else Math.abs(this.velocity.y)<15&&Matter.Body.setVelocity(this,{x:this.velocity.x,y:1.03*this.velocity.y}),Math.abs(this.velocity.x)<11&&Matter.Body.setVelocity(this,{x:1.03*this.velocity.x,y:this.velocity.y});if(this.isInvulnerable){this.fireCount--,this.fireCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),this.mass>10&&Matter.Body.scale(this,.99,.99);const t=Vector.rotate(Vector.mult(Vector.normalise(this.velocity),-5-10*Math.random()),.5*(Math.random()-.5));spawn.bounceBullet(this.position.x,this.position.y,t),ctx.beginPath();let e=this.vertices;ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)ctx.lineTo(e[t].x,e[t].y);ctx.lineTo(e[0].x,e[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else this.mass<100&&Matter.Body.scale(this,1.01,1.01);this.checkStatus()}},timeBoss(t,e,i=50,s=!0){mobs.spawn(t,e,0,i,"hsl(0, 100%, 50%)");let o=mob[mob.length-1];Matter.Body.rotate(o,2*Math.PI*Math.random()),o.isBoss=!0,o.isReactorBoss=!0,o.inertia=1/0,o.frictionAir=.01,o.restitution=1,o.friction=0,o.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map|cat.mob,Matter.Body.setVelocity(o,{x:10*(Math.random()-.5),y:10*(Math.random()-.5)}),o.seePlayer.recall=1;for(let t=0,e=2+.3*Math.sqrt(simulation.difficulty);t<e;t++)spawn.spawnOrbitals(o,i+10+10*t,1);Matter.Body.setDensity(o,.001),o.damageReduction=.085,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.onDamage=function(){this.health<this.nextHealthThreshold&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=420+5*simulation.difficulty,this.isInvulnerable=!0,this.damageReduction=0)},o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y),requestAnimationFrame(()=>{simulation.timePlayerSkip(60)})},o.cycle=Math.floor(360*Math.random()),o.nextHealthThreshold=.75,o.invulnerableCount=0,o.do=function(){if(this.cycle++,this.fill=`hsl(${.5*this.cycle}, 100%, 80%)`,this.seePlayer.recall=1,this.speed<.01){const t=Vector.sub(player.position,this.position);Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(t),.1))}else Math.abs(this.velocity.y)<10&&Matter.Body.setVelocity(this,{x:this.velocity.x,y:1.02*this.velocity.y}),Math.abs(this.velocity.x)<7&&Matter.Body.setVelocity(this,{x:1.02*this.velocity.x,y:this.velocity.y});if(this.isInvulnerable&&(this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),!simulation.isTimeSkipping)){requestAnimationFrame(()=>{simulation.timePlayerSkip(2),m.walk_cycle+=m.flipLegs*m.Vx}),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=15+6*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}this.checkStatus()}},bounceBullet(t,e,i={x:0,y:0},s=11,o=6){mobs.spawn(t,e,o,s,"rgb(255,0,155)");let a=mob[mob.length-1];a.stroke="transparent",Matter.Body.setDensity(a,1e-5),a.timeLeft=360+Math.floor(180*Math.random()),a.inertia=1/0,a.damageReduction=1,a.frictionAir=0,a.friction=0,a.restitution=1,a.collisionFilter.category=cat.mobBullet,a.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map|cat.mob,a.leaveBody=!1,a.isDropPowerUp=!1,a.isBadTarget=!0,a.isMobBullet=!0,a.onHit=function(){this.explode(12*this.mass)},a.do=function(){this.timeLimit()},Matter.Body.setVelocity(a,i)},mineBoss(t,e,i=120,s=!0){mobs.spawn(t,e,0,i,"rgba(255,255,255,0.5)");let o=mob[mob.length-1];o.isBoss=!0,o.isReactorBoss=!0,Matter.Body.setDensity(o,.001),o.damageReduction=.056,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.75,o.invulnerableCount=0,o.cycle=0,o.inertia=1/0,o.frictionAir=.01,o.restitution=1,o.friction=0,o.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map|cat.mob,o.explodeRange=400,Matter.Body.setVelocity(o,{x:10*(Math.random()-.5),y:10*(Math.random()-.5)}),o.seePlayer.recall=1,o.onDamage=function(){if(this.health<this.nextHealthThreshold){this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=60+1.5*simulation.difficulty,this.isInvulnerable=!0,this.damageReduction=0;for(let t=0,e=mob.length;t<e;++t)mob[t].isMine&&Vector.magnitude(Vector.sub(this.position,mob[t].position))<this.explodeRange&&(mob[t].isExploding=!0);simulation.drawList.push({x:this.position.x,y:this.position.y,radius:this.explodeRange,color:"rgba(255,25,0,0.6)",time:2*simulation.drawTime})}},o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0,e=mob.length;t<e;++t)mob[t].isMine&&Vector.magnitude(Vector.sub(this.position,mob[t].position))<this.explodeRange&&(mob[t].isExploding=!0)},o.do=function(){if(o.seePlayer.recall=1,this.speed<.01){const t=Vector.sub(player.position,this.position);Matter.Body.setVelocity(this,Vector.mult(Vector.normalise(t),.1))}else Math.abs(this.velocity.y)<10&&Matter.Body.setVelocity(this,{x:this.velocity.x,y:1.03*this.velocity.y}),Math.abs(this.velocity.x)<7&&Matter.Body.setVelocity(this,{x:1.03*this.velocity.x,y:this.velocity.y});if(this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}this.checkStatus(),!(simulation.cycle%15)&&mob.length<360&&spawn.mine(this.position.x,this.position.y)}},mine(t,e){mobs.spawn(t,e,8,10,"rgb(255, 255, 255)");let i=mob[mob.length-1];i.stroke="transparent",Matter.Body.setDensity(i,1e-4),i.frictionAir=1,i.damageReduction=2,i.collisionFilter.mask=cat.bullet,i.isMine=!0,i.leaveBody=!1,i.isDropPowerUp=!1,i.isBadTarget=!0,i.isMobBullet=!0,i.isUnstable=!0,i.explodeRange=210+140*Math.random(),i.isExploding=!1,i.countDown=Math.ceil(4*Math.random()),i.isInvulnerable=!0,i.do=function(){if(this.checkStatus(),Matter.Query.collides(this,[player]).length>0&&(!m.isCloak||!tech.isIntangible)&&m.immuneCycle<m.cycle&&(this.isExploding=!0),this.isExploding&&this.countDown--<0){this.death(),Vector.magnitude(Vector.sub(this.position,player.position))<this.explodeRange&&m.immuneCycle<m.cycle&&(m.takeDamage(.02*this.damageScale()*(tech.isRadioactiveResistance?.2:1)),m.energy-=.2*(tech.isRadioactiveResistance?.2:1),m.energy<0&&(m.energy=0));const t=this.explodeRange+50;for(let e=0,i=mob.length;e<i;++e)mob[e].alive&&Vector.magnitude(Vector.sub(this.position,mob[e].position))<t&&mob[e].isMine&&(mob[e].isExploding=!0);simulation.drawList.push({x:this.position.x,y:this.position.y,radius:this.explodeRange,color:"rgba(80,220,190,0.45)",time:16})}}},trainBoss(t,e,i=50,s=!0){mobs.spawn(t,e,0,i,"rgba(255,0,155,1)");let o=mob[mob.length-1];o.isBoss=!0,Matter.Body.setDensity(o,.015),o.damageReduction=1,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.75,o.invulnerableCount=0,o.seeAtDistance2=4e6,o.cycle=0,o.accelMag=.023,o.frictionAir=1,o.restitution=1,o.friction=0,o.collisionFilter.mask=cat.bullet,o.seePlayer.recall=1,o.onDamage=function(){if(this.health<this.nextHealthThreshold){this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=50+10*simulation.difficultyMode,this.isInvulnerable=!0,this.damageReduction=0;for(let t=0,e=mob.length;t<e;++t)mob[t].isMine&&(mob[t].isExploding=!0);this.ammo=15+6*simulation.difficultyMode+level.levelsCleared}},o.ammo=20+8*simulation.difficultyMode+2*level.levelsCleared,o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0,e=mob.length;t<e;++t)mob[t].isMine&&Vector.magnitude(Vector.sub(this.position,mob[t].position))<this.explodeRange&&(mob[t].isExploding=!0);if(level.levelsCleared>6)for(let t=0;t<20;t++){const t=Vector.rotate(Vector.mult(Vector.normalise(this.velocity),-5-10*Math.random()),.5*(Math.random()-.5));spawn.bounceBullet(this.position.x,this.position.y,t)}},o.trackIndex=0,o.track=[{x:-2750,y:925},{x:-2250,y:925},{x:-1750,y:925},{x:-1250,y:925},{x:-751,y:925},{x:-313.25,y:925},{x:124.5,y:925},{x:562.25,y:925},{x:1e3,y:925},{x:1453.4,y:925},{x:1906.8,y:925},{x:2360.2,y:925},{x:2813.6,y:925},{x:3267,y:925},{x:3500,y:650},{x:3501,y:266.67},{x:3502,y:-116.67},{x:3503,y:-500},{x:4e3,y:-500},{x:4500,y:-500},{x:5e3,y:-500},{x:5500,y:-500},{x:6e3,y:-500},{x:6500,y:-500},{x:7e3,y:-500},{x:7500,y:-500},{x:8e3,y:-500},{x:8500,y:-500},{x:9e3,y:-500},{x:9500,y:-500},{x:1e4,y:-500},{x:10500,y:-500},{x:11e3,y:-500},{x:11440,y:-500},{x:11880,y:-500},{x:12320,y:-500},{x:12760,y:-500},{x:13200,y:-500},{x:12843.67,y:-675},{x:12487.33,y:-850},{x:12131,y:-1025},{x:11638,y:-1025},{x:11145,y:-1025},{x:10739.33,y:-1083.33},{x:10333.67,y:-1141.67},{x:9928,y:-1200},{x:9471,y:-1200},{x:9014,y:-1200},{x:8557,y:-1200},{x:8100,y:-1200},{x:7950,y:-1412.5},{x:7800,y:-1625},{x:7350,y:-1625},{x:6900,y:-1625},{x:6450,y:-1625},{x:6e3,y:-1625},{x:5500,y:-1625},{x:5e3,y:-1625},{x:4500,y:-1625},{x:4e3,y:-1625},{x:3500,y:-1625},{x:3e3,y:-1625},{x:2500,y:-1625},{x:2e3,y:-1625},{x:1500,y:-1625},{x:1e3,y:-1625},{x:500,y:-1625},{x:0,y:-1625},{x:-500,y:-1625},{x:-1e3,y:-1625},{x:-1440,y:-1625},{x:-1880,y:-1625},{x:-2320,y:-1625},{x:-2760,y:-1625},{x:-3200,y:-1625},{x:-3200,y:-1200},{x:-3200,y:-775},{x:-3200,y:-350},{x:-3200,y:75},{x:-3200,y:500},{x:-3200,y:925}],Matter.Body.setPosition(o,o.track[o.trackIndex]),o.do=function(){const t=this.track[this.trackIndex],e=Vector.sub(t,this.position),i=Vector.mult(Vector.normalise(e),this.accelMag*this.mass);this.force.x+=i.x,this.force.y+=i.y,Vector.magnitude(e)<20&&(this.trackIndex++,this.trackIndex===this.track.length&&(this.trackIndex=0));let s=this.trackIndex-2;s<0&&(s=this.track.length-1),ctx.beginPath(),ctx.moveTo(this.track[s].x,this.track[s].y);for(let t=0;t<5;t++)s++,s>this.track.length-1&&(s=0),ctx.lineTo(this.track[s].x,this.track[s].y);ctx.lineWidth=5,ctx.strokeStyle="rgba(255,0,155,1)",ctx.stroke(),s=this.trackIndex-2,s<0&&(s=this.track.length-1),ctx.beginPath(),ctx.arc(this.track[s].x,this.track[s].y,7,0,2*Math.PI),ctx.fillStyle="rgba(255,0,155,1)",ctx.fill();for(let t=0;t<5;t++)s++,s>this.track.length-1&&(s=0),ctx.beginPath(),ctx.arc(this.track[s].x,this.track[s].y,7,0,2*Math.PI),ctx.fill();if(this.distanceToPlayer2()<this.seeAtDistance2?(o.accelMag=.023,0!==Matter.Query.ray(map,this.position,this.playerPosRandomY()).length||m.isCloak||this.foundPlayer()):(o.accelMag=.1,this.seePlayer.recall&&this.lostPlayer()),this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke(),!(simulation.cycle%12)&&mob.length<360&&level.levelsCleared>6&&spawn.mine(this.position.x,this.position.y)}else if(this.seePlayer.recall&&this.ammo&&!(simulation.cycle%7)){this.ammo--;const t=8+Math.floor(4*Math.random())+simulation.difficultyMode,e=Vector.sub(m.pos,this.position),i=Vector.rotate(Vector.mult(Vector.normalise(e),t),.12*(Math.random()-.5));spawn.bounceBullet(this.position.x,this.position.y,Vector.add(i,Vector.mult(this.velocity,.4)))}this.checkStatus()}},slashBoss(t,e,i=80){mobs.spawn(t,e,5,i,"rgb(201,202,225)");let s=mob[mob.length-1];s.tier=1,Matter.Body.rotate(s,2*Math.PI*Math.random()),s.isBoss=!0,s.damageReduction=.11,s.startingDamageReduction=s.damageReduction,s.isInvulnerable=!1,s.frictionAir=.02,s.seeAtDistance2=1e6,s.accelMag=6e-4,s.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map,s.memory=1/0,s.seePlayerFreq=20,s.lockedOn=null,s.torqueMagnitude=24e-5*s.inertia*(Math.random()>.5?-1:1),s.delay=150,s.cd=0,s.swordRadius=50,s.swordVertex=1,s.swordRadiusMax=900+20*simulation.difficulty,s.swordRadiusGrowRate=s.swordRadiusMax*(.005+3e-4*simulation.difficulty),s.isSlashing=!1,s.swordDamage=.07*s.damageScale(),s.laserAngle=3*Math.PI/5;spawn.shield(s,t,e),s.onDamage=function(){},s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByHistory(40),this.attraction(),this.checkStatus(),this.sword()},s.swordWaiting=function(){this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<2e5&&!m.isCloak&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length&&(this.sword=this.swordGrow,Matter.Body.setVelocity(this,{x:0,y:0}),Matter.Body.setAngularVelocity(this,0),this.accelMag=0,this.damageReduction=0,this.isInvulnerable=!0,this.frictionAir=1),this.laserSword(this.vertices[this.swordVertex],this.angle+this.laserAngle)},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSword(this.vertices[this.swordVertex],this.angle+this.laserAngle),this.swordRadius+=this.swordRadiusGrowRate,this.swordRadius>this.swordRadiusMax&&(this.sword=this.swordSlash,this.spinCount=0),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()},s.swordSlash=function(){this.laserSword(this.vertices[this.swordVertex],this.angle+this.laserAngle),this.torque+=this.torqueMagnitude,this.spinCount++,this.spinCount>80&&(this.sword=this.swordWaiting,this.swordRadius=50,this.accelMag=.001*simulation.accelScale,this.cd=simulation.cycle+this.delay,this.damageReduction=this.startingDamageReduction,this.isInvulnerable=!1,this.frictionAir=.01),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()},s.laserSword=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20})),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=25,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=5,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},slasher(t,e,i=33+Math.ceil(30*Math.random())){mobs.spawn(t,e,5,i,"rgb(201,202,225)");let s=mob[mob.length-1];s.tier=1,Matter.Body.rotate(s,2*Math.PI*Math.random()),s.accelMag=8e-4*simulation.accelScale,s.torqueMagnitude=2e-5*s.inertia*(Math.random()>.5?-1:1),s.frictionStatic=0,s.friction=0,s.frictionAir=.035,s.delay=120*simulation.CDScale,s.cd=0,s.swordRadius=0,s.swordVertex=1,s.swordRadiusMax=350+5*simulation.difficulty,s.swordRadiusGrowRate=s.swordRadiusMax*(.018+6e-4*simulation.difficulty),s.isSlashing=!1,s.swordDamage=.04*s.damageScale(),s.laserAngle=3*Math.PI/5;spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.checkStatus(),this.seePlayerByHistory(15),this.attraction(),this.sword()},s.swordWaiting=function(){if(this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<2e5&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length){let t=0;for(let e=0,i=this.vertices.length;e<i;e++){const i=Vector.magnitudeSquared(Vector.sub({x:this.vertices[e].x,y:this.vertices[e].y},m.pos));i>t&&(t=i,this.swordVertex=e)}this.laserAngle=this.swordVertex/5*2*Math.PI+.6283,this.sword=this.swordGrow,this.accelMag=0}},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSword(this.vertices[this.swordVertex],this.angle+this.laserAngle),this.swordRadius+=this.swordRadiusGrowRate,(this.swordRadius>this.swordRadiusMax||this.isStunned)&&(this.sword=this.swordSlash,this.spinCount=0)},s.swordSlash=function(){this.laserSword(this.vertices[this.swordVertex],this.angle+this.laserAngle),this.torque+=this.torqueMagnitude,this.spinCount++,(this.spinCount>60||this.isStunned)&&(this.sword=this.swordWaiting,this.swordRadius=0,this.accelMag=.001*simulation.accelScale,this.cd=simulation.cycle+this.delay)},s.laserSword=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20})),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=15,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=4,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},slasher2(t,e,i=33+Math.ceil(30*Math.random())){mobs.spawn(t,e,6,i,"rgb(180,199,245)");let s=mob[mob.length-1];s.tier=2,Matter.Body.rotate(s,2*Math.PI*Math.random()),s.accelMag=.001*simulation.accelScale,s.torqueMagnitude=-12e-6*s.inertia,s.frictionStatic=0,s.friction=0,s.frictionAir=.035,s.delay=140*simulation.CDScale,s.cd=0,s.swordRadius=0,s.swordVertex=1,s.swordRadiusMax=320+3.6*simulation.difficulty,s.swordRadiusGrowRate=s.swordRadiusMax*(.011+2e-4*simulation.difficulty),s.isSlashing=!1,s.swordDamage=.03*s.damageScale(),s.laserAngle=3*Math.PI/5;spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){this.seePlayer.recall&&this.healthBar2(),this.checkStatus(),this.seePlayerByHistory(15),this.attraction(),this.sword()},s.swordWaiting=function(){this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<2e5&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length&&(this.laserAngle=-Math.PI/6,this.sword=this.swordGrow,this.accelMag=0)},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSword(this.vertices[0],this.angle+this.laserAngle),this.laserSword(this.vertices[3],this.angle+this.laserAngle+Math.PI),this.swordRadius+=this.swordRadiusGrowRate,(this.swordRadius>this.swordRadiusMax||this.isStunned)&&(this.sword=this.swordSlash,this.spinCount=0)},s.swordSlash=function(){this.laserSword(this.vertices[0],this.angle+this.laserAngle),this.laserSword(this.vertices[3],this.angle+this.laserAngle+Math.PI),this.torque+=this.torqueMagnitude,this.spinCount++,(this.spinCount>100||this.isStunned)&&(this.sword=this.swordWaiting,this.swordRadius=0,this.accelMag=.001*simulation.accelScale,this.cd=simulation.cycle+this.delay)},s.laserSword=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),best.who&&(best.who===playerBody||best.who===playerHead)&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20})),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=15,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=4,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},slasher3(t,e,i=33+Math.ceil(30*Math.random())){mobs.spawn(t,e,6,i,"rgb(95, 61, 188)");let s=mob[mob.length-1];s.tier=3,Matter.Body.rotate(s,2*Math.PI*Math.random()),Matter.Body.setDensity(s,.0012),s.accelMag=7e-4*simulation.accelScale,s.frictionStatic=0,s.friction=0,s.frictionAir=.02,s.delay=120*simulation.CDScale,s.cd=0,s.cycle=0,s.swordVertex=1,s.swordRadiusInitial=i/2,s.swordRadius=s.swordRadiusInitial,s.swordRadiusMax=800+6*simulation.difficulty,s.swordRadiusGrowRateInitial=1.15,s.swordRadiusGrowRate=s.swordRadiusGrowRateInitial,s.isSlashing=!1,s.swordDamage=.03*s.damageScale(),s.laserAngle=3*Math.PI/5;const o=s.swordRadiusMax*s.swordRadiusMax;spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){this.seePlayer.recall&&this.healthBar3(),this.checkStatus(),this.seePlayerByHistory(15),this.sword()},s.swordWaiting=function(){if(this.attraction(),this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<o&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length){let t=1/0;for(let e=0,i=this.vertices.length;e<i;e++){const i=Vector.magnitudeSquared(Vector.sub({x:this.vertices[e].x,y:this.vertices[e].y},m.pos));i<t&&(t=i,this.swordVertex=e)}this.laserAngle=this.swordVertex/6*2*Math.PI+Math.PI/6,this.sword=this.swordGrow,this.cycle=0,this.swordRadius=this.swordRadiusInitial,Matter.Body.setVelocity(this,Vector.mult(this.velocity,.5));const e=Vector.sub(this.position,this.vertices[this.swordVertex]),i=Vector.sub(this.position,m.pos),s=Matter.Vector.cross(e,i);this.torque=2e-5*this.inertia*(s>0?1:-1)}},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSpear(this.vertices[this.swordVertex],this.angle+this.laserAngle),Matter.Body.setVelocity(this,Vector.mult(this.velocity,.9)),this.cycle++,this.swordRadius*=this.swordRadiusGrowRate,this.swordRadius>this.swordRadiusMax&&(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial),(this.swordRadius<this.swordRadiusInitial||this.isStunned)&&(this.swordRadiusGrowRate=this.swordRadiusGrowRateInitial,this.sword=this.swordWaiting,this.swordRadius=0,this.cd=simulation.cycle+this.delay)},s.laserSpear=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),!best.who||best.who!==playerBody&&best.who!==playerHead||(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial,//!!!! this retracts the sword if it hits the player
m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20}))),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=15,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=4,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},slasher4(t,e,i=40){mobs.spawn(t,e,5,i,"rgb(100, 100, 100)");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.008),s.accelMag=5e-4*simulation.accelScale,s.frictionStatic=0,s.friction=0,s.frictionAir=.02,s.delay=110*simulation.CDScale,s.cd=0,s.cycle=0,s.swordVertex=1,s.swordRadiusInitial=i/2,s.swordRadius=s.swordRadiusInitial,s.swordRadiusMax=600,s.swordRadiusGrowRateInitial=1.05,s.swordRadiusGrowRate=s.swordRadiusGrowRateInitial,s.isSlashing=!1,s.swordDamage=.06*s.damageScale(),s.laserAngle=3*Math.PI/5;const o=s.swordRadiusMax*s.swordRadiusMax;spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){this.seePlayer.recall&&this.healthBar4(),this.checkStatus(),this.seePlayerByHistory(25),this.sword()},s.swordWaiting=function(){if(this.attraction(),this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<o&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length){let t=1/0;for(let e=0,i=this.vertices.length;e<i;e++){const i=Vector.magnitudeSquared(Vector.sub({x:this.vertices[e].x,y:this.vertices[e].y},m.pos));i<t&&(t=i,this.swordVertex=e)}this.laserAngle=this.swordVertex/5*2*Math.PI+Math.PI/5,this.sword=this.swordGrow,this.cycle=0,this.swordRadius=this.swordRadiusInitial,Matter.Body.setVelocity(this,Vector.mult(this.velocity,.7));const e=Vector.sub(this.position,this.vertices[this.swordVertex]),i=Vector.sub(this.position,m.pos),s=Matter.Vector.cross(e,i);this.torque=2e-5*this.inertia*(s>0?1:-1)}},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSpear(this.vertices[this.swordVertex],this.angle+this.laserAngle);const t=0===this.swordVertex?this.vertices.length-1:this.swordVertex-1;this.laserSpear(this.vertices[t],this.angle+this.laserAngle-.2);const e=this.swordVertex===this.vertices.length-1?0:this.swordVertex+1;this.laserSpear(this.vertices[e],this.angle+this.laserAngle+.2),Matter.Body.setVelocity(this,Vector.mult(this.velocity,.98)),this.cycle++,this.swordRadius*=this.swordRadiusGrowRate,this.swordRadius>this.swordRadiusMax&&(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial),(this.swordRadius<this.swordRadiusInitial||this.isStunned)&&(this.swordRadiusGrowRate=this.swordRadiusGrowRateInitial,this.sword=this.swordWaiting,this.swordRadius=0,this.cd=simulation.cycle+this.delay)},s.laserSpear=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),!best.who||best.who!==playerBody&&best.who!==playerHead||(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial,//!!!! this retracts the sword if it hits the player
m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20}))),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(0, 162, 255, 0.1)",ctx.lineWidth=15,ctx.stroke(),ctx.strokeStyle="rgba(0, 162, 255, 0.5)",ctx.lineWidth=4,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},slasher5(t,e,i=45){mobs.spawn(t,e,6,i,"rgb(255, 255, 255)");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.009),s.accelMag=7e-4,s.frictionStatic=0,s.friction=0,s.frictionAir=.04,s.swordDamage=.06*s.damageScale(),spawn.shield(s,t,e),s.onDamage=function(){},s.swords=[{index:0,long:0,cycle:262},{index:4,long:0,cycle:52}],s.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.checkStatus(),!this.isStunned){this.seePlayerByHistory(40),this.attraction(),this.torque=4e-7*this.inertia;const t=375;for(let e=0,i=this.swords.length;e<i;e++)this.swords[e].cycle++,this.swords[e].long=t*Math.sin(.007*this.swords[e].cycle),this.swords[e].long<1&&(this.swords[e].cycle=0,this.swords[e].index++,this.swords[e].index>5&&(this.swords[e].index=0)),this.laserSpear(this.vertices[this.swords[e].index],this.angle+this.swords[e].index/6*2*Math.PI+Math.PI/6,Math.max(10,this.swords[e].long))}},s.laserSpear=function(t,e,i){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const s={x:t.x+i*Math.cos(e),y:t.y+i*Math.sin(e)};best=vertexCollision(t,s,[map,body,[playerBody,playerHead]]),!best.who||best.who!==playerBody&&best.who!==playerHead||m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(255, 255, 255, 0.9)",time:20})),best.dist2===1/0&&(best=s),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(255, 255, 255, 0.2)",ctx.lineWidth=25,ctx.stroke(),ctx.strokeStyle="rgba(255, 255, 255, 1)",ctx.lineWidth=3,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},spiker(t,e,i=35+Math.ceil(30*Math.random())){mobs.spawn(t,e,6,i,"rgb(0,200,180)");let s=mob[mob.length-1];Matter.Body.setDensity(s,.0015),s.accelMag=.05,s.g=.0032,s.frictionAir=.01,s.friction=1,s.frictionStatic=1,s.restitution=0,s.delay=120*simulation.CDScale,s.randomHopFrequency=200+Math.floor(150*Math.random()),s.randomHopCD=simulation.cycle+s.randomHopFrequency,s.cd=0,s.cycle=0,s.swordVertex=1,s.swordRadiusInitial=i/2,s.swordRadius=s.swordRadiusInitial,s.swordRadiusMax=800+6*simulation.difficulty,s.swordRadiusGrowRateInitial=1.08,s.swordRadiusGrowRate=s.swordRadiusGrowRateInitial,s.isSlashing=!1,s.swordDamage=.03*s.damageScale(),s.laserAngle=3*Math.PI/5;const o=s.swordRadiusMax*s.swordRadiusMax;Matter.Body.rotate(s,Math.random()*Math.PI),spawn.shield(s,t,e),s.do=function(){if(this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.seePlayer.recall){if(this.cd<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.cd=simulation.cycle+this.delay;const t=(this.accelMag+this.accelMag*Math.random())*this.mass,e=Math.atan2(this.seePlayer.position.y-this.position.y,this.seePlayer.position.x-this.position.x);this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-(.06*Math.random()+.1)*this.mass}}else if(this.randomHopCD<simulation.cycle&&(Matter.Query.collides(this,map).length||Matter.Query.collides(this,body).length)){this.randomHopCD=simulation.cycle+this.randomHopFrequency,this.randomHopFrequency=Math.max(100,this.randomHopFrequency+200*(.5-Math.random()));const t=(this.accelMag+this.accelMag*Math.random())*this.mass*(.1+.3*Math.random()),e=-Math.PI/2+(Math.random()-.5)*Math.PI;this.force.x+=t*Math.cos(e),this.force.y+=t*Math.sin(e)-.07*this.mass}this.sword()},s.swordWaiting=function(){if(this.seePlayer.recall&&this.cd<simulation.cycle&&this.distanceToPlayer2()<o&&0===Matter.Query.ray(map,this.position,this.playerPosRandomY()).length&&0===Matter.Query.ray(body,this.position,this.playerPosRandomY()).length){let t=1/0;for(let e=0,i=this.vertices.length;e<i;e++){const i=Vector.magnitudeSquared(Vector.sub({x:this.vertices[e].x,y:this.vertices[e].y},m.pos));i<t&&(t=i,this.swordVertex=e)}this.laserAngle=this.swordVertex/6*2*Math.PI+Math.PI/6,this.sword=this.swordGrow,this.cycle=0,this.swordRadius=this.swordRadiusInitial,Matter.Body.setVelocity(this,Vector.mult(this.velocity,.5));const e=Vector.sub(this.position,this.vertices[this.swordVertex]),i=Vector.sub(this.position,m.pos),s=Matter.Vector.cross(e,i);this.torque=2e-5*this.inertia*(s>0?1:-1)}},s.sword=s.swordWaiting,s.swordGrow=function(){this.laserSpear(this.vertices[this.swordVertex],this.angle+this.laserAngle),Matter.Body.setVelocity(this,Vector.mult(this.velocity,.9)),this.cycle++,this.swordRadius*=this.swordRadiusGrowRate,this.swordRadius>this.swordRadiusMax&&(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial),(this.swordRadius<this.swordRadiusInitial||this.isStunned)&&(this.swordRadiusGrowRate=this.swordRadiusGrowRateInitial,this.sword=this.swordWaiting,this.swordRadius=0,this.cd=simulation.cycle+this.delay)},s.laserSpear=function(t,e){best={x:null,y:null,dist2:1/0,who:null,v1:null,v2:null};const i={x:t.x+this.swordRadius*Math.cos(e),y:t.y+this.swordRadius*Math.sin(e)};best=vertexCollision(t,i,[map,body,[playerBody,playerHead]]),!best.who||best.who!==playerBody&&best.who!==playerHead||(this.swordRadiusGrowRate=1/this.swordRadiusGrowRateInitial,//!!!! this retracts the sword if it hits the player
m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles+60,m.takeDamage(this.swordDamage),simulation.drawList.push({x:best.x,y:best.y,radius:1500*this.swordDamage,color:"rgba(80,0,255,0.5)",time:20}))),best.dist2===1/0&&(best=i),ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(best.x,best.y),ctx.strokeStyle="rgba(100,100,255,0.1)",ctx.lineWidth=15,ctx.stroke(),ctx.strokeStyle="rgba(100,100,255,0.5)",ctx.lineWidth=4,ctx.setLineDash([70+300*Math.random(),55*Math.random()]),ctx.stroke(),ctx.setLineDash([])}},sneakBoss(t,e,i=70){mobs.spawn(t,e,5,i,"transparent");let s=mob[mob.length-1];s.tier=2,Matter.Body.setDensity(s,.001),s.isBoss=!0,s.damageReduction=.17,s.accelMag=.0017*Math.sqrt(simulation.accelScale),s.frictionAir=.01,s.g=1e-4,s.stroke="transparent",s.alpha=1,s.isCloaked=!0,s.isBadTarget=!0,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,s.memory=30,s.vanishesLeft=3,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0;t<2;t++)spawn.sneaker(this.position.x+10*Math.random(),this.position.y+10*Math.random())},s.onDamage=function(){if(this.vanishesLeft>0&&this.health<.1){this.vanishesLeft--;for(let t=0;t<8;t++)simulation.drawList.push({x:this.position.x,y:this.position.y,radius:5e3,color:`rgba(0, 0, 0,${1-.1*t})`,time:4*(t+2)});const t=Math.floor((m.history.length-1)*(.66+.2*Math.random()));let e=m.history[(simulation.cycle-t)%600];Matter.Body.setPosition(this,e.position),Matter.Body.setVelocity(this,{x:0,y:0}),this.damageReduction=0,this.seePlayer.recall=0,this.cloak(),this.health=1;for(let t=0;t<2;t++)spawn.sneaker(this.position.x+10*Math.random(),this.position.y+10*Math.random())}},s.cloak=function(){this.isCloaked||(this.alpha=0,this.isCloaked=!0,this.isBadTarget=!0,this.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,this.damageReduction=.04)},s.deCloak=function(){this.isCloaked&&(this.damageReduction=.4,this.isCloaked=!1,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob)},s.do=function(){if(0===this.damageReduction){this.damageReduction=.04;let t=this.status.length;for(;t--;)"stun"!==this.status[t].type&&"dot"!==this.status[t].type||this.status.splice(t,1);this.isStunned=!1}if(this.gravity(),this.seePlayerByHistory(55),this.checkStatus(),this.alpha>.8&&this.attraction(),this.seePlayer.recall?this.alpha<1&&(this.alpha+=.005+.003/simulation.CDScale):this.alpha>0&&(this.alpha-=.04),this.alpha>0){this.alpha>.7&&(this.seePlayer.recall&&this.healthBar2(),this.deCloak()),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(0,0,0,${this.alpha*this.alpha})`,ctx.fill()}else this.cloak()}},sneaker(t,e,i=15+Math.ceil(10*Math.random())){mobs.spawn(t,e,5,i,"transparent");let s=mob[mob.length-1];s.tier=3,Matter.Body.setDensity(s,.0012),s.accelMag=.001*Math.sqrt(simulation.accelScale),s.frictionAir=.01,s.g=2e-4,s.stroke="transparent",s.alpha=1,s.isNotCloaked=!1,s.isBadTarget=!0,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,s.memory=240,s.isVanished=!1,s.onDamage=function(){!this.isVanished&&this.health<.1&&!this.isStunned&&!this.isSlowed&&(this.health=1,this.isVanished=!0,this.cloak(),Matter.Body.setPosition(this,m.history[Math.floor((m.history.length-1)*(.3+.4*Math.random()))].position),Matter.Body.setVelocity(this,{x:0,y:0}),this.damageReduction=0)},s.cloak=function(){this.isNotCloaked&&(this.alpha=0,this.isNotCloaked=!1,this.isBadTarget=!0,this.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob)},s.do=function(){if(0===this.damageReduction){this.damageReduction=1;let t=this.status.length;for(;t--;)"stun"!==this.status[t].type&&"dot"!==this.status[t].type||this.status.splice(t,1);this.isStunned=!1}if(this.gravity(),this.seePlayerByHistory(25),this.checkStatus(),this.attraction(),this.seePlayer.recall?this.alpha<1&&(this.alpha+=.003+.003/simulation.CDScale):this.alpha>0&&(this.alpha-=.03),this.alpha>0){this.alpha>.7&&(this.seePlayer.recall&&this.healthBar3(),this.isNotCloaked||(this.isNotCloaked=!0,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob)),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(0,0,0,${this.alpha*this.alpha})`,ctx.fill()}else this.cloak()}},sneakyStriker(t,e,i=35){mobs.spawn(t,e,7,i,"transparent");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.005),s.accelMag=.001,s.frictionAir=.01,s.g=2e-4,s.stroke="transparent",s.alpha=1,s.isNotCloaked=!1,s.isBadTarget=!0,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,s.memory=180,s.isVanished=!1,s.delay=40,s.cd=0,s.strikeRange=500,s.onDamage=function(){this.cd=simulation.cycle+this.delay,!this.isVanished&&this.health<.1&&!this.isStunned&&!this.isSlowed&&(this.health=1,this.isVanished=!0,this.cloak(),Matter.Body.setPosition(this,m.history[Math.floor((m.history.length-1)*(.3+.4*Math.random()))].position),Matter.Body.setVelocity(this,{x:0,y:0}),this.damageReduction=0)},s.cloak=function(){this.isNotCloaked&&(this.alpha=0,this.isNotCloaked=!1,this.isBadTarget=!0,this.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob)},s.do=function(){if(0===this.damageReduction){this.damageReduction=1;let t=this.status.length;for(;t--;)"stun"!==this.status[t].type&&"dot"!==this.status[t].type||this.status.splice(t,1);this.isStunned=!1}if(this.gravity(),!(simulation.cycle%this.seePlayerFreq))if(0!==Matter.Query.ray(map,this.position,this.playerPosRandomY()).length||m.isCloak){if(this.seePlayer.recall&&(this.lostPlayer(),!m.isCloak)){for(let t=0;t<20;t++){let e=m.history[(simulation.cycle-10*t)%600];if(0===Matter.Query.ray(map,this.position,e.position).length){this.seePlayer.recall=this.memory+Math.round(this.memory*Math.random()),this.seePlayer.position.x=e.position.x,this.seePlayer.position.y=e.position.y,this.seePlayer.yes=!0,this.cd===1/0&&(this.cd=simulation.cycle+.7*this.delay);break}}this.seePlayer.yes||(this.cd=1/0)}}else this.foundPlayer();if(this.checkStatus(),this.attraction(),this.seePlayer.recall?this.alpha<1&&(this.alpha+=.003+.003/simulation.CDScale):this.alpha>0&&(this.alpha-=.03),this.alpha>0){if(this.alpha>.7&&(this.seePlayer.recall&&this.healthBar4(),this.isNotCloaked||(this.isNotCloaked=!0,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob),this.cd<simulation.cycle&&this.seePlayer.recall)){const t=Vector.sub(this.seePlayer.position,this.position),e=Vector.magnitude(t)-10-i;if(e>250){this.cd=simulation.cycle+this.delay,ctx.beginPath(),ctx.moveTo(this.position.x,this.position.y);let s=Math.min(e-10-i,this.strikeRange);Matter.Body.translate(this,Vector.mult(Vector.normalise(t),s)),ctx.lineTo(this.position.x,this.position.y),ctx.lineWidth=2.2*i,ctx.strokeStyle="rgba(0,0,0,0.6)",ctx.stroke(),Matter.Body.setVelocity(this,{x:.4*this.velocity.x,y:.4*this.velocity.y})}}ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(0,0,0,${this.alpha*this.alpha})`,ctx.fill()}else this.cloak()}},ghoster(t,e,i=50+Math.ceil(90*Math.random())){mobs.spawn(t,e,7,i,"transparent");let s=mob[mob.length-1];s.tier=3,s.seeAtDistance2=5e5,s.accelMag=2e-4+1e-4*simulation.accelScale,map.length&&(s.searchTarget=map[Math.floor(Math.random()*(map.length-1))].position),Matter.Body.setDensity(s,18e-5),s.damageReduction=.1,s.stroke="transparent",s.alpha=1,s.isNotCloaked=!1,s.isBadTarget=!0,s.collisionFilter.mask=cat.bullet|cat.body,s.memory=900,s.delay=60,s.cd=0,s.onHit=function(){if(this.cd<simulation.cycle&&(this.cd=simulation.cycle+this.delay,b.inventory.length)){let t=!1;const e=3;for(let i=0;i<e;i++)for(let e=0;e<b.inventory.length;e++){const i=b.guns[b.inventory[e]];i.ammo>0&&i.ammo!==1/0&&(i.ammo-=Math.ceil(1.1*(Math.random()+Math.random())*i.ammoPack),i.ammo<0&&(i.ammo=0),t=!0)}if(t){simulation.updateGunHUD();for(let t=0;t<e;t++)powerUps.directSpawn(this.position.x+10*Math.random(),this.position.y+10*Math.random(),"ammo");powerUps.ejectGraphic()}}},s.onDamage=function(){this.health<.8&&(s.seeAtDistance2=2e6)},s.do=function(){if(this.speed>6&&Matter.Body.setVelocity(this,{x:.8*this.velocity.x,y:.8*this.velocity.y}),this.seePlayerCheckByDistance(),this.checkStatus(),this.attraction(),this.search(),this.distanceToPlayer2()<this.seeAtDistance2?this.alpha<1&&(this.alpha+=.011*simulation.CDScale):this.alpha>0&&(this.alpha-=.05),this.alpha>0){this.alpha>.7&&this.seePlayer.recall&&(this.seePlayer.recall&&this.healthBar3(),this.isNotCloaked||(this.isNotCloaked=!0,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.bullet|cat.body)),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(255,255,255,${this.alpha*this.alpha})`,ctx.fill()}else this.isNotCloaked&&(this.isNotCloaked=!1,this.isBadTarget=!0,this.collisionFilter.mask=cat.bullet|cat.body)}},bomberBoss(t,e,i=88){mobs.spawn(t,e,3,i,"rgba(255,0,200,0.5)");let s=mob[mob.length-1];s.tier=3,s.isBoss=!0,Matter.Body.setDensity(s,.0025+9e-5*Math.sqrt(simulation.difficulty)),s.stroke="transparent",s.seeAtDistance2=15e5,s.fireFreq=10+Math.floor(70*simulation.CDScale),s.searchTarget=map[Math.floor(Math.random()*(map.length-1))].position,s.hoverElevation=460+200*(Math.random()-.5),s.hoverXOff=100*(Math.random()-.5),s.accelMag=1e-5*Math.floor(10*(Math.random()+4.5))*simulation.accelScale,s.g=2e-4,s.frictionStatic=0,s.friction=0,s.frictionAir=.01,s.memory=1/0,s.collisionFilter.mask=cat.player|cat.bullet|cat.body,spawn.shield(s,t,e,1);const o=Math.floor(Math.min(15,3+Math.sqrt(simulation.difficulty))),a=.007+.003*Math.random()+.004*Math.sqrt(simulation.difficulty);let n=i+125+350*Math.random();for(let t=0;t<o;t++)spawn.orbital(s,n,t/o*2*Math.PI,a);n=i+125+350*Math.random();for(let t=0;t<o;t++)spawn.orbital(s,n,t/o*2*Math.PI,-a);s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.damageReduction=.22,s.do=function(){this.seePlayer.recall&&this.healthBar3(),this.seePlayerCheckByDistance(),this.checkStatus(),this.seePlayer.recall&&(this.hoverOverPlayer(),this.bomb(),this.search())}},shooter(t,e,i=25+Math.ceil(50*Math.random())){mobs.spawn(t,e,3,i,"rgb(255,100,150)");let s=mob[mob.length-1];s.tier=1,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.isVerticesChange=!0,s.memory=120,s.fireFreq=.007+.005*Math.random(),s.noseLength=0,s.fireAngle=0,s.accelMag=5e-4*simulation.accelScale,s.frictionStatic=0,s.friction=0,s.frictionAir=.05,s.lookTorque=25e-7*(Math.random()>.5?-1:1),s.fireDir={x:0,y:0},s.onDeath=function(){},spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByLookingAt(),this.checkStatus(),this.fire()}},shooterBoss(t,e,i=110,s=!0){mobs.spawn(t,e,3,i,"rgb(255,70,180)");let o=mob[mob.length-1];o.tier=1,setTimeout(()=>{o.constraint=Constraint.create({pointA:{x:o.position.x,y:o.position.y},bodyB:o,stiffness:4e-5,damping:.2}),Composite.add(engine.world,o.constraint)},2e3),o.isBoss=!0,Matter.Body.setDensity(o,.01+3e-4*Math.sqrt(simulation.difficulty)),o.damageReduction=.22,o.vertices=Matter.Vertices.rotate(o.vertices,Math.PI,o.position),o.isVerticesChange=!0,o.memory=240,o.fireFreq=.01+5e-4*Math.min(40,simulation.difficulty),o.noseLength=0,o.fireAngle=0,o.accelMag=.005*simulation.accelScale,o.frictionAir=.05,o.lookTorque=6e-6*(Math.random()>.5?-1:1),o.fireDir={x:0,y:0},setTimeout(()=>{for(let t=0,e=3+.5*Math.sqrt(simulation.difficulty);t<e;t++)spawn.spawnOrbitals(o,i+40+10*t,1)},100),o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByLookingAt(),this.checkStatus();const t=()=>{const t=this.radius+this.radius*this.noseLength;this.vertices[1].x=this.position.x+Math.cos(this.angle)*t,this.vertices[1].y=this.position.y+Math.sin(this.angle)*t};if(this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)),this.fireDir.y-=Math.abs(this.seePlayer.position.x-this.position.x)/5e3);const e=this.angle+Math.PI/2,i=Vector.dot({x:Math.cos(e),y:Math.sin(e)},this.fireDir),s=.1;if(i>s)this.torque+=4e-6*this.inertia;else if(i<-s)this.torque-=4e-6*this.inertia;else if(this.noseLength>1.5&&i>-.2&&i<.2){for(let t=0,e=2+.07*simulation.difficulty;t<e;t++){spawn.bullet(this.vertices[1].x,this.vertices[1].y,this.tier,10+Math.ceil(this.radius/25));const t=Vector.rotate({x:Math.sqrt(e)+4,y:0},2*Math.PI*Math.random()),i=Vector.add(Vector.mult(this.fireDir,25),t);Matter.Body.setVelocity(mob[mob.length-1],i)}this.noseLength=0}this.noseLength<1.5&&(this.noseLength+=this.fireFreq),t()}else this.noseLength>.1&&(this.noseLength-=this.fireFreq/2,t())}},bullet(t,e,i,s=9,o=0){mobs.spawn(t,e,o,s,"rgb(255,0,0)");let a=mob[mob.length-1];a.tier=i,a.stroke="transparent",a.onHit=function(){this.explode(15*this.mass)},Matter.Body.setDensity(a,4e-5),a.timeLeft=220,a.g=.001,a.frictionAir=0,a.restitution=.8,a.leaveBody=!1,a.isDropPowerUp=!1,a.isBadTarget=!0,a.isMobBullet=!0,a.collisionFilter.category=cat.mobBullet,a.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,a.do=function(){this.gravity(),this.timeLimit()}},bomb(t,e,i=9,s=5){mobs.spawn(t,e,s,i,"rgb(255,0,0)");let o=mob[mob.length-1];o.stroke="transparent",o.onHit=function(){this.explode(120*this.mass)},o.onDeath=function(){spawn.bullet(this.position.x,this.position.y,this.tier,this.radius/3,5),spawn.bullet(this.position.x,this.position.y,this.tier,this.radius/3,5),spawn.bullet(this.position.x,this.position.y,this.tier,this.radius/3,5);const t=Vector.rotate({x:1,y:1},2*Math.PI*Math.random()),e=Vector.rotate({x:1,y:1},2*Math.PI*Math.random()),i=Vector.normalise(Vector.add(t,e));Matter.Body.setVelocity(mob[mob.length-1],{x:8*t.x,y:8*t.y}),Matter.Body.setVelocity(mob[mob.length-2],{x:8*e.x,y:8*e.y}),Matter.Body.setVelocity(mob[mob.length-3],{x:-8*i.x,y:-8*i.y})},Matter.Body.setDensity(o,5e-5),o.timeLeft=140+Math.floor(30*Math.random()),o.g=.001,o.frictionAir=0,o.restitution=1,o.leaveBody=!1,o.isDropPowerUp=!1,o.isBadTarget=!0,o.isMobBullet=!0,o.collisionFilter.category=cat.mobBullet,o.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,o.do=function(){this.gravity(),this.timeLimit()}},sniper(t,e,i=35+Math.ceil(30*Math.random())){mobs.spawn(t,e,3,i,"transparent");let s=mob[mob.length-1];s.tier=3,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.isVerticesChange=!0,Matter.Body.setDensity(s,.0012),s.stroke="transparent",s.alpha=1,s.frictionStatic=0,s.friction=0,s.isNotCloaked=!1,s.isBadTarget=!0,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,s.memory=60,s.fireFreq=.01+.002*Math.random(),s.noseLength=0,s.fireAngle=0,s.accelMag=9e-4*simulation.accelScale,s.frictionAir=.05,s.torque=12e-5*s.inertia,s.fireDir={x:0,y:0},s.onDeath=function(){},spawn.shield(s,t,e),s.do=function(){this.seePlayerCheck(),this.checkStatus();const t=()=>{const t=this.radius+this.radius*this.noseLength;this.vertices[1].x=this.position.x+Math.cos(this.angle)*t,this.vertices[1].y=this.position.y+Math.sin(this.angle)*t};if(this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const e=this.angle+Math.PI/2,i=Vector.dot({x:Math.cos(e),y:Math.sin(e)},this.fireDir),s=.03;if(i>s)this.torque+=4e-6*this.inertia;else if(i<-s)this.torque-=4e-6*this.inertia;else if(this.noseLength>1.5&&i>-.2&&i<.2){spawn.sniperBullet(this.vertices[1].x,this.vertices[1].y,7+Math.ceil(this.radius/15),5);const t=20+Math.floor(20*Math.random());Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+this.fireDir.x*t+Math.random(),y:this.velocity.y+this.fireDir.y*t+Math.random()}),this.noseLength=0,this.force.x-=.006*this.fireDir.x*this.mass,this.force.y-=.006*this.fireDir.y*this.mass}this.noseLength<1.5&&(this.noseLength+=this.fireFreq),t()}else this.noseLength>.1&&(this.noseLength-=this.fireFreq/2,t());if(this.seePlayer.recall?this.alpha<1&&(this.alpha+=.01):this.alpha>0&&(this.alpha-=.03),this.alpha>0){this.alpha>.95&&(this.seePlayer.recall&&this.healthBar3(),this.isNotCloaked||(this.isNotCloaked=!0,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob)),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(25,0,50,${this.alpha*this.alpha})`,ctx.fill()}else this.isNotCloaked&&(this.isNotCloaked=!1,this.isBadTarget=!0,this.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob)}},sniperBullet(t,e,i=9,s=5,o=!0){mobs.spawn(t,e,s,i,"rgb(255,0,155)");let a=mob[mob.length-1];a.tier=3,a.stroke="transparent",a.onHit=function(){this.explode(20*this.mass)},Matter.Body.setDensity(a,5e-5),a.timeLeft=120,a.frictionAir=0,a.restitution=0,a.leaveBody=!1,a.isDropPowerUp=!1,a.isBadTarget=!0,a.isMobBullet=!0,a.collisionFilter.category=cat.mobBullet,a.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,a.onDeath=function(){if(o){const t=100+50*Math.random();m.immuneCycle<m.cycle&&Vector.magnitude(Vector.sub(this.position,player.position))<t&&m.takeDamage(3e-4*t*this.damageScale()),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:t,color:"rgba(255,0,155,0.5)",time:simulation.drawTime})}},a.do=function(){this.timeLimit(),(Matter.Query.collides(this,map).length>0||Matter.Query.collides(this,body).length>0&&this.speed<10)&&(this.isDropPowerUp=!1,this.death())}},launcherOne(t,e,i=30+Math.ceil(40*Math.random())){mobs.spawn(t,e,3,i,"rgb(150,150,255)");let s=mob[mob.length-1];s.tier=3,Matter.Body.setDensity(s,.0012),s.accelMag=1e-4,s.fireFreq=330,s.frictionStatic=0,s.friction=0,s.frictionAir=.01,spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall&&!(simulation.cycle%this.fireFreq)){Matter.Body.setAngularVelocity(this,.14),spawn.seeker(this.vertices[0].x,this.vertices[0].y,this.tier,20,9);const t=mob[mob.length-1];Matter.Body.setDensity(t,5e-5),t.timeLeft=840,t.accelMag=5e-4,t.frictionAir=.01;const e=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(this.position,this.vertices[0]))),-6);Matter.Body.setVelocity(t,{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}}},launcher(t,e,i=30+Math.ceil(40*Math.random())){mobs.spawn(t,e,3,i,"rgb(150,150,255)");let s=mob[mob.length-1];s.tier=1,s.accelMag=4e-5*simulation.accelScale,s.fireFreq=Math.floor(420+90*Math.random()*simulation.CDScale),s.frictionStatic=0,s.friction=0,s.frictionAir=.02,spawn.shield(s,t,e),s.onDamage=function(){},s.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall&&!(simulation.cycle%this.fireFreq)){Matter.Body.setAngularVelocity(this,.14);for(let t=0,e=this.vertices.length;t<e;t++){spawn.seeker(this.vertices[t].x,this.vertices[t].y,this.tier,7);const e=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(this.position,this.vertices[t]))),-8);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}}}},launchPusher(t,e,i=30){mobs.spawn(t,e,5,i,"rgb(150,150,255)");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.0048),s.accelMag=.001,s.fireFreq=240+Math.floor(30*Math.random()),s.frictionStatic=0,s.friction=0,s.frictionAir=.1,spawn.shield(s,t,e),s.onDamage=function(){},s.pushAway=function(t=.04,e=.03){const i=81e4;for(let s=0,o=body.length;s<o;++s)Vector.magnitudeSquared(Vector.sub(body[s].position,this.position))<i&&(body[s].force.x+=t*body[s].mass*(body[s].position.x>this.position.x?1:-1),body[s].force.y-=e*body[s].mass);for(let s=0,o=mob.length;s<o;++s)mob[s].speed<30&&mob[s].isMobBullet&&Vector.magnitudeSquared(Vector.sub(mob[s].position,this.position))<i&&(mob[s].force.x+=.8*t*mob[s].mass*(mob[s].position.x>this.position.x?1:-1),mob[s].force.y-=.8*e*mob[s].mass);for(let s=0,o=powerUp.length;s<o;++s)Vector.magnitudeSquared(Vector.sub(powerUp[s].position,this.position))<i&&(powerUp[s].force.x+=t*powerUp[s].mass*(powerUp[s].position.x>this.position.x?1:-1),powerUp[s].force.y-=e*powerUp[s].mass);Vector.magnitudeSquared(Vector.sub(player.position,this.position))<i&&(player.force.x+=t*player.mass*(player.position.x>this.position.x?1:-1),player.force.y-=e*player.mass)},s.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.seePlayer.recall&&!(simulation.cycle%this.fireFreq)){this.pushAway(),Matter.Body.setAngularVelocity(this,.15);for(let t=0,e=this.vertices.length;t<e;t++){spawn.seeker(this.vertices[t].x,this.vertices[t].y,this.tier,7);const e=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(this.vertices[t],this.position))),10+Math.floor(3*Math.random()));Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}simulation.drawList.push({x:this.position.x,y:this.position.y,radius:1e3,color:"rgb(100,100,100,0.05)",time:simulation.drawTime})}}},launcherBoss(t,e,i=90,s=!0){mobs.spawn(t,e,6,i,"rgb(150,150,255)");let o=mob[mob.length-1];o.tier=1,o.isBoss=!0,Matter.Body.setDensity(o,.0022+15e-5*Math.sqrt(simulation.difficulty)),o.damageReduction=.22,o.accelMag=1e-4*simulation.accelScale,o.fireFreq=Math.floor(330*simulation.CDScale),o.frictionStatic=0,o.friction=0,o.frictionAir=.02,o.memory=420,o.repulsionRange=1e6,spawn.shield(o,t,e,1),spawn.spawnOrbitals(o,i+50+200*Math.random()),o.onDeath=function(){s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.onDamage=function(){},o.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.repulsion(),this.seePlayer.recall&&!(simulation.cycle%this.fireFreq)){Matter.Body.setAngularVelocity(this,.11);for(let t=0,e=this.vertices.length;t<e;t++){spawn.seeker(this.vertices[t].x,this.vertices[t].y,this.tier,8);const e=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(this.position,this.vertices[t]))),-10);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}}}},fabricatorBoss(t,e,i=90,s=!0){mobs.spawn(t,e,6,i,"#000");let o=mob[mob.length-1];o.tier=4,o.isBoss=!0,Matter.Body.setDensity(o,.0022+15e-5*Math.sqrt(simulation.difficulty)),o.damageReduction=.22,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.8,o.invulnerableCount=0,o.accelMag=3e-4,o.fireFreq=240,o.frictionStatic=0,o.friction=0,o.frictionAir=.02,o.memory=420,o.repulsionRange=1e6,spawn.shield(o,t,e,1),o.onDeath=function(){for(let t=0,e=6;t<e;t++){spawn.grenade(this.position.x,this.position.y,this.tier);const i=mob[mob.length-1],s=7,o=2*Math.PI*t/e+this.angle;Matter.Body.setVelocity(i,{x:s*Math.cos(o),y:s*Math.sin(o)})}s&&powerUps.spawnBossPowerUp(this.position.x,this.position.y)},o.onDamage=function(){if(this.health<this.nextHealthThreshold){this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=60+10*simulation.difficultyMode,this.isInvulnerable=!0,this.damageReduction=0;for(let t=0,e=6;t<e;t++){spawn.grenade(this.position.x,this.position.y,this.tier);const i=mob[mob.length-1],s=7,o=2*Math.PI*t/e+this.angle;Matter.Body.setVelocity(i,{x:s*Math.cos(o),y:s*Math.sin(o)})}}},o.do=function(){if(this.seePlayer.recall&&this.healthBar4(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.repulsion(),this.seePlayer.recall&&!(simulation.cycle%this.fireFreq)&&mob.length<300){for(let t=0,e=6;t<e;t++)spawn.orbital(o,3*this.radius,t/e*2*Math.PI+this.angle,.01);Matter.Body.setAngularVelocity(this,.11);for(let t=0,e=this.vertices.length;t<e;t++){spawn.seeker(this.vertices[t].x,this.vertices[t].y,this.tier,8);const e=Vector.mult(Vector.perp(Vector.normalise(Vector.sub(this.position,this.vertices[t]))),-10);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}}if(this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=15+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}}},grenadierBoss(t,e,i=95){mobs.spawn(t,e,6,i,"rgb(0,235,255)");let s=mob[mob.length-1];s.tier=1,s.isBoss=!0,s.accelMag=1e-4*simulation.accelScale,s.fireFreq=Math.floor(360*simulation.CDScale),s.frictionStatic=0,s.friction=0,s.frictionAir=.035,s.memory=420,s.repulsionRange=12e5,spawn.spawnOrbitals(s,i+50,1),spawn.spawnOrbitals(s,i+125,1),spawn.spawnOrbitals(s,i+200,1),Matter.Body.setDensity(s,.004+15e-5*Math.sqrt(simulation.difficulty)),s.onDeath=function(){setTimeout(()=>{for(let t=0,e=6;t<e;t++){const i=2.25*simulation.accelScale,s=2*Math.PI*t/e;spawn.grenade(this.position.x,this.position.y,this.tier,170*simulation.CDScale);const o=mob[mob.length-1];Matter.Body.setVelocity(o,{x:i*Math.cos(s),y:i*Math.sin(s)})}},200),powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.grenadeLimiter=0,s.onDamage=function(){if(this.grenadeLimiter<240&&this.health>0){this.grenadeLimiter+=60,spawn.grenade(this.position.x,this.position.y,this.tier,80+Math.floor(60*Math.random())),who=mob[mob.length-1];const t=Vector.mult(Vector.normalise(Vector.sub(player.position,who.position)),3*Math.sqrt(simulation.accelScale)+4*Math.random());Matter.Body.setVelocity(who,{x:this.velocity.x+t.x,y:this.velocity.y+t.y})}},s.damageReduction=.27,s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.grenadeLimiter>1&&this.grenadeLimiter--,this.seePlayerCheck(),this.checkStatus(),this.attraction()}},grenadier(t,e,i=50){mobs.spawn(t,e,3,i,"rgb(0,235,255)");let s=mob[mob.length-1];s.tier=1,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.isVerticesChange=!0,s.frictionStatic=0,s.friction=0,s.memory=60,s.fireFreq=.0055+.0015*Math.random(),s.noseLength=0,s.fireAngle=0,s.accelMag=6e-4*simulation.accelScale,s.frictionAir=.05,s.torque=1e-4*s.inertia*(Math.random()>.5?-1:1),s.fireDir={x:0,y:0},s.onDeath=function(){},spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerCheck(),this.checkStatus();const t=()=>{const t=this.radius+this.radius*this.noseLength;this.vertices[1].x=this.position.x+Math.cos(this.angle)*t,this.vertices[1].y=this.position.y+Math.sin(this.angle)*t};if(this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const e=this.angle+Math.PI/2,i=Vector.dot({x:Math.cos(e),y:Math.sin(e)},this.fireDir),s=.03;if(i>s)this.torque+=4e-6*this.inertia;else if(i<-s)this.torque-=4e-6*this.inertia;else if(this.noseLength>1.5&&i>-.2&&i<.2){const t=15,e=Vector.magnitude(Vector.sub(this.position,player.position));spawn.grenade(this.vertices[1].x,this.vertices[1].y,this.tier,Math.max(40,Math.min(e/t,240))),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+this.fireDir.x*t+Math.random(),y:this.velocity.y+this.fireDir.y*t+Math.random()}),this.noseLength=0,this.force.x-=.005*this.fireDir.x*this.mass,this.force.y-=.005*this.fireDir.y*this.mass}this.noseLength<1.5&&(this.noseLength+=this.fireFreq),t()}else this.noseLength>.1&&(this.noseLength-=this.fireFreq/2,t())}},freezer(t,e,i=40){mobs.spawn(t,e,3,i,"rgb(0,0,255)");let s=mob[mob.length-1];s.tier=3,s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.isVerticesChange=!0,Matter.Body.setDensity(s,.0012),s.frictionStatic=0,s.friction=0,s.memory=60,s.fireFreq=.0055+.0015*Math.random(),s.noseLength=0,s.fireAngle=0,s.accelMag=6e-4*simulation.accelScale,s.frictionAir=.05,s.torque=1e-4*s.inertia*(Math.random()>.5?-1:1),s.fireDir={x:0,y:0},s.onDeath=function(){setTimeout(()=>{spawn.freezeGrenade(this.position.x,this.position.y,this.tier)},200)},spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar3(),this.seePlayerCheck(),this.checkStatus();const t=()=>{const t=this.radius+this.radius*this.noseLength;this.vertices[1].x=this.position.x+Math.cos(this.angle)*t,this.vertices[1].y=this.position.y+Math.sin(this.angle)*t};if(this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const e=this.angle+Math.PI/2,i=Vector.dot({x:Math.cos(e),y:Math.sin(e)},this.fireDir),s=.03;if(i>s)this.torque+=4e-6*this.inertia;else if(i<-s)this.torque-=4e-6*this.inertia;else if(this.noseLength>1.5&&i>-.2&&i<.2){const t=10,e=Vector.magnitude(Vector.sub(this.position,player.position));spawn.freezeGrenade(this.vertices[1].x,this.vertices[1].y,this.tier,Math.max(40,Math.min(e/t))),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+this.fireDir.x*t+Math.random(),y:this.velocity.y+this.fireDir.y*t+Math.random()}),this.noseLength=0,this.force.x-=.005*this.fireDir.x*this.mass,this.force.y-=.005*this.fireDir.y*this.mass}this.noseLength<1.5&&(this.noseLength+=this.fireFreq),t()}else this.noseLength>.1&&(this.noseLength-=this.fireFreq/2,t())}},mortar(t,e,i=40+Math.ceil(20*Math.random())){mobs.spawn(t,e,3,i,"transparent");let s=mob[mob.length-1];s.tier=4,Matter.Body.setDensity(s,.0055),s.vertices=Matter.Vertices.rotate(s.vertices,Math.PI,s.position),s.isVerticesChange=!0,s.stroke="transparent",s.alpha=1,s.isNotCloaked=!1,s.isBadTarget=!0,s.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob,s.frictionStatic=0,s.friction=0,s.memory=60,s.fireFreq=.011,s.noseLength=0,s.fireAngle=0,s.accelMag=.001,s.frictionAir=.05,s.torque=1e-4*s.inertia*(Math.random()>.5?-1:1),s.fireDir={x:0,y:0},s.onDeath=function(){setTimeout(()=>{for(let t=0,e=3;t<e;t++){const i=2.25*simulation.accelScale,s=2*Math.PI*t/e;spawn.grenade(this.position.x,this.position.y,this.tier,170*simulation.CDScale);const o=mob[mob.length-1];Matter.Body.setVelocity(o,{x:i*Math.cos(s),y:i*Math.sin(s)})}},200)},spawn.shield(s,t,e),s.do=function(){this.seePlayerCheck(),this.checkStatus();const t=()=>{const t=this.radius+this.radius*this.noseLength;this.vertices[1].x=this.position.x+Math.cos(this.angle)*t,this.vertices[1].y=this.position.y+Math.sin(this.angle)*t};if(this.seePlayer.recall){simulation.cycle%this.seePlayerFreq||(this.fireDir=Vector.normalise(Vector.sub(this.seePlayer.position,this.position)));const e=this.angle+Math.PI/2,i=Vector.dot({x:Math.cos(e),y:Math.sin(e)},this.fireDir),s=.03;if(i>s)this.torque+=4e-6*this.inertia;else if(i<-s)this.torque-=4e-6*this.inertia;else if(this.noseLength>1.5&&i>-.2&&i<.2){const t=Vector.magnitude(Vector.sub(this.position,player.position));for(let e=0;e<4;e++){const e=Vector.rotate(Vector.mult(this.fireDir,11+7*Math.random()),.4*(Math.random()-.5)),i=Vector.magnitude(e);spawn.grenade(this.vertices[1].x,this.vertices[1].y,this.tier,Math.max(40,Math.min(t/i,240))),Matter.Body.setVelocity(mob[mob.length-1],Vector.add(this.velocity,e))}this.noseLength=0,this.force.x-=.005*this.fireDir.x*this.mass,this.force.y-=.005*this.fireDir.y*this.mass}this.noseLength<1.5&&(this.noseLength+=this.fireFreq),t()}else this.noseLength>.1&&(this.noseLength-=this.fireFreq/2,t());if(this.seePlayer.recall?this.alpha<1&&(this.alpha+=.01):this.alpha>0&&(this.alpha-=.03),this.alpha>0){this.alpha>.95&&(this.seePlayer.recall&&this.healthBar4(),this.isNotCloaked||(this.isNotCloaked=!0,this.isBadTarget=!1,this.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob)),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.fillStyle=`rgba(25,0,50,${this.alpha*this.alpha})`,ctx.fill()}else this.isNotCloaked&&(this.isNotCloaked=!1,this.isBadTarget=!0,this.collisionFilter.mask=cat.map|cat.body|cat.bullet|cat.mob)}},grenade(t,e,i,s=90+Math.ceil(60/simulation.accelScale),o=Math.min(550,250+3*simulation.difficulty),a=3){mobs.spawn(t,e,4,a,"rgb(215,0,190)");let n=mob[mob.length-1];n.tier=i,n.stroke="transparent",n.onHit=function(){this.explode(this.mass)},Matter.Body.setDensity(n,4e-5),n.lifeSpan=s,n.timeLeft=n.lifeSpan,n.frictionAir=0,n.restitution=.8,n.leaveBody=!1,n.isDropPowerUp=!1,n.isBadTarget=!0,n.isMobBullet=!0,n.onDeath=function(){Vector.magnitude(Vector.sub(player.position,this.position))<o&&m.immuneCycle<m.cycle&&(m.immuneCycle=m.cycle+m.collisionImmuneCycles,m.takeDamage(.015*this.damageScale())),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:o,color:"rgba(255,0,220,0.4)",time:simulation.drawTime})},n.collisionFilter.category=cat.mobBullet,n.collisionFilter.mask=cat.map|cat.body|cat.player,n.do=function(){this.timeLimit(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o*(1.01-this.timeLeft/this.lifeSpan),0,2*Math.PI),ctx.fillStyle="rgba(255,0,220,0.05)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o,0,2*Math.PI),ctx.fillStyle="rgba(255,0,220,0.02)",ctx.fill(),ctx.strokeStyle="rgba(255,0,220,0.4)",ctx.lineWidth=1,ctx.stroke()}},freezeGrenade(t,e,i=null,s=90,o=230+10*i,a=3){mobs.spawn(t,e,4,a,"rgb(0,0,255)");let n=mob[mob.length-1];n.tier=i,n.stroke="transparent",n.onHit=function(){this.explode(this.mass)},Matter.Body.setDensity(n,4e-5),n.lifeSpan=s,n.timeLeft=n.lifeSpan,n.frictionAir=0,n.restitution=.8,n.leaveBody=!1,n.isDropPowerUp=!1,n.isBadTarget=!0,n.isMobBullet=!0,n.onDeath=function(){simulation.ephemera.push({count:210+10*i,position:{x:n.position.x,y:n.position.y},level:level.levelsCleared,radius:o,do(){this.count--,(this.count<0||this.level!==level.levelsCleared)&&simulation.removeEphemera(this),this.radius*=.994,Vector.magnitude(Vector.sub(player.position,this.position))<this.radius+40&&(Matter.Body.setVelocity(player,{x:.7*player.velocity.x,y:.94*player.velocity.y}),ctx.beginPath(),ctx.arc(m.pos.x,m.pos.y,34,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,255,0.2)",ctx.lineWidth=8,ctx.stroke(),m.immuneCycle<m.cycle&&m.takeDamage(23e-5*spawn.dmgToPlayerByLevelsCleared()));for(let t=0;t<bullet.length;t++)Vector.magnitude(Vector.sub(bullet[t].position,this.position))<this.radius+40&&Matter.Body.setVelocity(bullet[t],{x:.95*bullet[t].velocity.x,y:.97*bullet[t].velocity.y});ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI),ctx.fillStyle=`rgba(0,0,255,${.2+.1*Math.random()})`,ctx.fill()}})},n.collisionFilter.category=cat.mobBullet,n.collisionFilter.mask=cat.map|cat.body|cat.player,n.do=function(){this.timeLimit(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o*(1.01-this.timeLeft/this.lifeSpan),0,2*Math.PI),ctx.fillStyle="rgba(0,0,255,0.05)",ctx.fill(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,o,0,2*Math.PI),ctx.fillStyle="rgba(0,0,255,0.02)",ctx.fill(),ctx.strokeStyle="rgba(0,0,255,0.4)",ctx.lineWidth=1,ctx.stroke()}},shieldingBoss(t,e,i=200){mobs.spawn(t,e,9,i,"rgb(150, 150, 255)");let s=mob[mob.length-1];s.tier=1,setTimeout(()=>{s.constraint=Constraint.create({pointA:{x:s.position.x,y:s.position.y},bodyB:s,stiffness:1e-4,damping:1}),Composite.add(engine.world,s.constraint)},2e3),Matter.Body.rotate(s,2*Math.random()*Math.PI),s.isBoss=!0,s.cycle=0,s.maxCycles=140,s.frictionStatic=0,s.friction=0,s.frictionAir=1,spawn.shield(s,t,e,1),spawn.spawnOrbitals(s,i+50+200*Math.random()),Matter.Body.setDensity(s,.006),s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0;t<mob.length;t++)mob[t].shield&&mob[t].death()},s.onDamage=function(){this.cycle=0},s.damageReduction=.39,s.do=function(){this.seePlayer.recall&&this.healthBar1(),Matter.Body.rotate(this,.003),this.checkStatus(),ctx.beginPath(),ctx.moveTo(this.vertices[this.vertices.length-1].x,this.vertices[this.vertices.length-1].y);const t=(this.vertices.length+1)*this.cycle/this.maxCycles;t>1&&ctx.lineTo(this.vertices[0].x,this.vertices[0].y);for(let e=1;e<t-1;e++)ctx.lineTo(this.vertices[e].x,this.vertices[e].y);if(ctx.lineWidth=5,ctx.strokeStyle="rgb(255,255,255)",ctx.stroke(),this.cycle++,this.cycle>this.maxCycles){this.cycle=0,ctx.beginPath();for(let t=0;t<mob.length;t++)mob[t].isShielded||mob[t].shield||!mob[t].isDropPowerUp||!mob[t].alive||mob[t].isBoss||(ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[t].position.x,mob[t].position.y),spawn.shield(mob[t],mob[t].position.x,mob[t].position.y,1,!0),mob[mob.length-1].damageReduction=.0375);!this.isShielded&&this.alive&&spawn.shield(this,this.position.x,this.position.y,1,!0),ctx.lineWidth=20,ctx.strokeStyle="rgb(200,200,255)",ctx.stroke()}}},defendingBoss(t,e,i=200){mobs.spawn(t,e,9,i,"rgba(66, 66, 246, 1)");let s=mob[mob.length-1];s.tier=4,setTimeout(()=>{s.constraint=Constraint.create({pointA:{x:s.position.x,y:s.position.y},bodyB:s,stiffness:1e-4,damping:1}),Composite.add(engine.world,s.constraint)},2e3),Matter.Body.rotate(s,2*Math.random()*Math.PI),s.isBoss=!0,s.cycle=0,s.maxCycles=120,s.frictionStatic=0,s.friction=0,s.frictionAir=1,spawn.shield(s,t,e,1),spawn.spawnOrbitals(s,i+50+200*Math.random(),1),Matter.Body.setDensity(s,.001),s.damageReduction=.3,s.startingDamageReduction=s.damageReduction,s.isInvulnerable=!1,s.nextHealthThreshold=.8,s.invulnerableCount=0,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0;t<mob.length;t++)mob[t].shield&&mob[t].death()},s.pushAway=function(t=.13,e=.05){for(let i=0,s=body.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(body[i].position,this.position))<4e6&&(body[i].force.x+=t*body[i].mass*(body[i].position.x>this.position.x?1:-1),body[i].force.y-=e*body[i].mass);for(let i=0,s=bullet.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(bullet[i].position,this.position))<4e6&&(bullet[i].force.x+=t*bullet[i].mass*(bullet[i].position.x>this.position.x?1:-1),bullet[i].force.y-=e*bullet[i].mass);for(let i=0,s=powerUp.length;i<s;++i)Vector.magnitudeSquared(Vector.sub(powerUp[i].position,this.position))<4e6&&(powerUp[i].force.x+=t*powerUp[i].mass*(powerUp[i].position.x>this.position.x?1:-1),powerUp[i].force.y-=e*powerUp[i].mass);Vector.magnitudeSquared(Vector.sub(player.position,this.position))<4e6&&(player.force.x+=t*player.mass*(player.position.x>this.position.x?1:-1),player.force.y-=e*player.mass)},s.onDamage=function(){this.isInvulnerable||(this.cycle=0),this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(5*this.health)/5,this.invulnerableCount=90,this.isInvulnerable=!0,this.damageReduction=0)},s.do=function(){this.seePlayer.recall&&this.healthBar4(),Matter.Body.rotate(this,.003),this.checkStatus(),ctx.beginPath(),ctx.moveTo(this.vertices[this.vertices.length-1].x,this.vertices[this.vertices.length-1].y);const t=(this.vertices.length+1)*this.cycle/this.maxCycles;t>1&&ctx.lineTo(this.vertices[0].x,this.vertices[0].y);for(let e=1;e<t-1;e++)ctx.lineTo(this.vertices[e].x,this.vertices[e].y);if(ctx.lineWidth=5,ctx.strokeStyle="rgb(255,255,255)",ctx.stroke(),this.cycle++,this.cycle>this.maxCycles){this.cycle=0,ctx.beginPath();for(let t=0;t<mob.length;t++)mob[t].isShielded||mob[t].shield||!mob[t].isDropPowerUp||!mob[t].alive||mob[t].isBoss||(ctx.moveTo(this.position.x,this.position.y),ctx.lineTo(mob[t].position.x,mob[t].position.y),spawn.shield(mob[t],mob[t].position.x,mob[t].position.y,1,!0),mob[mob.length-1].damageReduction=.0375);!this.isShielded&&this.alive&&spawn.shield(this,this.position.x,this.position.y,1,!0),ctx.lineWidth=20,ctx.strokeStyle="rgb(200,200,255)",ctx.stroke()}if(this.isInvulnerable){this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.pushAway(.1,.04)),ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}}},conductorBoss(t,e,i=100){mobs.spawn(t,e,4,i,"rgb(68, 68, 68)");let s=mob[mob.length-1];s.tier=3,s.isBoss=!0,Matter.Body.setDensity(s,.0045),s.damageReduction=.39,s.stroke=color.map,s.fill=color.map,s.cycle=0,s.maxCycles=300-15*simulation.difficultyMode,s.frictionStatic=1,s.friction=1,s.frictionAir=1,s.g=.0032,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.lastMapPLayerOn=null,s.do=function(){if(this.cycle++,this.gravity(),this.seePlayer.recall&&this.healthBar3(),this.checkStatus(),this.isStunned?this.cycle=0:simulation.ephemera.push({opacity:Math.pow(this.cycle/this.maxCycles,3),do(){simulation.removeEphemera(this),ctx.fillStyle=`rgba(255,50,100,${this.opacity})`,ctx.fill(simulation.draw.mapPath)}}),this.cycle>this.maxCycles){this.cycle=0;const t=Matter.Query.collides(player,map);if(Matter.Query.collides(player,map).length&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles;const e=.03*this.damageScale();m.takeDamage(e);const i=t[0].supports[0];simulation.drawList.push({x:i.x,y:i.y,radius:200*Math.sqrt(e),color:simulation.mobDmgColor,time:simulation.drawTime})}}}},timeSkipBoss(t,e,i=50){mobs.spawn(t,e,15,i,"transparent");let s=mob[mob.length-1];s.tier=3,s.isBoss=!0,s.eventHorizon=0,s.frictionStatic=0,s.friction=0,s.frictionAir=.005,s.accelMag=8e-5+2e-5*simulation.accelScale,spawn.shield(s,t,e,1),spawn.spawnOrbitals(s,i+50+100*Math.random()),Matter.Body.setDensity(s,.0025),s.damageReduction=.07,s.startingDamageReduction=s.damageReduction,s.isInvulnerable=!1,s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.onDamage=function(){},s.do=function(){this.seePlayerByHistory(60),this.attraction(),this.distanceToPlayer2()>9e6&&this.attraction(),this.checkStatus(),this.eventHorizon=950+250*Math.sin(.005*simulation.cycle),simulation.isTimeSkipping||(Vector.magnitude(Vector.sub(this.position,m.pos))<this.eventHorizon?(this.seePlayer.recall&&this.healthBar3(),this.attraction(),this.damageReduction=this.startingDamageReduction,this.isInvulnerable=!1,requestAnimationFrame(()=>{simulation.timePlayerSkip(1)}),m.walk_cycle+=m.flipLegs*m.Vx,ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.eventHorizon,0,2*Math.PI),ctx.fillStyle="#fff",ctx.globalCompositeOperation="destination-in",ctx.fill(),ctx.globalCompositeOperation="source-over",ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.eventHorizon,0,2*Math.PI),ctx.clip()):(this.damageReduction=0,this.isInvulnerable=!0,requestAnimationFrame(()=>{simulation.camera(),ctx.beginPath(),ctx.arc(this.position.x,this.position.y,this.eventHorizon,0,2*Math.PI,!1),ctx.fillStyle=document.body.style.backgroundColor,ctx.fill(),ctx.restore()})))}},streamBoss(t,e,i=110){mobs.spawn(t,e,5,i,"rgb(245,180,255)");let s=mob[mob.length-1];s.tier=1,s.isBoss=!0,s.accelMag=1e-4,s.canFire=!1,s.closestVertex1=0,s.closestVertex2=1,s.cycle=0,s.frictionStatic=0,s.friction=0,s.frictionAir=.022,s.memory=240,s.repulsionRange=12e5,spawn.shield(s,t,e,1),spawn.spawnOrbitals(s,i+50+200*Math.random()),Matter.Body.setDensity(s,.01),s.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},s.onDamage=function(){},s.damageReduction=.28,s.do=function(){if(this.seePlayer.recall&&this.healthBar1(),this.seePlayerCheck(),this.checkStatus(),this.attraction(),this.repulsion(),this.cycle++,this.seePlayer.recall&&this.cycle%15==0)if(this.canFire){this.cycle>100&&(this.cycle=0,this.canFire=!1),spawn.seeker(this.vertices[this.closestVertex1].x,this.vertices[this.closestVertex1].y,this.tier,6),Matter.Body.setDensity(mob[mob.length-1],1e-6);const t=Vector.mult(Vector.normalise(Vector.sub(this.position,this.vertices[this.closestVertex1])),-10);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+t.x,y:this.velocity.y+t.y}),spawn.seeker(this.vertices[this.closestVertex2].x,this.vertices[this.closestVertex2].y,this.tier,6),Matter.Body.setDensity(mob[mob.length-1],1e-6);const e=Vector.mult(Vector.normalise(Vector.sub(this.position,this.vertices[this.closestVertex2])),-10);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+e.x,y:this.velocity.y+e.y})}else if(this.cycle>270){this.cycle=0,this.canFire=!0;let t=1/0;for(let e=0;e<this.vertices.length;e++){const i=Vector.magnitudeSquared(Vector.sub(this.vertices[e],player.position));i<t&&(t=i,this.closestVertex2=this.closestVertex1,this.closestVertex1=e)}this.closestVertex2===this.closestVertex1&&(this.closestVertex2++,this.closestVertex2===this.vertices.length&&(this.closestVertex2=0))}}},seeker(t,e,i=1,s=8,o=6){mobs.spawn(t,e,o,s,"rgba(255,0,255,1)");let a=mob[mob.length-1];a.tier=i,a.stroke="transparent",a.onHit=function(){this.explode(20*this.mass)},Matter.Body.setDensity(a,15e-6),a.timeLeft=420,a.accelMag=17e-5*simulation.accelScale,a.frictionAir=.01,a.restitution=.5,a.leaveBody=!1,a.isDropPowerUp=!1,a.isBadTarget=!0,a.isMobBullet=!0,a.collisionFilter.category=cat.mobBullet,a.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet,a.do=function(){this.timeLeft<90&&(this.fill=`rgba(255,0,255,${.3+.7*Math.min(90,this.timeLeft)/90})`),this.alwaysSeePlayer(),this.attraction(),this.timeLimit()}},spawner(t,e,i=55+Math.ceil(50*Math.random())){mobs.spawn(t,e,4,i,"rgb(255,150,0)");let s=mob[mob.length-1];s.tier=2,s.g=4e-4,s.leaveBody=!1,s.onDeath=function(){for(let t=0;t<Math.ceil(.15*this.mass+2.5*Math.random());++t)spawn.spawns(this.position.x+(Math.random()-.5)*i*2.5,this.position.y+(Math.random()-.5)*i*2.5,this.tier),Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+15*(Math.random()-.5),y:this.velocity.x+15*(Math.random()-.5)})},spawn.shield(s,t,e),s.do=function(){this.seePlayer.recall&&this.healthBar2(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.attraction()}},spawns(t,e,i=2,s=15){mobs.spawn(t,e,4,s,"rgb(255,0,0)");let o=mob[mob.length-1];o.onHit=function(){this.explode()},o.collisionFilter.mask=cat.player|cat.bullet|cat.body|cat.map|cat.mob,Matter.Body.setDensity(o,1e-4),o.g=2e-5,o.accelMag=12e-5*simulation.accelScale,o.isDropPowerUp=!1,o.leaveBody=!1,o.seePlayerFreq=Math.floor(80+50*Math.random()),o.frictionAir=.004,o.do=function(){this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.attraction()}},exploder(t,e,i=40+Math.ceil(50*Math.random())){mobs.spawn(t,e,4,i,"rgb(255,0,0)");let s=mob[mob.length-1];s.tier=1,Matter.Body.setDensity(s,.0013),s.onHit=function(){this.explode(2.5*this.mass)},s.g=4e-4,s.do=function(){this.seePlayer.recall&&this.healthBar1(),ctx.beginPath();const t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;++e)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.strokeStyle=`rgba(255,0,50,${.13+.45*Math.random()})`,ctx.lineWidth=30,ctx.stroke(),ctx.strokeStyle="rgba(255,0,50,0.1)",ctx.lineWidth=70,ctx.stroke(),this.gravity(),this.seePlayerCheck(),this.checkStatus(),this.attraction()}},snakeSpitBoss(t,e,i=50){let s=Math.PI;const o=300,a="rgb(235,180,255)";mobs.spawn(t+o*Math.cos(s),e+o*Math.sin(s),8,i,a);let n=mob[mob.length-1];n.tier=3,n.isBoss=!0,n.accelMag=1e-4+4e-4*Math.sqrt(simulation.accelScale),n.memory=250,n.laserRange=500,Matter.Body.setDensity(n,.0022+22e-5*Math.sqrt(simulation.difficulty)),n.startingDamageReduction=.14,n.damageReduction=0,n.isInvulnerable=!0,n.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y),n.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0,e=mob.length;t<e;t++)this.id===mob[t].snakeHeadID&&mob[t].alive&&mob[t].death()}},n.canFire=!1,n.closestVertex1=0,n.cycle=0,n.do=function(){if(this.seePlayer.recall&&this.healthBar3(),this.seePlayerByHistory(40),this.checkStatus(),this.attraction(),this.cycle++,this.seePlayer.recall&&this.cycle%10==0)if(this.canFire){this.cycle>150&&(this.cycle=0,this.canFire=!1),spawn.seeker(this.vertices[this.closestVertex1].x,this.vertices[this.closestVertex1].y,this.tier,6),Matter.Body.setDensity(mob[mob.length-1],1e-6);const t=Vector.mult(Vector.normalise(Vector.sub(this.vertices[this.closestVertex1],this.position)),20);Matter.Body.setVelocity(mob[mob.length-1],{x:this.velocity.x+t.x,y:this.velocity.y+t.y})}else if(this.cycle>150){this.cycle=0,this.canFire=!0;let t=1/0;for(let e=0;e<this.vertices.length;e++){const i=Vector.magnitudeSquared(Vector.sub(this.vertices[e],player.position));i<t&&(t=i,this.closestVertex1=e)}}if(this.isInvulnerable){ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=20,ctx.strokeStyle="rgba(255,255,255,0.7)",ctx.stroke()}},s-=.07;let r=0;const l=Math.min(10+Math.ceil(.6*simulation.difficulty),60);for(let i=0;i<l;++i)s-=.1,spawn.snakeBody(t+o*Math.cos(s),e+o*Math.sin(s),this.tier,0===i?25:20),i<4&&(mob[mob.length-1].snakeHeadID=n.id),mob[mob.length-1].previousTailID=r,r=mob[mob.length-1].id;this.constrain2AdjacentMobs(l,1,!1,1);for(let t=mob.length-1,e=t-l;t>e;t--)mob[t].fill=t%2?"#778":a;consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-l],bodyB:mob[mob.length-1-l],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-l+1],bodyB:mob[mob.length-1-l],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-l+2],bodyB:mob[mob.length-1-l],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1])},dragonFlyBoss(t,e,i=42){let s=Math.PI;const o=300;mobs.spawn(t+o*Math.cos(s),e+o*Math.sin(s),8,i,"#000");let a=mob[mob.length-1];a.tier=1,a.isBoss=!0,Matter.Body.setDensity(a,.00165+11e-5*Math.sqrt(simulation.difficulty)),a.startingDamageReduction=.1,a.damageReduction=0,a.isInvulnerable=!0,a.accelMag=8e-5+45e-5*Math.sqrt(simulation.accelScale),a.memory=250,a.seePlayerFreq=13,a.flapRate=.4,a.flapArc=.2,a.wingLength=150,a.ellipticity=.3,a.angleOff=.4,a.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y);for(let t=0,e=mob.length;t<e;t++)this.id===mob[t].snakeHeadID&&mob[t].alive&&mob[t].death()},a.do=function(){let t;if(this.seePlayer.recall&&this.healthBar1(),this.seePlayerByHistory(40),this.checkStatus(),this.attraction(),this.isInvulnerable){ctx.beginPath();let e=this.vertices;ctx.moveTo(e[0].x,e[0].y);for(let t=1;t<e.length;t++)ctx.lineTo(e[t].x,e[t].y);ctx.lineTo(e[0].x,e[0].y),ctx.lineWidth=12,ctx.strokeStyle="rgba(255,255,255,0.9)",ctx.stroke();const i=Vector.sub(this.position,this.snakeBody1.position);t=Math.atan2(i.y,i.x)}else t=Math.atan2(this.velocity.y,this.velocity.x);ctx.fillStyle=`hsla(${160+40*Math.random()}, 100%, ${25+25*Math.random()*Math.random()}%, 0.9)`,this.wing(t+Math.PI/2+this.angleOff+this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity),this.wing(t-Math.PI/2-this.angleOff-this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity),this.wing(t-Math.PI/2+this.angleOff+this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity),this.wing(t+Math.PI/2-this.angleOff-this.flapArc*Math.sin(simulation.cycle*this.flapRate),this.wingLength,this.ellipticity)},s-=.07;let n=0;const r=Math.min(10+Math.ceil(.6*simulation.difficulty),60);for(let i=0;i<r;++i){s-=.1,spawn.snakeBody(t+o*Math.cos(s),e+o*Math.sin(s),this.tier,0===i?25:20);const r=mob[mob.length-1];r.fill=`hsl(${160+40*Math.random()}, 100%, ${5+25*Math.random()*Math.random()}%)`,i<4&&(r.snakeHeadID=a.id),0===i&&(a.snakeBody1=r),r.previousTailID=n,n=r.id}this.constrain2AdjacentMobs(r,1,!1,1),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-r],bodyB:mob[mob.length-1-r],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-r+1],bodyB:mob[mob.length-1-r],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-r+2],bodyB:mob[mob.length-1-r],stiffness:1,damping:1}),Composite.add(engine.world,consBB[consBB.length-1])},snakeBody(t,e,i,s=10){mobs.spawn(t,e,8,s,"rgba(0,180,180,0.4)");let o=mob[mob.length-1];o.tier=i,o.collisionFilter.mask=cat.bullet|cat.player|cat.body,o.damageReduction=.031,Matter.Body.setDensity(o,1e-4),o.leaveBody=Math.random()<.33,o.isDropPowerUp=!1,o.frictionAir=0,o.isSnakeTail=!0,o.stroke="transparent",o.onDeath=function(){setTimeout(()=>{for(let t=0,e=mob.length;t<e;t++)this.id===mob[t].previousTailID&&mob[t].alive&&mob[t].death(),this.snakeHeadID===mob[t].id?(mob[t].isInvulnerable=!1,mob[t].damageReduction=mob[t].startingDamageReduction):mob[t].isSnakeTail&&(mob[t].health*=.95)},500)},o.do=function(){this.checkStatus()}},tetherBoss(t,e,i,s=90){mobs.spawn(t,e,8,s,"rgb(0,60,80)");let o=mob[mob.length-1];o.isBoss=!0,Matter.Body.setDensity(o,6e-4+1e-4*Math.sqrt(simulation.difficulty)),o.damageReduction=.27,o.startingDamageReduction=o.damageReduction,o.isInvulnerable=!1,o.nextHealthThreshold=.75,o.invulnerableCount=0,o.g=1e-4,o.accelMag=.0012+.0013*simulation.accelScale,o.memory=20,o.repulsionRange=324e4,cons[cons.length]=Constraint.create({pointA:{x:i.x,y:i.y},bodyB:o,stiffness:12e-5}),Composite.add(engine.world,cons[cons.length-1]),spawn.shield(o,t,e,1),setTimeout(()=>{spawn.spawnOrbitals(o,s+50+200*Math.random())},100),o.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y),this.removeCons(),o.babies(.05*simulation.difficulty+1)},o.babies=function(t){const e=Math.max(3,Math.floor(15-t/2));let i=0,o=()=>{if(i<t){if(!(simulation.cycle%e)&&!simulation.paused&&!simulation.isChoosing&&m.alive){const t=Vector.normalise(Vector.sub(player.position,this.position)),e=Vector.mult(t,10+10*Math.random()),o=Vector.add(this.position,Vector.mult(t,1.2*s));spawn.allowShields=!1,spawn.flutter(o.x,o.y,Math.floor(9+8*Math.random()));const a=mob[mob.length-1];Matter.Body.setDensity(a,.01),Matter.Body.setVelocity(a,e),Matter.Body.setAngle(a,Math.atan2(e.y,e.x)),this.alertNearByMobs(),spawn.allowShields=!0,i++}requestAnimationFrame(o)}};requestAnimationFrame(o)},o.onDamage=function(){this.health<this.nextHealthThreshold&&this.alive&&(this.health=this.nextHealthThreshold-.01,this.nextHealthThreshold=Math.floor(4*this.health)/4,this.invulnerableCount=60+Math.floor(30*Math.random())+10*simulation.difficultyMode,this.isInvulnerable=!0,this.damageReduction=0)},o.do=function(){if(this.gravity(),this.isInvulnerable){if(this.repulsion(),this.invulnerableCount--,this.invulnerableCount<0&&(this.isInvulnerable=!1,this.damageReduction=this.startingDamageReduction,this.frictionAir=.05,o.babies(.07*simulation.difficulty+2),this.radius>15)){const t=.88;Matter.Body.scale(this,t,t),this.radius*=t}ctx.beginPath();let t=this.vertices;ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)ctx.lineTo(t[e].x,t[e].y);ctx.lineTo(t[0].x,t[0].y),ctx.lineWidth=13+5*Math.random(),ctx.strokeStyle=`rgba(255,255,255,${.5+.2*Math.random()})`,ctx.stroke()}else this.seePlayerCheck(),this.checkStatus(),this.attraction()}},shield(t,e,i,s=(level.isMobShields?4:1)*Math.min(.02+.005*simulation.difficulty,.2)){if(this.allowShields&&Math.random()<s){mobs.spawn(e,i,9,t.radius+30,"rgba(220,220,255,0.9)");let s=mob[mob.length-1];s.stroke="rgb(220,220,255)",Matter.Body.setDensity(s,1e-5),s.shield=!0,s.damageReduction=.073,s.isUnblockable=!0,s.collisionFilter.category=cat.mobShield,s.collisionFilter.mask=cat.bullet,consBB[consBB.length]=Constraint.create({bodyA:s,bodyB:t,stiffness:.4,damping:.1}),Composite.add(engine.world,consBB[consBB.length-1]),s.onDamage=function(){this.alertNearByMobs(),this.fill=`rgba(220,220,255,${.3+.6*this.health})`},s.leaveBody=!1,s.isDropPowerUp=!1,s.shieldTargetID=t.id,t.isShielded=!0,t.shieldCount>0?t.shieldCount++:t.shieldCount=1,s.shieldCount=t.shieldCount,t.shieldID=s.id,s.onDeath=function(){for(let t=0,e=mob.length;t<e;t++)mob[t].id===this.shieldTargetID&&(mob[t].isShielded=!1)},s.do=function(){this.checkStatus()},mob.unshift(s)}},groupShield(t,e,i,s,o=.4){const a=t.length;mobs.spawn(e,i,9,s,"rgba(220,220,255,0.9)");let n=mob[mob.length-1];n.stroke="rgb(220,220,255)",Matter.Body.setDensity(n,1e-5),n.frictionAir=0,n.shield=!0,n.damageReduction=.075,n.collisionFilter.category=cat.mobShield,n.collisionFilter.mask=cat.bullet;for(let t=0;t<a;++t)mob[mob.length-t-2].isShielded=!0,consBB[consBB.length]=Constraint.create({bodyA:n,bodyB:mob[mob.length-t-2],stiffness:o,damping:.1}),Composite.add(engine.world,consBB[consBB.length-1]);n.onDamage=function(){this.alertNearByMobs(),this.fill=`rgba(220,220,255,${.3+.6*this.health})`},n.onDeath=function(){for(let e=0;e<t.length;e++)for(let i=0,s=mob.length;i<s;i++)mob[i].id===t[e]&&(mob[i].isShielded=!1)},n.leaveBody=!1,n.isDropPowerUp=!1,mob[mob.length-1]=mob[mob.length-1-a],mob[mob.length-1-a]=n,n.do=function(){this.checkStatus()}},spawnOrbitals(t,e,i=Math.min(.25+.005*simulation.difficulty)){if(Math.random()<i){const i=Math.floor(Math.min(15,3+Math.sqrt(simulation.difficulty))),s=(.003+.004*Math.random()+.002*Math.sqrt(simulation.difficulty))*(Math.random()<.5?1:-1),o=6.28*Math.random();for(let a=0;a<i;a++)spawn.orbital(t,e,a/i*2*Math.PI+o,s)}},orbital(t,e,i,s){mobs.spawn(t.position.x,t.position.y,8,12,"rgb(255,0,150)");let o=mob[mob.length-1];o.stroke="transparent",Matter.Body.setDensity(o,.01),o.leaveBody=!1,o.isDropPowerUp=!1,o.isBadTarget=!0,o.isUnstable=!0,o.isOrbital=!0,o.collisionFilter.category=cat.mobBullet,o.collisionFilter.mask=cat.bullet,o.do=function(){if(!t||!t.alive)return void this.death();const o=simulation.cycle*s+i,a={x:Math.cos(o),y:Math.sin(o)};if(Matter.Body.setPosition(this,Vector.add(Vector.add(t.position,t.velocity),Vector.mult(a,e))),Matter.Query.collides(this,[player]).length>0&&(!m.isCloak||!tech.isIntangible)&&m.immuneCycle<m.cycle){m.immuneCycle=m.cycle+m.collisionImmuneCycles;const t=.03*this.damageScale();m.takeDamage(t),simulation.drawList.push({x:this.position.x,y:this.position.y,radius:200*Math.sqrt(t),color:simulation.mobDmgColor,time:simulation.drawTime}),this.death()}}},orbitalBoss(t,e,i=70){const s=Math.random(),o=Math.min(15,Math.floor(2+4*s+.75*Math.sqrt(simulation.difficulty)));mobs.spawn(t,e,o,i,"rgb(255,0,150)");let a=mob[mob.length-1];a.tier=1,a.isBoss=!0,Matter.Body.setDensity(a,.0018+15e-5*Math.sqrt(simulation.difficulty)),a.damageReduction=.11,a.stroke="transparent",a.seeAtDistance2=2e6,a.collisionFilter.mask=cat.bullet|cat.player|cat.body|cat.map,a.memory=1/0,a.frictionAir=.04,a.accelMag=2e-4+15e-5*simulation.accelScale,spawn.shield(a,t,e,1);const n=Math.random();let r=(.006+.001*Math.sqrt(simulation.difficulty))*(Math.random()<.5?1:-1),l=i+350+200*n+7*o;for(let t=0;t<o;t++)spawn.orbital(a,l,t/o*2*Math.PI,r);const h=[];for(let t=0;t<o;t++)h.push(mob.length-1-t);l=Math.max(60,100+100*Math.random()-3*o-80*n),r*=1.25+2*Math.random();const c=Math.max(2,Math.floor(6-5*s+.5*Math.sqrt(simulation.difficulty)));for(let t=0;t<o;t++)for(let e=0,i=c;e<i;e++)spawn.orbital(mob[h[t]],l,e/i*2*Math.PI,r);for(let t=0,e=3+.5*Math.sqrt(simulation.difficulty);t<e;t++)spawn.spawnOrbitals(a,i+40+10*t,1);a.onDeath=function(){powerUps.spawnBossPowerUp(this.position.x,this.position.y)},a.do=function(){this.seePlayer.recall&&this.healthBar1(),this.seePlayerByHistory(),this.checkStatus(),this.attraction()}},allowShields:!0,nodeGroup(t,e,i="striker",s=Math.min(2+Math.ceil(Math.random()*(simulation.difficulty+2)),8),o=Math.ceil(10*Math.random())+18,a=Math.ceil(100*Math.random())+70,n=.03*Math.random()+.005){this.allowShields=!1;const r=2*Math.PI/s;let l=[];for(let n=0;n<s;++n){let s=i;"random"===i?s=this.fullPickList[Math.floor(Math.random()*this.fullPickList.length)]:"randomList"===i&&(s=this.pickList[Math.floor(Math.random()*this.pickList.length)]),this[s](t+a*Math.sin(n*r),e+a*Math.cos(n*r),o),l.push(mob[mob.length-1].id)}Math.random()<.3?this.constrain2AdjacentMobs(s,2*n,!0):this.constrainAllMobCombos(s,n),s>2&&Math.random()<.998&&this.groupShield(l,t,e,a+2.5*o+6*s-25),this.allowShields=!0},lineGroup(t,e,i="striker",s=Math.min(3+Math.ceil(Math.random()*simulation.difficulty+2),8),o=Math.ceil(10*Math.random())+17,a=Math.ceil(80*Math.random())+30,n=.06*Math.random()+.01){this.allowShields=!1;for(let n=0;n<s;++n){let s=i;"random"===i?s=this.fullPickList[Math.floor(Math.random()*this.fullPickList.length)]:"randomList"===i&&(s=this.pickList[Math.floor(Math.random()*this.pickList.length)]),this[s](t+n*o+n*a,e,o)}this.constrain2AdjacentMobs(s,n),this.allowShields=!0},constrainAllMobCombos(t,e){for(let i=1;i<t+1;++i)for(let s=i+1;s<t+1;++s)consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-i],bodyB:mob[mob.length-s],stiffness:e}),Composite.add(engine.world,consBB[consBB.length-1])},constrain2AdjacentMobs(t,e,i=!1,s=0){for(let i=0;i<t-1;++i)consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-i-1],bodyB:mob[mob.length-i-2],stiffness:e,damping:s}),Composite.add(engine.world,consBB[consBB.length-1]);if(t>2)for(let i=0;i<t-2;++i)consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-i-1],bodyB:mob[mob.length-i-3],stiffness:e,damping:s}),Composite.add(engine.world,consBB[consBB.length-1]);i&&t>3&&(consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-1],bodyB:mob[mob.length-t],stiffness:e,damping:s}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-2],bodyB:mob[mob.length-t],stiffness:e,damping:s}),Composite.add(engine.world,consBB[consBB.length-1]),consBB[consBB.length]=Constraint.create({bodyA:mob[mob.length-1],bodyB:mob[mob.length-t+1],stiffness:e,damping:s}),Composite.add(engine.world,consBB[consBB.length-1]))},constraintPB(t,e,i,s){cons[cons.length]=Constraint.create({pointA:{x:t,y:e},bodyB:body[i],stiffness:s}),Composite.add(engine.world,cons[cons.length-1])},constraintBB(t,e,i){consBB[consBB.length]=Constraint.create({bodyA:body[t],bodyB:body[e],stiffness:i}),Composite.add(engine.world,consBB[consBB.length-1])},wireHead(){const t=1300;mobs.spawn(t,-100,0,7.5,"transparent");let e=mob[mob.length-1];e.collisionFilter.category=cat.body,e.collisionFilter.mask=cat.map,e.inertia=1/0,e.g=4e-4,e.restitution=0,e.stroke="transparent",e.freeOfWires=!1,e.frictionStatic=1,e.friction=1,e.frictionAir=.01,e.isDropPowerUp=!1,e.isBadTarget=!0,e.isUnblockable=!0,e.do=function(){if(this.freeOfWires)this.gravity();else{if(m.pos.x>t||simulation.isCheating){this.freeOfWires=!0,this.fill="#000",this.force.x+=-.003,player.force.x+=.06;for(let t=0;t<powerUp.length;++t)"difficulty"===powerUp[t].name&&(Matter.Composite.remove(engine.world,powerUp[t]),powerUp.splice(t,1))}if(Matter.Body.setVelocity(player,{x:player.velocity.x,y:player.velocity.y+.3}),m.pos.x>700&&player.velocity.x>-2){let e=.75*Math.min(.6,Math.max(0,100/(t-m.pos.x)));m.onGround||(e*=3),Matter.Body.setVelocity(player,{x:player.velocity.x-e,y:player.velocity.y})}Matter.Body.setPosition(this,{x:m.pos.x+42*Math.cos(m.angle+Math.PI),y:m.pos.y+42*Math.sin(m.angle+Math.PI)})}ctx.beginPath(),ctx.moveTo(-50,-1e3),ctx.quadraticCurveTo(-50,0,this.position.x,this.position.y),this.freeOfWires||ctx.lineTo(m.pos.x+30*Math.cos(m.angle+Math.PI),m.pos.y+30*Math.sin(m.angle+Math.PI)),ctx.lineCap="butt",ctx.lineWidth=15,ctx.strokeStyle="#000",ctx.stroke(),ctx.lineCap="round"}},wireKnee(){mobs.spawn(1425,-100,0,2,"transparent");let t=mob[mob.length-1];t.collisionFilter.category=cat.body,t.collisionFilter.mask=cat.map,t.g=3e-4,t.stroke="transparent",t.restitution=0,t.freeOfWires=!1,t.frictionStatic=1,t.friction=1,t.frictionAir=.01,t.isDropPowerUp=!1,t.isBadTarget=!0,t.isUnblockable=!0,t.do=function(){this.freeOfWires?this.gravity():((m.pos.x>1425||simulation.isCheating)&&(this.freeOfWires=!0,this.force.x-=4e-4,this.fill="#222"),m.calcLeg(0,0),Matter.Body.setPosition(this,{x:m.pos.x+m.flipLegs*m.knee.x-5,y:m.pos.y+m.knee.y})),ctx.beginPath(),ctx.moveTo(-70,-1e3),ctx.quadraticCurveTo(-70,0,this.position.x,this.position.y),ctx.lineWidth=5,ctx.strokeStyle="#222",ctx.lineCap="butt",ctx.stroke(),ctx.lineCap="round"}},wireKneeLeft(){mobs.spawn(1400,-100,0,2,"transparent");let t=mob[mob.length-1];t.collisionFilter.category=cat.body,t.collisionFilter.mask=cat.map,t.g=3e-4,t.stroke="transparent",t.restitution=0,t.freeOfWires=!1,t.frictionStatic=1,t.friction=1,t.frictionAir=.01,t.isDropPowerUp=!1,t.isBadTarget=!0,t.isUnblockable=!0,t.do=function(){this.freeOfWires?this.gravity():((m.pos.x>1400||simulation.isCheating)&&(this.freeOfWires=!0,this.force.x+=-3e-4,this.fill="#333"),m.calcLeg(Math.PI,-3),Matter.Body.setPosition(this,{x:m.pos.x+m.flipLegs*m.knee.x-5,y:m.pos.y+m.knee.y})),ctx.beginPath(),ctx.moveTo(-85,-1e3),ctx.quadraticCurveTo(-85,0,this.position.x,this.position.y),ctx.lineWidth=5,ctx.lineCap="butt",ctx.strokeStyle="#333",ctx.stroke(),ctx.lineCap="round"}},wireFoot(){mobs.spawn(1350,-100,0,2,"transparent");let t=mob[mob.length-1];t.collisionFilter.category=cat.body,t.collisionFilter.mask=cat.map,t.g=3e-4,t.restitution=0,t.stroke="transparent",t.freeOfWires=!1,t.frictionAir=.01,t.isDropPowerUp=!1,t.isBadTarget=!0,t.isUnblockable=!0,t.do=function(){this.freeOfWires?this.gravity():((m.pos.x>1350||simulation.isCheating)&&(this.freeOfWires=!0,this.force.x+=-6e-4,this.fill="#111"),m.calcLeg(0,0),Matter.Body.setPosition(this,{x:m.pos.x+m.flipLegs*m.foot.x-5,y:m.pos.y+m.foot.y-1})),ctx.beginPath(),ctx.moveTo(-34,-1e3),ctx.quadraticCurveTo(-34,0,this.position.x,this.position.y),ctx.lineWidth=5,ctx.lineCap="butt",ctx.strokeStyle="#111",ctx.stroke(),ctx.lineCap="round"}},wireFootLeft(){mobs.spawn(1325,-100,0,2,"transparent");let t=mob[mob.length-1];t.collisionFilter.category=cat.body,t.collisionFilter.mask=cat.map,t.g=3e-4,t.restitution=0,t.stroke="transparent",t.freeOfWires=!1,t.frictionAir=.01,t.isDropPowerUp=!1,t.isBadTarget=!0,t.isUnblockable=!0,t.do=function(){this.freeOfWires?this.gravity():((m.pos.x>1325||simulation.isCheating)&&(this.freeOfWires=!0,this.force.x+=-5e-4,this.fill="#222"),m.calcLeg(Math.PI,-3),Matter.Body.setPosition(this,{x:m.pos.x+m.flipLegs*m.foot.x-5,y:m.pos.y+m.foot.y-1})),ctx.beginPath(),ctx.moveTo(-24,-1e3),ctx.quadraticCurveTo(-24,0,this.position.x,this.position.y),ctx.lineWidth=5,ctx.strokeStyle="#222",ctx.lineCap="butt",ctx.stroke(),ctx.lineCap="round"}},boost(t,e,i=1e3){spawn.mapVertex(t+50,e+35,"120 40 -120 40 -50 -40 50 -40"),level.addQueryRegion(t,e-20,100,20,"boost",[[player],body,mob,powerUp,bullet],-1.21*Math.sqrt(Math.abs(i)))},blockDoor(t,e,i=60){spawn.mapRect(t,e-290,40,60),spawn.mapRect(t,e,40,50);for(let s=0;s<4;++s)spawn.bodyRect(t+5,e-260+s*i+3*s,30,i)},debris(t,e,i,s=Math.floor(2+9*Math.random())){for(let o=0;o<s;++o)if(Math.random()<.15)powerUps.chooseRandomPowerUp(t+Math.random()*i,e);else{const s=18+25*Math.random();spawn.bodyRect(t+Math.random()*i,e,s*(.6+Math.random()),s*(.6+Math.random()),1)}},bodyRect(t,e,i,s,o=1,a={friction:.05,frictionAir:.001}){if(Math.random()<o){body[body.length]=Bodies.rectangle(t+i/2,e+s/2,i,s,a);const o=body[body.length-1];o.collisionFilter.category=cat.body,o.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,Composite.add(engine.world,o),o.classType="body"}},bodyVertex(t,e,i,s){body[body.length]=Matter.Bodies.fromVertices(t,e,Vertices.fromPath(i),s);const o=body[body.length-1];o.collisionFilter.category=cat.body,o.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.mob|cat.mobBullet,Composite.add(engine.world,o),o.classType="body"},mapRect(t,e,i,s,o){map[map.length]=Bodies.rectangle(t+i/2,e+s/2,i,s,o)},mapVertex(t,e,i,s){map[map.length]=Matter.Bodies.fromVertices(t,e,Vertices.fromPath(i),s)},bodyRectCorner(t,e,i=800,s=400,o=25,a){const n=`${i*=.5} -${(s*=.5)-o}  ${i} ${s-o}  ${i-o} ${s}  -${i-o} ${s}  -${i} ${s-o}  -${i} -${s-o}  -${i-o} -${s}  ${i-o} -${s}`;map[map.length]=Matter.Bodies.fromVertices(t,e,Vertices.fromPath(n),a)},mapRectNow(t,e,i,s,o,a=!0){map[map.length]=Bodies.rectangle(t+i/2,e+s/2,i,s,o);const n=map[map.length-1];n.collisionFilter.category=cat.map,n.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.powerUp|cat.mob|cat.mobBullet,Matter.Body.setStatic(n,!0),Composite.add(engine.world,n),a&&simulation.draw.setPaths()},mapVertexNow(t,e,i,s,o=!0){map[map.length]=Matter.Bodies.fromVertices(t,e,Vertices.fromPath(i),s);const a=map[map.length-1];a.collisionFilter.category=cat.map,a.collisionFilter.mask=cat.player|cat.map|cat.body|cat.bullet|cat.powerUp|cat.mob|cat.mobBullet,Matter.Body.setStatic(a,!0),Composite.add(engine.world,a),o&&simulation.draw.setPaths()},spawnBuilding(t,e,i,s,o,a,n){this.mapRect(t,e,i,25),this.mapRect(t,e+s,i,35),"left"===n?this.mapRect(t,e,25,s):(this.mapRect(t,e,25,s-150),o&&this.bodyRect(t+5,e+s-150,15,150,this.propsFriction)),"right"===n?this.mapRect(t-25+i,e,25,s):(this.mapRect(t-25+i,e,25,s-150),a&&this.bodyRect(t+i-20,e+s-150,15,150,this.propsFriction))},spawnStairs(t,e,i,s,o,a){if(s+=50,a)for(let a=0;a<i;a++)this.mapRect(t-s/i*(1+a),e-o+a*o/i,s/i+50,o-a*o/i+50);else for(let a=0;a<i;a++)this.mapRect(t+a*s/i,e-o+a*o/i,s/i+50,o-a*o/i+50)},propsFriction:{friction:.5,frictionAir:.02,frictionStatic:1},propsFrictionMedium:{friction:.15,frictionStatic:1},propsBouncy:{friction:0,frictionAir:0,frictionStatic:0,restitution:1},propsSlide:{friction:.003,frictionStatic:.4,restitution:0,density:.002},propsLight:{density:.001},propsOverBouncy:{friction:0,frictionAir:0,frictionStatic:0,restitution:1.05},propsHeavy:{density:.01},propsIsNotHoldable:{isNotHoldable:!0},propsNoRotation:{inertia:1/0},propsHoist:{inertia:1/0,frictionAir:.001,friction:1e-4,frictionStatic:0,restitution:0,isNotHoldable:!0},propsDoor:{density:.001,friction:0,frictionAir:.03,frictionStatic:0,restitution:0},sandPaper:{friction:1,frictionStatic:1,restitution:0}};